_assets={fonts:{visitorBlack:{file:"visitor_black",fw:16,fh:16},visitor:{file:"visitor_gradient",fw:16,fh:16},visitorLarge:{file:"visitor_gradient_large",fw:24,fh:24},visitorRed:{file:"visitor_red",fw:16,fh:16},visitorLevel:{file:"visitor_level",fw:8,fh:8},miniset2:{file:"miniset2",fw:8,fh:9},semplice:{file:"semplice",fw:6,fh:12}},sprites:{cursor:{file:"cursor_anim",fw:32,fh:32},tile_wall:{file:"tile_wall"},gamelogo:{file:"title6"},anniversary:{file:"Treasure-Arena-10th-Anniversary-Logo"},anniversary2:{file:"title7"},skyline:{file:"skyline"},accuracy:{file:"accuracy"},block:{file:"block"},shadow:{file:"shadow"},grass:{file:"grass"},levelup:{file:"levelup"},pointer_war:{file:"pointer_war",fw:64,fh:64},pointer_rog:{file:"pointer_rog",fw:64,fh:64},pointer_mag:{file:"pointer_mag",fw:64,fh:64},pointer_treasure:{file:"pointer_treasure",fw:64,fh:64},smoketrail:{file:"smoketrail",fw:16,fh:16},fire:{file:"fire",fw:16,fh:16},trap:{file:"trap",fw:32,fh:32},bubble:{file:"bubble"},aggro:{file:"aggro2",fw:32,fh:32},skills:{file:"skills",fw:32,fh:32,skill:{armor:{sx:0,sy:0},invis:{sx:1,sy:0},trap:{sx:2,sy:0}}},armor:{file:"armor"},frame:{file:"frame_169"},frame2:{file:"frame2_169"},light:{file:"light"},light_small:{file:"light_small_soft"},light_npc:{file:"light_npc"},light_player:{file:"light_player"},light_torch:{file:"light_torch_o"},coin:{file:"coin"},ui:{file:"ui"},super_bar:{file:"super_bar",fw:126,fh:4},buffs:{file:"buffs",fw:32,fh:32},hp_bar:{file:"hp_bar",fw:128,fh:20},latency:{file:"latency",fw:20,fh:14},item_back:{file:"item_back",fw:80,fh:64},item_coin:{file:"item_coin",fw:32,fh:32},items:{file:"items",fw:32,fh:32,item:{potion:{sx:0,sy:0,light:!0},arrows:{sx:1,sy:0,light:!0},rockets:{sx:2,sy:0,light:!0},grenades:{sx:3,sy:0,light:!0},shells:{sx:4,sy:0,light:!0},bullets:{sx:5,sy:0,light:!0},light:{sx:6,sy:0,light:!0},coin:{sx:7,sy:0,light:!0},trap:{sx:8,sy:0,light:!1},melees:{sx:9,sy:0,light:!1}}},weaponselect:{file:"weaponselect",fw:40,fh:40,weapon:{Melee:0,Arrow:1,Shell:2,Bullet:3,Rocket:4,Grenade:5},weapons:"Melee Arrow Shell Bullet Rocket Grenade".split(" ")},weapons:{file:"weapons",fw:32,fh:32,weapon:{Arrow:{sx:0,offset:{N:{dx:0,dy:0},S:{dx:2,dy:0},W:{dx:0,dy:0},E:{dx:0,dy:0}}},Rocket:{sx:1,offset:{N:{dx:4,dy:4},S:{dx:12,dy:0},W:{dx:10,dy:0},E:{dx:-10,dy:0}}},Grenade:{sx:2,offset:{N:{dx:0,dy:4},S:{dx:-2,dy:2},W:{dx:0,dy:2},E:{dx:0,dy:2}}},Shell:{sx:3,offset:{N:{dx:0,dy:4},S:{dx:10,dy:0},W:{dx:8,dy:0},E:{dx:-8,dy:0}}},Bullet:{sx:5,offset:{N:{dx:-16,dy:-6},S:{dx:-6,dy:-3},W:{dx:-7,dy:-3},E:{dx:7,dy:-3}}}}},shells:{file:"shells",fw:20,fh:12},spell:{file:"spell",fw:32,fh:20},rocket:{file:"rocket",fw:48,fh:20},grenade:{file:"grenade",fw:18,fh:24},arrow_E:{file:"arrow_E"},projectile_bone:{file:"projectile_bone"},die:{file:"die",fw:16,fh:16},explode2:{file:"explode",fw:16,fh:16},explode3:{file:"explode3",fw:64,fh:64},slash_N:{file:"slash_N",fw:64,fh:64},slash_S:{file:"slash_S",fw:64,fh:64},slash_W:{file:"slash_W",fw:64,fh:64},slash_E:{file:"slash_E",fw:64,fh:64},weapon_sword1:{file:"weapon_sword1",fw:32,fh:32},weapon_dagger1:{file:"weapon_dagger1",fw:32,fh:32},weapon_staff1:{file:"weapon_staff1",fw:32,fh:32},shield_green:{file:"shield3",fw:32,fh:32},shield_blue:{file:"shield4",fw:32,fh:32},shield_red:{file:"shield5",fw:32,fh:32},collect:{file:"collect"},pickup:{file:"pickup",fw:50,fh:96},class_war:{file:"class_war",fw:32,fh:32,status:{idleE:{frames:[[3,0],[3,0],[3,0],[4,0],[5,0],[4,0]]},idleW:{frames:[[3,1],[3,1],[3,1],[4,1],[5,1],[4,1]]},idleN:{frames:[[3,2],[3,2],[3,2],[4,2],[5,2],[4,2]]},idleS:{frames:[[3,3],[3,3],[3,3],[4,3],[5,3],[4,3]]},walkE:{frames:[[0,0],[1,0],[2,0],[1,0]]},walkW:{frames:[[0,1],[1,1],[2,1],[1,1]]},walkN:{frames:[[0,2],[1,2],[2,2],[1,2]]},walkS:{frames:[[0,3],[1,3],[2,3],[1,3]]},sneakE:{frames:[[0,0],[1,0],[2,0],[1,0]]},sneakW:{frames:[[0,1],[1,1],[2,1],[1,1]]},sneakN:{frames:[[0,2],[1,2],[2,2],[1,2]]},sneakS:{frames:[[0,3],[1,3],[2,3],[1,3]]},hitE:{frames:[[6,0]]},hitW:{frames:[[6,1]]},hitN:{frames:[[6,2]]},hitS:{frames:[[6,3]]},jumpE:{frames:[[7,0]]},jumpW:{frames:[[7,1]]},jumpN:{frames:[[7,2]]},jumpS:{frames:[[7,3]]},landE:{frames:[[8,0]]},landW:{frames:[[8,1]]},landN:{frames:[[8,2]]},landS:{frames:[[8,3]]},attackE:{frames:[[3,0]]},attackW:{frames:[[3,1]]},attackN:{frames:[[3,2]]},attackS:{frames:[[3,3]]},corpseE:{frames:[[5,0]]},corpseW:{frames:[[5,0]]},corpseN:{frames:[[5,0]]},corpseS:{frames:[[5,0]]}}},class_rog:{file:"class_rogue",fw:32,fh:32,status:{idleE:{frames:[[3,0],[3,0],[3,0],[4,0],[5,0],[4,0]]},idleW:{frames:[[3,1],[3,1],[3,1],[4,1],[5,1],[4,1]]},idleN:{frames:[[3,2],[3,2],[3,2],[4,2],[5,2],[4,2]]},idleS:{frames:[[3,3],[3,3],[3,3],[4,3],[5,3],[4,3]]},walkE:{frames:[[0,0],[1,0],[2,0],[1,0]]},walkW:{frames:[[0,1],[1,1],[2,1],[1,1]]},walkN:{frames:[[0,2],[1,2],[2,2],[1,2]]},walkS:{frames:[[0,3],[1,3],[2,3],[1,3]]},sneakE:{frames:[[0,0],[1,0],[2,0],[1,0]]},sneakW:{frames:[[0,1],[1,1],[2,1],[1,1]]},sneakN:{frames:[[0,2],[1,2],[2,2],[1,2]]},sneakS:{frames:[[0,3],[1,3],[2,3],[1,3]]},hitE:{frames:[[6,0]]},hitW:{frames:[[6,1]]},hitN:{frames:[[6,2]]},hitS:{frames:[[6,3]]},jumpE:{frames:[[7,0]]},jumpW:{frames:[[7,1]]},jumpN:{frames:[[7,2]]},jumpS:{frames:[[7,3]]},landE:{frames:[[8,0]]},landW:{frames:[[8,1]]},landN:{frames:[[8,2]]},landS:{frames:[[8,3]]},attackE:{frames:[[3,0]]},attackW:{frames:[[3,1]]},attackN:{frames:[[3,2]]},attackS:{frames:[[3,3]]},corpseE:{frames:[[5,0]]},corpseW:{frames:[[5,0]]},corpseN:{frames:[[5,0]]},corpseS:{frames:[[5,0]]}}},class_mag:{file:"class_mage",fw:32,fh:32,status:{idleE:{frames:[[3,0],[3,0],[3,0],[4,0],[5,0],[4,0]]},idleW:{frames:[[3,1],[3,1],[3,1],[4,1],[5,1],[4,1]]},idleN:{frames:[[3,2],[3,2],[3,2],[4,2],[5,2],[4,2]]},idleS:{frames:[[3,3],[3,3],[3,3],[4,3],[5,3],[4,3]]},walkE:{frames:[[0,0],[1,0],[2,0],[1,0]]},walkW:{frames:[[0,1],[1,1],[2,1],[1,1]]},walkN:{frames:[[0,2],[1,2],[2,2],[1,2]]},walkS:{frames:[[0,3],[1,3],[2,3],[1,3]]},sneakE:{frames:[[0,0],[1,0],[2,0],[1,0]]},sneakW:{frames:[[0,1],[1,1],[2,1],[1,1]]},sneakN:{frames:[[0,2],[1,2],[2,2],[1,2]]},sneakS:{frames:[[0,3],[1,3],[2,3],[1,3]]},hitE:{frames:[[6,0]]},hitW:{frames:[[6,1]]},hitN:{frames:[[6,2]]},hitS:{frames:[[6,3]]},jumpE:{frames:[[7,0]]},jumpW:{frames:[[7,1]]},jumpN:{frames:[[7,2]]},jumpS:{frames:[[7,3]]},landE:{frames:[[8,0]]},landW:{frames:[[8,1]]},landN:{frames:[[8,2]]},landS:{frames:[[8,3]]},attackE:{frames:[[3,0]]},attackW:{frames:[[3,1]]},attackN:{frames:[[3,2]]},attackS:{frames:[[3,3]]},corpseE:{frames:[[5,0]]},corpseW:{frames:[[5,0]]},corpseN:{frames:[[5,0]]},corpseS:{frames:[[5,0]]}}},class_war2:{file:"class_war_gold",fw:32,fh:32,status:{idleE:{frames:[[3,0],[3,0],[3,0],[4,0],[5,0],[4,0]]},idleW:{frames:[[3,1],[3,1],[3,1],[4,1],[5,1],[4,1]]},idleN:{frames:[[3,2],[3,2],[3,2],[4,2],[5,2],[4,2]]},idleS:{frames:[[3,3],[3,3],[3,3],[4,3],[5,3],[4,3]]},walkE:{frames:[[0,0],[1,0],[2,0],[1,0]]},walkW:{frames:[[0,1],[1,1],[2,1],[1,1]]},walkN:{frames:[[0,2],[1,2],[2,2],[1,2]]},walkS:{frames:[[0,3],[1,3],[2,3],[1,3]]},sneakE:{frames:[[0,0],[1,0],[2,0],[1,0]]},sneakW:{frames:[[0,1],[1,1],[2,1],[1,1]]},sneakN:{frames:[[0,2],[1,2],[2,2],[1,2]]},sneakS:{frames:[[0,3],[1,3],[2,3],[1,3]]},hitE:{frames:[[6,0]]},hitW:{frames:[[6,1]]},hitN:{frames:[[6,2]]},hitS:{frames:[[6,3]]},jumpE:{frames:[[7,0]]},jumpW:{frames:[[7,1]]},jumpN:{frames:[[7,2]]},jumpS:{frames:[[7,3]]},landE:{frames:[[8,0]]},landW:{frames:[[8,1]]},landN:{frames:[[8,2]]},landS:{frames:[[8,3]]},attackE:{frames:[[3,0]]},attackW:{frames:[[3,1]]},attackN:{frames:[[3,2]]},attackS:{frames:[[3,3]]},corpseE:{frames:[[5,0]]},corpseW:{frames:[[5,0]]},corpseN:{frames:[[5,0]]},corpseS:{frames:[[5,0]]}}},class_rog2:{file:"class_rogue_gold",fw:32,fh:32,status:{idleE:{frames:[[3,0],[3,0],[3,0],[4,0],[5,0],[4,0]]},idleW:{frames:[[3,1],[3,1],[3,1],[4,1],[5,1],[4,1]]},idleN:{frames:[[3,2],[3,2],[3,2],[4,2],[5,2],[4,2]]},idleS:{frames:[[3,3],[3,3],[3,3],[4,3],[5,3],[4,3]]},walkE:{frames:[[0,0],[1,0],[2,0],[1,0]]},walkW:{frames:[[0,1],[1,1],[2,1],[1,1]]},walkN:{frames:[[0,2],[1,2],[2,2],[1,2]]},walkS:{frames:[[0,3],[1,3],[2,3],[1,3]]},sneakE:{frames:[[0,0],[1,0],[2,0],[1,0]]},sneakW:{frames:[[0,1],[1,1],[2,1],[1,1]]},sneakN:{frames:[[0,2],[1,2],[2,2],[1,2]]},sneakS:{frames:[[0,3],[1,3],[2,3],[1,3]]},hitE:{frames:[[6,0]]},hitW:{frames:[[6,1]]},hitN:{frames:[[6,2]]},hitS:{frames:[[6,3]]},jumpE:{frames:[[7,0]]},jumpW:{frames:[[7,1]]},jumpN:{frames:[[7,2]]},jumpS:{frames:[[7,3]]},landE:{frames:[[8,0]]},landW:{frames:[[8,1]]},landN:{frames:[[8,2]]},landS:{frames:[[8,3]]},attackE:{frames:[[3,0]]},attackW:{frames:[[3,1]]},attackN:{frames:[[3,2]]},attackS:{frames:[[3,3]]},corpseE:{frames:[[5,0]]},corpseW:{frames:[[5,0]]},corpseN:{frames:[[5,0]]},corpseS:{frames:[[5,0]]}}},class_mag2:{file:"class_mage_gold",fw:32,fh:32,status:{idleE:{frames:[[3,0],[3,0],[3,0],[4,0],[5,0],[4,0]]},idleW:{frames:[[3,1],[3,1],[3,1],[4,1],[5,1],[4,1]]},idleN:{frames:[[3,2],[3,2],[3,2],[4,2],[5,2],[4,2]]},idleS:{frames:[[3,3],[3,3],[3,3],[4,3],[5,3],[4,3]]},walkE:{frames:[[0,0],[1,0],[2,0],[1,0]]},walkW:{frames:[[0,1],[1,1],[2,1],[1,1]]},walkN:{frames:[[0,2],[1,2],[2,2],[1,2]]},walkS:{frames:[[0,3],[1,3],[2,3],[1,3]]},sneakE:{frames:[[0,0],[1,0],[2,0],[1,0]]},sneakW:{frames:[[0,1],[1,1],[2,1],[1,1]]},sneakN:{frames:[[0,2],[1,2],[2,2],[1,2]]},sneakS:{frames:[[0,3],[1,3],[2,3],[1,3]]},hitE:{frames:[[6,0]]},hitW:{frames:[[6,1]]},hitN:{frames:[[6,2]]},hitS:{frames:[[6,3]]},jumpE:{frames:[[7,0]]},jumpW:{frames:[[7,1]]},jumpN:{frames:[[7,2]]},jumpS:{frames:[[7,3]]},landE:{frames:[[8,0]]},landW:{frames:[[8,1]]},landN:{frames:[[8,2]]},landS:{frames:[[8,3]]},attackE:{frames:[[3,0]]},attackW:{frames:[[3,1]]},attackN:{frames:[[3,2]]},attackS:{frames:[[3,3]]},corpseE:{frames:[[5,0]]},corpseW:{frames:[[5,0]]},corpseN:{frames:[[5,0]]},corpseS:{frames:[[5,0]]}}},skeleton:{file:"skeleton",fw:32,fh:32,status:{idleE:{frames:[[3,0],[3,0],[3,0],[6,0],[7,0],[6,0]]},idleW:{frames:[[3,1],[3,1],[3,1],[6,1],[7,1],[6,1]]},idleN:{frames:[[3,2],[3,2],[3,2],[6,2],[7,2],[6,2]]},idleS:{frames:[[3,3],[3,3],[3,3],[6,3],[7,3],[6,3]]},walkE:{frames:[[0,0],[1,0],[2,0],[3,0]]},walkW:{frames:[[0,1],[1,1],[2,1],[3,1]]},walkN:{frames:[[0,2],[1,2],[2,2],[3,2]]},walkS:{frames:[[0,3],[1,3],[2,3],[3,3]]},sneakE:{frames:[[0,0],[1,0],[2,0],[3,0]]},sneakW:{frames:[[0,1],[1,1],[2,1],[3,1]]},sneakN:{frames:[[0,2],[1,2],[2,2],[3,2]]},sneakS:{frames:[[0,3],[1,3],[2,3],[3,3]]},hitE:{frames:[[4,0]]},hitW:{frames:[[4,1]]},hitN:{frames:[[4,2]]},hitS:{frames:[[4,3]]},jumpE:{frames:[[3,0]]},jumpW:{frames:[[3,1]]},jumpN:{frames:[[3,2]]},jumpS:{frames:[[3,3]]},landE:{frames:[[3,0]]},landW:{frames:[[3,1]]},landN:{frames:[[3,2]]},landS:{frames:[[3,3]]},attackE:{frames:[[3,0]]},attackW:{frames:[[3,1]]},attackN:{frames:[[3,2]]},attackS:{frames:[[3,3]]},telegraphE:{frames:[[5,0]]},telegraphW:{frames:[[5,1]]},telegraphN:{frames:[[5,2]]},telegraphS:{frames:[[5,3]]}}},goblin:{file:"goblin",fw:32,fh:32,status:{idleE:{frames:[[3,0],[3,0],[3,0],[6,0],[7,0],[6,0]]},idleW:{frames:[[3,1],[3,1],[3,1],[6,1],[7,1],[6,1]]},idleN:{frames:[[3,2],[3,2],[3,2],[6,2],[7,2],[6,2]]},idleS:{frames:[[3,3],[3,3],[3,3],[6,3],[7,3],[6,3]]},walkE:{frames:[[0,0],[1,0],[2,0],[3,0]]},walkW:{frames:[[0,1],[1,1],[2,1],[3,1]]},walkN:{frames:[[0,2],[1,2],[2,2],[3,2]]},walkS:{frames:[[0,3],[1,3],[2,3],[3,3]]},sneakE:{frames:[[0,0],[1,0],[2,0],[3,0]]},sneakW:{frames:[[0,1],[1,1],[2,1],[3,1]]},sneakN:{frames:[[0,2],[1,2],[2,2],[3,2]]},sneakS:{frames:[[0,3],[1,3],[2,3],[3,3]]},hitE:{frames:[[4,0]]},hitW:{frames:[[4,1]]},hitN:{frames:[[4,2]]},hitS:{frames:[[4,3]]},jumpE:{frames:[[3,0]]},jumpW:{frames:[[3,1]]},jumpN:{frames:[[3,2]]},jumpS:{frames:[[3,3]]},landE:{frames:[[3,0]]},landW:{frames:[[3,1]]},landN:{frames:[[3,2]]},landS:{frames:[[3,3]]},attackE:{frames:[[3,0]]},attackW:{frames:[[3,1]]},attackN:{frames:[[3,2]]},attackS:{frames:[[3,3]]},telegraphE:{frames:[[5,0]]},telegraphW:{frames:[[5,1]]},telegraphN:{frames:[[5,2]]},telegraphS:{frames:[[5,3]]}}},slime:{file:"slime",fw:32,fh:32,status:{idleE:{frames:[[0,0],[0,0],[1,0],[1,0]]},idleW:{frames:[[0,0],[0,0],[1,0],[1,0]]},idleN:{frames:[[0,0],[0,0],[1,0],[1,0]]},idleS:{frames:[[0,0],[0,0],[1,0],[1,0]]},walkE:{frames:[[0,0],[1,0],[2,0]]},walkW:{frames:[[0,0],[1,0],[2,0]]},walkN:{frames:[[0,0],[1,0],[2,0]]},walkS:{frames:[[0,0],[1,0],[2,0]]},sneakE:{frames:[[0,0],[1,0],[2,0]]},sneakW:{frames:[[0,0],[1,0],[2,0]]},sneakN:{frames:[[0,0],[1,0],[2,0]]},sneakS:{frames:[[0,0],[1,0],[2,0]]},hitE:{frames:[[3,0]]},hitW:{frames:[[3,0]]},hitN:{frames:[[3,0]]},hitS:{frames:[[3,0]]},jumpE:{frames:[[2,0]]},jumpW:{frames:[[2,0]]},jumpN:{frames:[[2,0]]},jumpS:{frames:[[2,0]]},landE:{frames:[[1,0]]},landW:{frames:[[1,0]]},landN:{frames:[[1,0]]},landS:{frames:[[1,0]]},attackE:{frames:[[0,0]]},attackW:{frames:[[0,0]]},attackN:{frames:[[0,0]]},attackS:{frames:[[0,0]]},telegraphE:{frames:[[4,0]]},telegraphW:{frames:[[4,0]]},telegraphN:{frames:[[4,0]]},telegraphS:{frames:[[4,0]]}}},slime_green:{file:"slime_green",fw:32,fh:32,status:{idleE:{frames:[[0,0],[0,0],[1,0],[1,0]]},idleW:{frames:[[0,0],[0,0],[1,0],[1,0]]},idleN:{frames:[[0,0],[0,0],[1,0],[1,0]]},idleS:{frames:[[0,0],[0,0],[1,0],[1,0]]},walkE:{frames:[[0,0],[1,0],[2,0]]},walkW:{frames:[[0,0],[1,0],[2,0]]},walkN:{frames:[[0,0],[1,0],[2,0]]},walkS:{frames:[[0,0],[1,0],[2,0]]},sneakE:{frames:[[0,0],[1,0],[2,0]]},sneakW:{frames:[[0,0],[1,0],[2,0]]},sneakN:{frames:[[0,0],[1,0],[2,0]]},sneakS:{frames:[[0,0],[1,0],[2,0]]},hitE:{frames:[[3,0]]},hitW:{frames:[[3,0]]},hitN:{frames:[[3,0]]},hitS:{frames:[[3,0]]},jumpE:{frames:[[2,0]]},jumpW:{frames:[[2,0]]},jumpN:{frames:[[2,0]]},jumpS:{frames:[[2,0]]},landE:{frames:[[1,0]]},landW:{frames:[[1,0]]},landN:{frames:[[1,0]]},landS:{frames:[[1,0]]},attackE:{frames:[[0,0]]},attackW:{frames:[[0,0]]},attackN:{frames:[[0,0]]},attackS:{frames:[[0,0]]},telegraphE:{frames:[[4,0]]},telegraphW:{frames:[[4,0]]},telegraphN:{frames:[[4,0]]},telegraphS:{frames:[[4,0]]}}},slime_red:{file:"slime_red",fw:32,fh:32,status:{idleE:{frames:[[0,0],[0,0],[1,0],[1,0]]},idleW:{frames:[[0,0],[0,0],[1,0],[1,0]]},idleN:{frames:[[0,0],[0,0],[1,0],[1,0]]},idleS:{frames:[[0,0],[0,0],[1,0],[1,0]]},walkE:{frames:[[0,0],[1,0],[2,0]]},walkW:{frames:[[0,0],[1,0],[2,0]]},walkN:{frames:[[0,0],[1,0],[2,0]]},walkS:{frames:[[0,0],[1,0],[2,0]]},sneakE:{frames:[[0,0],[1,0],[2,0]]},sneakW:{frames:[[0,0],[1,0],[2,0]]},sneakN:{frames:[[0,0],[1,0],[2,0]]},sneakS:{frames:[[0,0],[1,0],[2,0]]},hitE:{frames:[[3,0]]},hitW:{frames:[[3,0]]},hitN:{frames:[[3,0]]},hitS:{frames:[[3,0]]},jumpE:{frames:[[2,0]]},jumpW:{frames:[[2,0]]},jumpN:{frames:[[2,0]]},jumpS:{frames:[[2,0]]},landE:{frames:[[1,0]]},landW:{frames:[[1,0]]},landN:{frames:[[1,0]]},landS:{frames:[[1,0]]},attackE:{frames:[[0,0]]},attackW:{frames:[[0,0]]},attackN:{frames:[[0,0]]},attackS:{frames:[[0,0]]},telegraphE:{frames:[[4,0]]},telegraphW:{frames:[[4,0]]},telegraphN:{frames:[[4,0]]},telegraphS:{frames:[[4,0]]}}},bat:{file:"bat",fw:32,fh:32,status:{idleE:{frames:[[0,0],[1,0],[2,0],[1,0]]},idleW:{frames:[[0,1],[1,1],[2,1],[1,1]]},idleN:{frames:[[0,2],[1,2],[2,2],[1,2]]},idleS:{frames:[[0,3],[1,3],[2,3],[1,3]]},walkE:{frames:[[0,0],[1,0],[2,0],[1,0]]},walkW:{frames:[[0,1],[1,1],[2,1],[1,1]]},walkN:{frames:[[0,2],[1,2],[2,2],[1,2]]},walkS:{frames:[[0,3],[1,3],[2,3],[1,3]]},sneakE:{frames:[[0,0],[1,0],[2,0],[1,0]]},sneakW:{frames:[[0,1],[1,1],[2,1],[1,1]]},sneakN:{frames:[[0,2],[1,2],[2,2],[1,2]]},sneakS:{frames:[[0,3],[1,3],[2,3],[1,3]]},hitE:{frames:[[3,0]]},hitW:{frames:[[3,1]]},hitN:{frames:[[3,2]]},hitS:{frames:[[3,3]]},attackE:{frames:[[0,0]]},attackW:{frames:[[0,1]]},attackN:{frames:[[0,2]]},attackS:{frames:[[0,3]]},corpseE:{frames:[[3,0]]},corpseW:{frames:[[3,0]]},corpseN:{frames:[[3,0]]},corpseS:{frames:[[3,0]]},telegraphE:{frames:[[4,0]]},telegraphW:{frames:[[4,1]]},telegraphN:{frames:[[4,2]]},telegraphS:{frames:[[4,3]]}}},thief:{file:"thug",fw:32,fh:32,status:{idleE:{frames:[[3,0],[3,0],[3,0],[4,0],[5,0],[4,0]]},idleW:{frames:[[3,1],[3,1],[3,1],[4,1],[5,1],[4,1]]},idleN:{frames:[[3,2],[3,2],[3,2],[4,2],[5,2],[4,2]]},idleS:{frames:[[3,3],[3,3],[3,3],[4,3],[5,3],[4,3]]},walkE:{frames:[[0,0],[1,0],[2,0],[1,0]]},walkW:{frames:[[0,1],[1,1],[2,1],[1,1]]},walkN:{frames:[[0,2],[1,2],[2,2],[1,2]]},walkS:{frames:[[0,3],[1,3],[2,3],[1,3]]},sneakE:{frames:[[1,0]]},sneakW:{frames:[[1,1]]},sneakN:{frames:[[1,2]]},sneakS:{frames:[[1,3]]},hitE:{frames:[[6,0]]},hitW:{frames:[[6,1]]},hitN:{frames:[[6,2]]},hitS:{frames:[[6,3]]},attackE:{frames:[[3,0]]},attackW:{frames:[[3,1]]},attackN:{frames:[[3,2]]},attackS:{frames:[[3,3]]},corpseE:{frames:[[5,0]]},corpseW:{frames:[[5,0]]},corpseN:{frames:[[5,0]]},corpseS:{frames:[[5,0]]},telegraphE:{frames:[[7,0]]},telegraphW:{frames:[[7,1]]},telegraphN:{frames:[[7,2]]},telegraphS:{frames:[[7,3]]}}},treasure:{file:"treasure",fw:32,fh:32,status:{idleE:{frames:[[0,0]]},idleW:{frames:[[0,0]]},idleN:{frames:[[0,0]]},idleS:{frames:[[0,0]]},hitE:{frames:[[0,0]]},hitW:{frames:[[0,0]]},hitN:{frames:[[0,0]]},hitS:{frames:[[0,0]]}}}},tilesets:{0:{file:"0",fw:32,fh:32,animated:{2:{speed:30},11:{speed:15},26:{speed:15},32:{speed:10},45:{speed:10},58:{speed:30},60:{speed:30},66:{speed:30},137:{speed:15}},stairs:[120,121,122,123,147,148,149,164],water:[26,137],gras:[2,58]}}};var _audio={blip:{file:"blip",type:"sound"},arrow:{file:"arrow_o",type:"sound"},block:{file:"block_o",type:"sound"},block2:{file:"prehit",type:"sound",volume:65},bullet:{file:"bullet_o",type:"sound",volume:90},hit:{file:"hit_o",type:"sound"},potion:{file:"potion_o",type:"sound",volume:80},ricochet:{file:"ricochet_o",type:"sound",volume:80},jump:{file:"jump6",type:"sound",volume:80},pickup:{file:"pickup_o",type:"sound"},shell:{file:"shell_o",type:"sound"},switch:{file:"switch2",type:"sound"},explode:{file:"explode4",type:"sound"},rocket:{file:"rocket2",type:"sound",volume:90},thud:{file:"grenade2",type:"sound"},die:{file:"die6",type:"sound"},coin:{file:"star5",type:"sound",volume:80},land:{file:"thud",type:"sound",volume:70},slash:{file:"slash_o",type:"sound",volume:60},msg:{file:"msg2",type:"sound",volume:80},cheer0:{file:"cheer3",type:"sound",volume:30},cheer1:{file:"cheer6",type:"sound",volume:30},cheer2:{file:"cheer7",type:"sound",volume:30},click:{file:"select",type:"sound"},pirate:{file:"pirate",type:"music",volume:60,loop:!0},results:{file:"results",type:"music",volume:60},time_machine:{file:"timemachine",type:"music",volume:60,loop:!0},menu:{file:"action",type:"music",volume:45,loop:!0},timeless:{file:"timeless",type:"music",volume:50,loop:!0},superwing_heroes:{file:"superwing_heroes",type:"music",volume:50,loop:!0},rusty_courier:{file:"rusty_courier",type:"music",volume:60,loop:!0},funkycastle:{file:"funkycastle2",type:"music",volume:60,loop:!0}};Function.prototype.extend=function(e){function t(){}t.prototype=e.prototype,this.prototype=new t,this.prototype.constructor=this,this.prototype.uber=e.prototype},function(){for(var e=0,t=["ms","moz","webkit","o"],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"RequestCancelAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,i){var n=(new Date).getTime(),s=Math.max(0,16-(n-e)),a=window.setTimeout((function(){t(n+s)}),s);return e=n+s,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),Object.size=Object.keys?function(e){return Object.keys(e).length}:function(e){var t,i=0;for(t in e)void 0!==e[t]&&i++;return i},$.ajaxSetup({cache:!0});var Engine={version:"0.4.2.81",versionVisible:"0.4.1",source:null,patreonEnabled:!0,loaded:0,baseWidth:640,baseHeight:360,scale:0,scaleVisible:0,scaleAuto:!0,fullscreen:!0,fullscreenScale:1,fullscreenAPI:!1,allowContextScale:!1,contextSmoothing:!0,contextScale:0,width:0,height:0,wH:0,hH:0,ENT_ID:0,browser:{},isNodeWebkit:!1,updateServer:"https://update.treasurearena.com",kongregate:!1,debug:!1,gamepadSupport:!1,gamepadActive:!1,particles:!0,viewedChangelog:!1,webaudio:!1,LoadMusicOnDemand:!0,StreamMusic:!1,ads:{show:!1,preroll:!1,started:0,finished:!1},showNews:!0,_servers:{us1:{name:"US West",tag:"u",ip:"server6.treasurearena.com",port:"8082"},us2:{name:"US East",tag:"n",ip:"server7.treasurearena.com",port:"8082"},us3:{name:"US West",tag:"s",ip:"server6.treasurearena.com",port:"8082"},eu1:{name:"Europe (Germany)",tag:"e",ip:"server9.treasurearena.com",port:"8082"},eu2:{name:"Europe (UK)",tag:"k",ip:"server8.treasurearena.com",port:"8082"},as1:{name:"Asia (Singapore)",tag:"a",ip:"server10.treasurearena.com",port:"8082"},dev:{name:"DEV",tag:"d",ip:"dev.treasurearena.com",port:"8082"},loc:{name:"LOCAL",tag:"l",ip:"192.168.0.34",port:"8082"}},server:{alive:0,connected:!1,login:!1,ping:0,current:{},protocol:function(){var e=document.location.protocol;return"https:"===e||"http:"===e?e.split(":")[0]:"https"},connect:function(e){var t=this.current;Engine.socket=io.connect(Engine.server.protocol()+"://"+t.ip+":"+t.port,e)}},gameUrl:function(){return"http"===Engine.server.protocol()?"http://192.168.0.34/ta-game":"https://play.treasurearena.com"},redirectUrl:function(){return"http"===Engine.server.protocol()?"http://192.168.0.34/ta-game":"https://play.treasurearena.com/patreon/redirect"},branding:!1,brandingsAvailable:"a10 fgl clay leadbolt cpmstar cpmstarpreroll miniclip".split(" "),brandingCustom:{a10:!0,fgl:!1,clay:!1,leadbolt:!1,cpmstar:!1,cpmstarpreroll:!1,miniclip:!0},splashscreenCustom:{a10:!0,fgl:!1,clay:!1,leadbolt:!1,cpmstar:!1,cpmstarpreroll:!1,miniclip:!1},shareUrlCustom:{a10:!1,fgl:!1,clay:!1,leadbolt:!1,cpmstar:!1,cpmstarpreroll:!1,miniclip:"https://www.miniclip.com/games/treasure-arena/"},allowLobbiesAd:{a10:!0,fgl:!0,clay:!0,leadbolt:!0,cpmstar:!0,cpmstarpreroll:!0,miniclip:!1},allowFullscreen:{a10:!0,fgl:!0,clay:!0,leadbolt:!0,cpmstar:!0,cpmstarpreroll:!0,miniclip:!1},allowChat:{a10:!0,fgl:!0,clay:!0,leadbolt:!0,cpmstar:!0,cpmstarpreroll:!0,miniclip:!1},frameStep:1e3/60,fps:{count:0,timeline:0,fps:0,visible:!1,capture:!0,history:[],historyMax:600,doCapture:function(){if(1e4>Engine.now-this.capture)this.history.push(this.fps);else{var e=this.getAvarage();this.capture=!1,this.history.length=0,Engine.particles=!(!e||50>e)}},getAvarage:function(){for(var e=0,t=0,i=this.history.length;i--;)"number"!=typeof this.history[i]?t++:e+=this.history[i];return e/(this.history.length-t)},update:function(e){this.timeline+=e,this.count++,1e3<=this.timeline&&(this.timeline=0,this.fps=this.count,this.count=0)},draw:function(){this.visible&&Engine.text("visitor",this.fps,0,0)}},lastFrame:+new Date,deltaT:0,dt:0,tick:0,timeline:0,idle:!1,state:0,math:{PI:Math.PI},keys:{CTRL:!1,UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1,FIRE:!1,JUMP:!1,RUN:!1,BLOCK:!1,SKILL1:!1,WEAPON:!1,WHEEL:!1,MOUSEDOWN:!1,MOUSEPOS:{x:0,y:0},STICK:{x:0,y:0},STICKDISTANCE:1,START:!1,B:!1,Y:!1,X:!1,BACK:!1,CONSOLE:!1},typo:{A:[0,0],B:[1,0],C:[2,0],D:[3,0],E:[4,0],F:[5,0],G:[6,0],H:[7,0],I:[8,0],J:[9,0],K:[10,0],L:[11,0],M:[12,0],N:[13,0],O:[14,0],P:[15,0],Q:[16,0],R:[17,0],S:[18,0],T:[19,0],U:[20,0],V:[21,0],W:[22,0],X:[23,0],Y:[24,0],Z:[25,0]," ":[26,0],a:[0,1],b:[1,1],c:[2,1],d:[3,1],e:[4,1],f:[5,1],g:[6,1],h:[7,1],i:[8,1],j:[9,1],k:[10,1],l:[11,1],m:[12,1],n:[13,1],o:[14,1],p:[15,1],q:[16,1],r:[17,1],s:[18,1],t:[19,1],u:[20,1],v:[21,1],w:[22,1],x:[23,1],y:[24,1],z:[25,1],0:[0,2],1:[1,2],2:[2,2],3:[3,2],4:[4,2],5:[5,2],6:[6,2],7:[7,2],8:[8,2],9:[9,2],".":[10,2],",":[11,2],"-":[12,2],_:[13,2],"?":[14,2],"!":[15,2],'"':[16,2],"%":[17,2],"&":[18,2],"/":[19,2],"(":[20,2],")":[21,2],"=":[22,2],"*":[23,2],":":[24,2],";":[25,2],"<":[26,2],">":[27,2],"|":[28,2],"'":[29,2],"\\":[30,2],"+":[31,2]},fullscreenLaunch:function(e){if(Engine.isNodeWebkit)NW.gui.Window.get().enterFullscreen();else{e=e||document.documentElement;for(var t=["requestFullScreen","webkitRequestFullScreen","mozRequestFullScreen"],i=0;i<t.length;i++)if(e[t[i]]){e[t[i]](Element.ALLOW_KEYBOARD_INPUT);break}}},fullscreenCancel:function(e){if(Engine.isNodeWebkit)NW.gui.Window.get().leaveFullscreen();else{e=["cancelFullScreen","webkitCancelFullScreen","mozCancelFullScreen"];for(var t=0;t<e.length;t++)if(document[e[t]]){document[e[t]]();break}}},fullscreenCheck:function(){Engine.fullscreenAPI=!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||Engine.isNodeWebkit),Engine.Elements.elements.options.process()},text:function(e,t,i,n,s,a,o){s=s||!1,e=Engine.Assets.fonts[e],t=t.toString(),o=(o=o||Engine.canvas).ctx,null!=a&&(o.save(),o.translate(i+e.fw/2*-a,n+e.fh/2*-a),o.scale(1+a,1+a),i=10*Engine.scale,n=Engine.scale);var r,l,h,c,d,g,u,p,f,m=t.length;for(r=0;r<m;r++)void 0!==(h=Engine.typo[t[r]])&&(l=h[0]*e.fw|0,h=h[1]*e.fh|0,c=0|e.fw,d=0|e.fh,g=s?i+r*(e.fw-e.fw/4)-m*(e.fw-e.fw/4)/2|0:i+r*(e.fw-e.fw/4)|0,u=0|n,p=c,f=d,o.drawImage(e,l,h,c,d,g,u,p,f));void 0!==a&&o.restore()},loadingStack:[],history:{pushState:function(e){if(void 0===(e=e||{}).title&&(e.title=document.title),void 0===e.path){var t=Engine.getURLParameter("ref");e.path=t?window.location.pathname+"?ref="+t:window.location.pathname}try{history.replaceState("",e.title,e.path)}catch(e){}}},getScript:function(e){$.getScript(e).done((function(e,t){console.log(t)})).fail((function(t,i,n){console.log("fail"),setTimeout((function(){Engine.getScript(e)}),1e3)}))},getURLParameter:function(e){return decodeURIComponent((RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null},detectMobile:function(){var e=!1,t=navigator.userAgent||navigator.vendor||window.opera;return(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e},detectBrowser:function(){this.browser=$.browser;var e=this.detectMobile(),t=!!window.opera||0<=navigator.userAgent.indexOf(" OPR/")||0<=navigator.userAgent.indexOf("Opera"),i=0<=navigator.userAgent.indexOf(" OPR/"),n="undefined"!=typeof InstallTrigger;Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor");t=!!window.chrome&&!t||0<=navigator.userAgent.indexOf("Chrome");var s=this.browser.msie&&9<=parseInt(this.browser.version),a=!(!navigator.userAgent.match(/Trident/)||navigator.userAgent.match(/MSIE/)),o="object"==typeof process;o&&(Engine.isNodeWebkit=!0),this.browser.supported=!(!(s||a||t||n||i||o)||e)},rand:function(e,t){return Math.floor(Math.random()*(t-e+1)+e)},capFirst:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},info:function(e){Engine.Elements.append("info"),$("#info").html(e).animate({top:0},{duration:300,complete:function(){$("#info").delay(2e3).animate({top:-100},{duration:300,complete:function(){Engine.Elements.remove("info")}})}})},saveSettings:function(){this.setCookie("settings",JSON.stringify({fullscreen:this.fullscreen,audio:{sound:this.audio.sound,music:this.audio.music,volume:this.audio.volume}}),100)},loadSettings:function(){var e=this.getCookie("settings");return!!e&&(e=JSON.parse(e),this.fullscreen!=e.fullscreen&&(this.fullscreen=e.fullscreen,Engine.fullscreen||Engine.removeFullscreen(),Engine.updateScreen()),this.audio.sound!=e.audio.sound&&(this.audio.sound=e.audio.sound,Engine.audio.sound?Engine.audio.unmute("sound"):Engine.audio.mute("sound")),this.audio.music!=e.audio.music&&(this.audio.music=e.audio.music,Engine.audio.music?Engine.audio.unmute("music"):Engine.audio.mute("music")),this.audio.volume.sound!=e.audio.volume.sound&&Engine.audio.volumeSoundChange(e.audio.volume.sound),this.audio.volume.music!=e.audio.volume.music&&Engine.audio.volumeMusicChange(e.audio.volume.music),!0)},setCookie:function(e,t,i){var n=new Date;n.setDate(n.getDate()+i),t=escape(t)+(null==i?"":"; expires="+n.toUTCString()),document.cookie=e+"="+t+";"},getCookie:function(e){var t,i=document.cookie.split(";"),n=i.length,s=!1;for(t=0;t<n;t++)if(i[t].substr(0,i[t].indexOf("=")).replace(/^\s+|\s+$/g,"")==e){e=i[t].substr(i[t].indexOf("=")+1),s=unescape(e);break}return s},deleteCookie:function(e){!1!==this.getCookie(e)&&(document.cookie=e+"=;expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/")},getPatreonTier:function(){return!1===Engine.getCookie("patreon-user")?-1:Number(Engine.getCookie("patreon-tier"))},checkCollision:function(e,t){var i,n,s,a,o,r,l,h,c=e.length,d={},g={};for(i=0;i<c;i++)if((s=e[i]).collidable)for(d.left=s.data.x,d.right=s.data.x+1,d.top=s.data.y,d.bottom=s.data.y+1,n=i+1;n<c;n++)h=l=r=o=!1,!(a=e[n]).collidable||"projectile"===a.type&&!a.canHurtSelf&&a.owner===s.id||"projectile"===s.type&&!s.canHurtSelf&&s.owner===a.id||"projectile"===a.type&&s.inAir||"projectile"===s.type&&a.inAir||a.data.id==s.data.id||(g.left=a.data.x+.2,g.right=a.data.x+1-.2,g.top=a.data.y+.4,g.bottom=a.data.y+1-.4,(d.top<g.top&&d.bottom>g.top&&d.right>g.left&&d.left<g.right||d.bottom>g.bottom&&d.top<g.bottom&&d.right>g.left&&d.left<g.right)&&Engine.collisionAABB(d,g)&&(h=r=o=!0),(d.left<g.left&&d.right>g.left&&d.bottom>g.top&&d.top<g.bottom||d.right>g.right&&d.left<g.right&&d.bottom>g.top&&d.top<g.bottom)&&Engine.collisionAABB(d,g)&&(o&&(h=!1),l=r=!0),r&&(s.collide(a,l,h),a.collide(s,l,h)))},lineDistance:function(e,t){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)},clone:function(e){if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return(i=new Date).setTime(e.getTime()),i;if(e instanceof Array){var t,i=[],n=e.length;for(t=0;t<n;t++)i[t]=this.clone(e[t]);return i}if(e instanceof Object){for(t in i={},e)e.hasOwnProperty(t)&&(i[t]=this.clone(e[t]));return i}},collisionAABB:function(e,t){return!(t.left>e.right||t.right<e.left||t.top>e.bottom||t.bottom<e.top)},hue2rgb:function(e,t,i){return 0>i&&(i+=1),1<i&&(i-=1),1>6*i?e+6*(t-e)*i:1>2*i?t:2>3*i?e+6*(t-e)*(2/3-i):e},hsla:function(e,t,i,n){var s,a;return e/=360,i/=100,n=n||1,0==(t/=100)?(t=255*i,s=255*i,e=255*i):(i=2*i-(a=.5>i?i*(1+t):i+t-t*i),t=255*this.hue2rgb(i,a,e+1/3)|0,s=255*this.hue2rgb(i,a,e)|0,e=255*this.hue2rgb(i,a,e-1/3)|0),"rgba("+t+", "+s+", "+e+", "+n+")"},createCanvas:function(){var e;(e=document.createElement("canvas")).id="c",e.width=this.baseWidth,e.height=this.baseHeight,e.ctx=e.getContext("2d",{willReadFrequently:!0}),this.disableSmoothing(e),$("#screen").append(e),Engine.canvas=e},createOverlay:function(){$("#screen").append('<div id="overlay"></div>')},makeFullscreen:function(){var e=document.getElementById("screen").offsetWidth,t=document.getElementById("screen").offsetHeight,i=Math.min(window.innerWidth/e,window.innerHeight/t);this.fullscreenScale=i,$("#screen").css("transform-origin","0 0").css("transform","scale3d("+i+", "+i+", 1)"),$("#screen").css("-ms-transform-origin","0 0").css("-ms-transform","scale("+i+", "+i+")"),$("#screen").css("-webkit-transform-origin","0 0").css("-webkit-transform","scale3d("+i+", "+i+", 1)"),$("#screen").css("-moz-transform-origin","0 0").css("-moz-transform","scale3d("+i+", "+i+", 1)"),t=(window.innerHeight-t*i)/2|0,e=(window.innerWidth-e*i)/2|0,$("#screen").css("top",t+"px").css("left",e+"px")},removeFullscreen:function(){this.fullscreenScale=1,$("#screen").css("transform-origin","0 0").css("transform","scale3d(1, 1, 1)"),$("#screen").css("-ms-transform-origin","0 0").css("-ms-transform","scale(1, 1)"),$("#screen").css("-webkit-transform-origin","0 0").css("-webkit-transform","scale3d(1, 1, 1)"),$("#screen").css("-moz-transform-origin","0 0").css("-moz-transform","scale3d(1, 1, 1)")},updateScreen:function(e){var t;if((0==(e=e||(this.contextSmoothing?this.scale:this.contextScale))||this.scaleAuto)&&(e=2*(e=Math.min(window.innerWidth/this.baseWidth,window.innerHeight/this.baseHeight))|0,e=1>(e=2<(e=3<(e/=2)?3:e)&&3>e?2:e)?1:e,e|=0),this.contextSmoothing){if(e!=this.scale)return void this.resize(e)}else if(e!=this.contextScale)return void this.resizeContext(e);e=(window.innerWidth-this.canvas.width)/2|0,t=(window.innerHeight-this.canvas.height)/2|0,$("#screen").css("left",e+"px").css("top",t+"px"),this.updateOverlay(this.contextSmoothing?this.scale:this.contextScale),this.fullscreen&&this.makeFullscreen()},updateOverlay:function(e){e/=2,$("#overlay").css("transform-origin","0 0").css("transform","scale3d("+e+", "+e+", 1)"),$("#overlay").css("-ms-transform-origin","0 0").css("-ms-transform","scale("+e+", "+e+")"),$("#overlay").css("-webkit-transform-origin","0 0").css("-webkit-transform","scale3d("+e+", "+e+", 1)"),$("#overlay").css("-moz-transform-origin","0 0").css("-moz-transform","scale3d("+e+", "+e+", 1)"),$("#overlay").css("width",(2*this.baseWidth|0)+"px").css("height",(2*this.baseHeight|0)+"px")},disableSmoothing:function(e){try{e.ctx.webkitImageSmoothingEnabled=!1,e.ctx.imageSmoothingEnabled=!1,e.ctx.mozImageSmoothingEnabled=!1,e.ctx.oImageSmoothingEnabled=!1,Engine.contextSmoothing&&Engine.allowContextScale&&(Engine.contextSmoothing=!1)}catch(e){console.log("Rendering mode not available")}},resizeContext:function(e){this.width=this.baseWidth,this.height=this.baseHeight,this.wH=this.width/2,this.hH=this.height/2,this.contextScale=e,this.scale=1,this.canvas.width=this.width*e,this.canvas.height=this.height*e,this.updateScreen(e),this.disableSmoothing(this.canvas),this.canvas.ctx.scale(Engine.contextScale,Engine.contextScale),this.Assets.addAll(this.scale),this.addLoading((function(){Engine.Game?(Engine.Game.reloadMap(),Engine.Game.rebufferObjects()):(Engine.Game=new Game,Engine.Game.init())}))},resize:function(e){this.width=this.baseWidth*e,this.height=this.baseHeight*e,this.wH=this.width/2,this.hH=this.height/2,this.scale=e,this.contextScale=1,this.canvas.width=this.width,this.canvas.height=this.height,this.updateScreen(),this.disableSmoothing(this.canvas),this.Assets.addAll(this.scale);var t=this;this.addLoading((function(){Engine.Game?(Engine.Game.reloadMap(),Engine.Game.rebufferObjects()):t.addSplashScreen((function(){Engine.Game=new Game,Engine.Game.init()}))}))},addSplashScreen:function(e){e=new Engine.Screens.Splash(e),this.loadingStack.push(e)},addLoading:function(e){e=new Engine.Screens.Loading(e),this.loadingStack.push(e)},checkLoadingStack:function(){var e,t,i=this.loadingStack.length,n=!0;if(0<i){for(e=0;e<i;e++)(t=this.loadingStack[e]).update(),t.draw(),t.kill&&(this.loadingStack.splice(e,1),e--,i--),t.done||(n=!1);if(!n)return!1}return!0},loop:function(){var e,t,i;this.now=e=Date.now(),this.deltaT=t=e-this.lastFrame,this.dt=i=t/(1e3/60),this.timeline+=i,60<this.timeline&&(this.timeline=0),0<Engine.Elements.inputHandlers.length&&Engine.Elements.inputHandlers[0].e.update(),this.checkLoadingStack()&&this.Game.render(i),this.fps.update(t),this.fps.draw(),this.lastFrame=e,requestAnimationFrame(this.loop.bind(this))},clearCanvas:function(e){e.ctx.clearRect(0,0,e.width,e.height)},globalVars:{states:[],capture:function(){var e,t=[];for(e in window)t.push(e);this.states.push(t)},compare:function(){this.capture();var e=this.states.length-1,t=e-1;if(!(0>t)){for(var i,n=[],s=[],a=0;a<this.states[e].length;a++){i=!1;for(var o=0;o<this.states[t].length;o++)if(this.states[t][o]===this.states[e][a]){i=!0;break}i||((o={})[i=this.states[e][a]]=window[i],n.push(i),s.push(o))}this.states.splice(0,1),0===n.length?console.log("No differences found."):(console.log(n),console.log(s))}}},marquee:{start:function(e,t){if(e.html(t),!e.hasClass("running")){e.css({overflow:"hidden",width:"100%"}),e.addClass("running"),e.wrapInner("<span>"),e.find("span").css({display:"inline-block","text-align":"center"}),e.append(e.find("span").clone()),e.wrapInner("<div>"),e.find("div").css("width",2*e.find("span").innerWidth()|0);var i=function(){$(this).css("margin-left","0%"),$(this).animate({"margin-left":-$(this).width()/2|0},4e4,"linear",i),0==$("#marquee").length&&Engine.marquee.stop(e)};i.call(e.find("div"))}},stop:function(e){e.find("div").stop(!0)}},checkServerAlive:function(e,t){if(void 0!==e.id)var i=Engine._servers[e.id];else if(void 0!==e.tag)for(i in Engine._servers)if(Engine._servers[i].tag===e.tag){i=Engine._servers[i];break}if(i){Engine.server.current=i;var n=document.createElement("script");n.src=Engine.server.protocol()+"://"+i.ip+":"+i.port+"/socket.io/socket.io.js?v="+Date.now(),n.id="socketio",n.onload=function(){document.body.removeChild(n),Engine.server.alive=1,t&&t()},n.onerror=function(){document.body.removeChild(n),Engine.server.alive=0,t&&t()},document.body.appendChild(n)}else Engine.server.alive=0,t&&t()},share:function(){$("#share").on("click",".on",(function(e){e=$(this).attr("id");var t,i=($(window).width()-800)/2,n=($(window).height()-500)/2;switch(e){case"facebook":t="https://www.facebook.com/sharer/sharer.php?u=https://play.treasurearena.com";break;case"twitter":t="https://twitter.com/share?text=Try out the HTML5 game Treasure Arena!&url=https://play.treasurearena.com";break;case"gplus":t="https://plus.google.com/share?url=https://play.treasurearena.com";break;case"patreon":t="https://patreon.com/treasurearena";break;case"discord":t="https://discord.gg/V7cDjaJqZF"}return window.open(t,"","left="+i+",top="+n+",width=800,height=500,toolbar=0,resizable=1"),!1}))},getScripts:function(e,t){$.getScript(e.shift(),e.length?function(){Engine.getScripts(e,t)}:t)},initGamepad:function(){var e=new Gamepad;this.gamepad=e,e.bind(Gamepad.Event.CONNECTED,(function(e){Engine.gamepadSupport=!0,Engine.Elements.elements.gamepad_detect.visible&&(Engine.gamepadActive=!0,Engine.Elements.remove("gamepad_detect"),Engine.Elements.elements.options.process())})),e.bind(Gamepad.Event.DISCONNECTED,(function(e){Engine.gamepadSupport=!1})),e.bind(Gamepad.Event.UNSUPPORTED,(function(e){Engine.gamepadSupport=!1})),e.init()&&Engine.bindButtons()},initFGL:function(e){var t=document.createElement("script");t.src="js/fgl.js",t.onload=function(){fgl.onReady((function(){e()}))},t.onerror=function(){console.log("Error loading FGL API."),e()},document.body.appendChild(t)},initSpil:function(e){var t=document.createElement("script");t.src="https://cdn.gameplayer.io/api/js/game.js",t.onload=function(){SpilData={id:"576742227280292150"},GameAPI.loadAPI((function(t){console.log("GameAPI version "+t.version+" loaded!"),window.apiInstance=t,e()}),SpilData)},t.onerror=function(){console.log("Error loading Spil API."),e()},document.body.appendChild(t)},initMiniclip:function(e){window.apiInstance=window.apiInstance||{Branding:{getLogo:function(){return{image:"https://play.treasurearena.com/gfx/branding/miniclip/Miniclip_com_Outline.png",action:"https://www.miniclip.com"}},getSplashScreen:function(){return{show:!1,action:"https://www.miniclip.com"}},getLink:function(){return{image:!1,action:"https://www.miniclip.com"}}}},Engine.initCPMStar(e)},startAds:function(){Engine.audio.music&&Engine.audio.mute("music"),Engine.socket.emit("startAds",{branding:Engine.branding})},stopAds:function(){Engine.audio.music&&Engine.audio.unmute("music"),Engine.socket.emit("stopAds")},GameBreak:function(e,t){e(),setTimeout(t,3e3)},initKongregate:function(e){if(this.checkSource(),this.checkPatreon(),this.checkBranding(),self!=top||this.branding)if(this.branding)switch(this.branding){case"a10":this.initSpil(e);break;case"miniclip":this.initMiniclip(e);break;case"fgl":this.initFGL(e);break;case"clay":this.initClay(e);break;case"leadbolt":this.initLeadbolt(e);break;case"h5":this.initH5(e);break;case"cpmstar":case"cpmstarpreroll":this.initCPMStar(e)}else if(-1!==document.referrer.indexOf("gamejolt"))Engine.ads.show=!1,Engine.ads.preroll=!1,this.initCPMStar(e);else if(-1!==document.referrer.indexOf("kongregate")){Engine.ads.show=!1,Engine.ads.preroll=!1;var t=document.createElement("script");t.src="https://www.kongregate.com/javascripts/kongregate_api.js",t.onload=function(){kongregateAPI.loadAPI((function(){Engine.kongregate=!0,kongregate=kongregateAPI.getAPI(),e()}))},t.onerror=function(){this.initCPMStar(e)},document.body.appendChild(t)}else this.initCPMStar(e);else this.initCPMStar(e)},initLeadbolt:function(e){Engine.branding="leadbolt",e()},initLeadboltAd:function(){Engine.startAds();var e=document.createElement("script");e.src="https://ad.leadboltmobile.net/show_app_ad.js?section_id=810499515",e.onload=function(){console.log("Leadbolt ad loaded.")},e.onerror=function(){console.log("Error loading Leadbolt ad."),Engine.stopAds()},$("#overlay").append('<div id="ad_leadbolt"></div>'),document.getElementById("ad_leadbolt").appendChild(e),setTimeout((function(){$("#ad_leadbolt").remove(),Engine.stopAds()}),1e4)},initH5:function(e){Engine.branding="h5",e()},initMidrollAd:function(){if(!(Engine.getPatreonTier()>=1)&&Engine.branding)switch(Engine.branding){case"fgl":Engine.startAds(),fgl.showAd(),setTimeout((function(){fgl.adOverlay&&($(fgl.adOverlay).remove(),fgl.adOverlay=null),Engine.stopAds()}),5e3);break;case"clay":Engine.startAds(),Engine.initPreroll((function(){Engine.stopAds()}));break;case"cpmstarpreroll":Engine.initCPMStarAdPreroll();break;default:Engine.initRandomMidrollAd()}},initRandomMidrollAd:function(){Math.round(100*Math.random())<0?this.initH5Ad():this.initCPMStarAd()},initH5Ad:function(){Engine.Elements.append("ad_h5"),setTimeout((function(){Engine.Elements.remove("ad_h5")}),1e4)},initCPMStar:function(e){Engine.branding||(Engine.branding="cpmstar"),$("#screen").append('<div id="cpmstar_wrapper" style="position: absolute; width: 100%; height: 100%; z-index: 9999; display: none;"></div>'),$("body").append('<div id="cpmstar_preroll_wrapper" style="position: absolute; width: 100%; height: 100%; z-index: 9999; display: none;"></div>'),e()},initCPMStarAd:function(){Engine.Elements.append("ad_cpmstar"),setTimeout((function(){Engine.Elements.remove("ad_cpmstar")}),1e4)},initCPMStarAdPreroll:function(){Engine.Elements.append("ad_cpmstar_preroll"),setTimeout((function(){Engine.Elements.remove("ad_cpmstar_preroll")}),3e4)},initClay:function(e){Engine.branding="clay",Clay=window.Clay||{},Clay.gameKey="treasurearena",Clay.options={debug:!1,fail:function(){Engine.ads.show=!1,Engine.ads.preroll=!1,e()}},Clay.readyFunctions=[],Clay.ready=function(e){Clay.readyFunctions.push(e)},Clay.loadFunctions=[],Clay.load=function(e){Clay.loadFunctions.push(e)};var t=document.createElement("script");t.async=!0,t.src=Engine.server.protocol()+"://clay.io/api/api-ads.js";var i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(t,i),Clay.load((function(){console.log("Clay.io API loaded."),Engine.ads.preroll?Engine.initPreroll(e):e()}))},initPreroll:function(e){Engine.ads.started=Date.now(),Engine.ads.finished=!1;try{preroll=new Clay.Advertisement({size:"preroll",allowSkip:!1,duration:1e4,onSkipStart:function(){},onHide:function(){clearInterval(t),Engine.ads.finished=!0,e()}})}catch(t){Engine.ads.finished=!0,e()}$(".clay-load-bar-text").html("Loading..."),$(".clay-preroller").after('<div id="ad_info">This ad directly supports Treasure Arena,<br />and keeps it free to play.</div>');var t=setInterval((function(){var e=1e4-(Date.now()-Engine.ads.started),i=(e=Math.ceil(e/1e3),$(".clay-preroller").offset().top+$(".clay-preroller").height());$("#ad_info").css("top",i),0>=e&&(Engine.ads.finished=!0,clearInterval(t))}),500)},checkVersionUpdate:function(){$.ajax({url:this.isNodeWebkit?Engine.updateServer+"/version.json":"version.json",dataType:"json",cache:!1,success:function(e){},async:!1});var e=this.getCookie("version");return e&&e!=this.versionVisible&&!Engine.viewedChangelog&&Engine.Elements.append("changelog"),this.setCookie("version",this.versionVisible,100),!0},checkSource:function(){Engine.source=this.getURLParameter("utm_source"),"itchio"!==Engine.source&&"gamejolt"!==Engine.source||void 0!==$.browser.mozilla||(Engine.patreonEnabled=!1)},checkBranding:function(){var e=this.getURLParameter("ref");e&&-1!=this.brandingsAvailable.indexOf(e)&&(this.branding=e)},checkPatreon:function(){var e=this.getURLParameter("code");null!==e&&Engine.setCookie("patreon-code",e,1)},init:function(){this.detectBrowser(),this.isNodeWebkit&&(NW=new NW,NW.init()),this.createOverlay(),this.Elements.init(),this.browser.supported?(this.createCanvas(),this.updateScreen(),this.audio.init(),this.bindEvents(),this.bindKeys(),this.loadSettings(),this.loop()):Engine.Elements.append("unsupported")}};window.onload=function(){Engine.initKongregate((function(){Engine.init()}))},Engine.bindEvents=function(){try{history.navigationMode="compatible"}catch(e){}window.addEventListener("focus",(function(){Engine.idle=!1}),!1),window.addEventListener("blur",(function(){Engine.idle=!0}),!1),window.oncontextmenu=function(e){return e.preventDefault(),e.stopPropagation(),!1},window.addEventListener("resize",(function(){Engine.updateScreen()}),!1),document.addEventListener("fullscreenchange",(function(e){Engine.fullscreenCheck()}),!1),document.addEventListener("mozfullscreenchange",(function(e){Engine.fullscreenCheck()}),!1),document.addEventListener("webkitfullscreenchange",(function(e){Engine.fullscreenCheck()}),!1),$("#screen").on("mousedown",".button, .arrow_left, .arrow_right, .empty, .bot .name, .map",(function(e){Engine.audio.play("click")}))},Engine.screen=document.getElementById("screen"),Engine.bindButtons=function(){var e=Engine.gamepad;e.bind(Gamepad.Event.BUTTON_DOWN,(function(e){Engine.gamepadSupport&&!Engine.gamepadActive&&(Engine.gamepadActive=!0),Engine.gamepadActive&&(0===e.mapping&&(Engine.keys.JUMP=!0),1===e.mapping&&(Engine.keys.B=!0),2===e.mapping&&(Engine.keys.X=!0),3===e.mapping&&(Engine.keys.Y=!0),7===e.mapping&&(Engine.keys.JUMP=!0),2===e.mapping&&(Engine.keys.SKILL1=!0),6===e.mapping&&(Engine.keys.BLOCK=!0),8===e.mapping&&(Engine.keys.BACK=!0),9===e.mapping&&(Engine.keys.START=!0),4===e.mapping&&(Engine.keys.WHEEL=-1),5===e.mapping&&(Engine.keys.WHEEL=1))})),e.bind(Gamepad.Event.BUTTON_UP,(function(e){Engine.gamepadActive&&(0===e.mapping&&(Engine.keys.JUMP=!1),1===e.mapping&&(Engine.keys.B=!1),2===e.mapping&&(Engine.keys.X=!1),3===e.mapping&&(Engine.keys.Y=!1),7===e.mapping&&(Engine.keys.JUMP=!1),2===e.mapping&&(Engine.keys.SKILL1=!1),6===e.mapping&&(Engine.keys.BLOCK=!1),8===e.mapping&&(Engine.keys.BACK=!1),9===e.mapping&&(Engine.keys.START=!1))})),e.bind(Gamepad.Event.AXIS_CHANGED,(function(e){Engine.gamepadActive&&(0===e.mapping&&(.3<e.value?(Engine.keys.RIGHT=!0,Engine.keys.LEFT=!1):(Engine.keys.LEFT=-.3>e.value,Engine.keys.RIGHT=!1)),1===e.mapping&&(.3<e.value?(Engine.keys.DOWN=!0,Engine.keys.UP=!1):(Engine.keys.UP=-.3>e.value,Engine.keys.DOWN=!1)),2===e.mapping&&(Engine.keys.MOUSEPOS.x=Engine.wH+.4*Engine.wH/100*100*e.value,Engine.keys.STICK.x=e.value),3===e.mapping&&(Engine.keys.MOUSEPOS.y=Engine.hH+.4*Engine.hH/100*100*e.value,Engine.keys.STICK.y=e.value),(0<Engine.keys.STICK.x&&.6<Engine.keys.STICK.x||0>Engine.keys.STICK.x&&-.6>Engine.keys.STICK.x||0<Engine.keys.STICK.y&&.6<Engine.keys.STICK.y||0>Engine.keys.STICK.y&&-.6>Engine.keys.STICK.y)&&(Engine.keys.SHOOT=!0),-.6<Engine.keys.STICK.x&&.6>Engine.keys.STICK.x&&-.6<Engine.keys.STICK.y&&.6>Engine.keys.STICK.y&&(Engine.keys.SHOOT=!1,Engine.keys.FIRE=!1),e=Math.max(Math.abs(Engine.keys.STICK.x),Math.abs(Engine.keys.STICK.y)),Engine.keys.STICKDISTANCE=Math.min(1,Math.max(0,1/.6*e-.3)))}))},Engine.bindKeys=function(){document.getElementById("overlay").onmousedown=function(e){e=e||window.e;var t=Engine.screen;0==e.button&&(Engine.keys.SHOOT=!0),2==e.button&&(Engine.keys.BLOCK=!0),Engine.keys.MOUSEPOS.x=(e.pageX-t.offsetLeft)/Engine.fullscreenScale/Engine.contextScale|0,Engine.keys.MOUSEPOS.y=(e.pageY-t.offsetTop)/Engine.fullscreenScale/Engine.contextScale|0},document.getElementById("overlay").onmousemove=function(e){if(!Engine.gamepadActive){e=e||window.e;var t=Engine.screen;Engine.keys.MOUSEPOS.x=(e.pageX-t.offsetLeft)/Engine.fullscreenScale/Engine.contextScale|0,Engine.keys.MOUSEPOS.y=(e.pageY-t.offsetTop)/Engine.fullscreenScale/Engine.contextScale|0}},document.getElementById("overlay").onmouseup=function(e){(e=e||window.e).preventDefault(),0==e.button&&(Engine.keys.SHOOT=!1,Engine.keys.FIRE=!1),2==e.button&&(Engine.keys.BLOCK=!1)},document.addEventListener("keydown",(function(e){var t=(e=e||window.e).keyCode;if(8===t&&!$(":input").is(":focus"))return e.preventDefault(),!1;13===t&&Engine.Elements.elements.console.visible&&(0<$("#consoleInput").val().length&&void 0!==Engine.socket&&Engine.socket.emit("console",$("#consoleInput").val()),$("#consoleInput").val(""),$("#chatInput").length)||(Engine.branding&&!Engine.allowChat[Engine.branding]||13!==t||!$("#chatInput").length||($("#chatInput").is(":focus")?($("#chatInput").blur(),0<$("#chatInput").val().length&&(Engine.socket.emit("chat",$("#chatInput").val()),$("#chatInput").val("")),$("#chatInputNote").show()):($("#chatInput").focus(),$("#chatInputNote").hide())),(2!=Engine.state&&$(":input").is(":focus")||$("#chatInput").is(":focus")||Engine.Elements.elements.console.visible)&&"consoleInput"!=$(this).attr("id")&&109!=t||(87!=t&&38!=t&&90!=t||(e.preventDefault(),Engine.keys.UP=!0),83!=t&&40!=t||(e.preventDefault(),Engine.keys.DOWN=!0),65!=t&&37!=t&&81!=t||(e.preventDefault(),Engine.keys.LEFT=!0),68!=t&&39!=t||(e.preventDefault(),Engine.keys.RIGHT=!0),79==t&&(e.preventDefault(),Engine.Elements.toggle("options")),16!=t&&69!=t||(e.preventDefault(),Engine.keys.SKILL1=!0),49==t&&(e.preventDefault(),Engine.keys.WEAPON=1),50==t&&(e.preventDefault(),Engine.keys.WEAPON=2),51==t&&(e.preventDefault(),Engine.keys.WEAPON=3),52==t&&(e.preventDefault(),Engine.keys.WEAPON=4),53==t&&(e.preventDefault(),Engine.keys.WEAPON=5),54==t&&(e.preventDefault(),Engine.keys.WEAPON=6),32==t&&(e.preventDefault(),Engine.keys.JUMP=!0),107==t&&(e.preventDefault(),Engine.keys.CAMNEXT=!0),70==t&&(e.preventDefault(),Engine.keys.SCREENSHOT=!0),109==t&&(e.preventDefault(),Engine.Elements.toggle("console")),106==t&&"a10"==Engine.branding&&(console.log("GameBreak"),GameAPI.GameBreak.request(Engine.startAds,Engine.stopAds))))}),!1),document.addEventListener("keyup",(function(e){if(!(2!=Engine.state&&$(":input").is(":focus")||$("#chatInput").is(":focus"))){var t=(e=e||window.e).keyCode;87!=t&&38!=t&&90!=t||(Engine.keys.UP=!1),83!=t&&40!=t||(Engine.keys.DOWN=!1),65!=t&&37!=t&&81!=t||(Engine.keys.LEFT=!1),68!=t&&39!=t||(Engine.keys.RIGHT=!1),16!=t&&69!=t||(Engine.keys.SKILL1=!1),49!=t&&50!=t&&51!=t&&52!=t&&53!=t&&54!=t||(e.preventDefault(),Engine.keys.WEAPON=!1),32==t&&(Engine.keys.JUMP=!1),107==t&&(e.preventDefault(),Engine.keys.CAMNEXT=!1),70==t&&(e.preventDefault(),Engine.keys.SCREENSHOT=!1)}}),!1),document.addEventListener("mousewheel",(function(e){return e=e||window.e,e=-1*Math.max(-1,Math.min(1,e.wheelDelta||-e.detail)),Engine.keys.WHEEL=e,!1}),!1),document.addEventListener("DOMMouseScroll",(function(e){return e.preventDefault(),e=e||window.e,e=-1*Math.max(-1,Math.min(1,e.wheelDelta||-e.detail)),Engine.keys.WHEEL=e,!1}),!1)},Engine.Assets={data:_assets,filePath:"assets",fileExt:".png",fileVersion:"?v="+Engine.version,tileSize:0,sprites:{},tilesets:{},fonts:{},add:function(e,t,i){var n=this,s=this.data[e][t],a=null;i=i||1;var o,r=new Image;r.src=this.filePath+"/"+e+"/"+s.file+this.fileExt+this.fileVersion,r.id=t,r.loaded=!1,r.fw=s.fw,r.fh=s.fh,r.scale=i,this[e][t]?(o=!0,n[e][t].loaded=!1):(o=!1,this[e][t]=r),r.onload=function(){this.fw=this.fw||this.width,this.fh=this.fh||this.height,o?a=n[e][t]:(a=document.createElement("canvas")).ctx=a.getContext("2d",{willReadFrequently:!0}),a.width=this.width,a.height=this.height,Engine.disableSmoothing(a),a.fw=this.fw,a.fh=this.fh,a.scale=this.scale,a.ctx.drawImage(this,0,0),1<this.scale&&n.resize(a,this.scale),a.loaded=!0,n[e][t]=a,"tilesets"===e&&(n.tileSize=a.fw)}},bufferDayTime:function(e){var t,i=this.tilesets[0];i.loaded=!1;var n,s,a,o=[-5,-22,-27,-17,-30,-15,0],r=[-5,-22,-37,-47,-30,-15,0],l=[-5,-15,-22,-22,-20,-10,-5],h=i.ctx.getImageData(0,0,i.width,i.height);for((t=document.createElement("canvas")).ctx=t.getContext("2d"),t.width=i.width,t.height=i.height,Engine.disableSmoothing(t),n=t.ctx.createImageData(i.width,i.height),a=h.data.length,s=0;s<a;s++)n.data[s]=h.data[s];for(a=n.data.length,s=0;s<a;s+=4)n.data[s]+=o[e],0>n.data[s]&&(n.data[s]=0),n.data[s+1]+=r[e],0>n.data[s+1]&&(n.data[s]=0),n.data[s+2]+=l[e],0>n.data[s+2]&&(n.data[s]=0);t.ctx.putImageData(n,0,0),i.dayTime=t,i.loaded=!0},addAll:function(e){for(var t in this.data)for(var i in this.data[t])this.add(t,i,Engine.scale)},resize:function(e,t){var i,n,s,a,o=e.ctx.getImageData(0,0,e.width,e.height),r=e.width*t,l=e.height*t,h=o.data,c=o.width,d=o.height,g=(o=this.createImageData(r,l)).data,u=c/r,p=(d=d/l,0);for(s=0;s<l;s+=1)for(a=(s*d|0)*c,n=0;n<r;n+=1)i=a+n*u<<2,g[p]=h[i],g[p+1]=h[i+1],g[p+2]=h[i+2],g[p+3]=h[i+3],p+=4;e.width=r,e.height=l,Engine.disableSmoothing(e),e.fw*=t,e.fh*=t,e.ctx.putImageData(o,0,0)},initSampleCanvas:function(){var e=document.createElement("canvas");e.ctx=e.getContext("2d"),e.width=0,e.height=0,Engine.disableSmoothing(e),createImageData=e.ctx.createImageData?function(t,i){return e.ctx.createImageData(t,i)}:function(e,t){return new ImageData(e,t)}},createImageData:function(e,t){return this.initSampleCanvas(),createImageData(e,t)}},Engine.Screens={Transition:function(e){var t=null,i=0;e=e||!1;var n=!1;this.kill=this.done=!1,this.init=function(){i=Engine.now,(t=document.createElement("canvas")).id="loading",t.width=Engine.canvas.width,t.height=Engine.canvas.height,t.ctx=t.getContext("2d",{willReadFrequently:!0}),Engine.disableSmoothing(t),$("#overlay").append(t)},this.update=function(){250<Engine.now-i&&!n&&(this.done=n=!0,e&&e()),500<Engine.now-i&&(this.kill=!0,$("#loading").remove())},this.draw=function(){Engine.clearCanvas(t);var e=t.ctx;e.save(),e.fillStyle="#000",e.fillRect(t.width-2*t.width/500*(Engine.now-i),0,t.width,t.height),e.restore()},this.init()},Loading:function(e){var t=0,i=0,n="";this.kill=!1,this.preload=!0;var s=function(e){var i,n=[];for(i in Engine.Assets[e])n.push(Engine.Assets[e][i]);return t+=n.length,n};this.update=function(){this.preload&&(this.preload=!1,Engine.branding&&Engine.Elements.append("loading")),t=0;var a,o=[];for(a in Engine.Elements.elements)o.push(Engine.Elements.elements[a]);t+=o.length,a=s("fonts");var r,l=s("sprites"),h=s("tilesets"),c=[];for(r in _audio)c.push(_audio[r]);for(var d in t+=c.length,i=0,o={"UI Elements":o,Fonts:a,Sprites:l,Tilesets:h,Audio:c})for(r=o[d],n=d,a=0;a<r.length;a++){if(!r[a].loaded)return;i++}t!=i||this.done||Engine.ads.show&&!Engine.ads.finished||(e&&!this.kill&&(Engine.branding&&Engine.Elements.remove("loading"),e()),this.kill=!0)},this.draw=function(){if(!this.kill){Engine.clearCanvas(Engine.canvas);var e,s,a,o,r,l=Engine.canvas.ctx;l.save(),l.fillStyle="#333",e=Engine.width/2|0,s=Engine.height/10|0,a=(Engine.width-e)/2|0,o=(Engine.height-s)/2|0,l.fillRect(a,o,e,s),l.fillStyle="#ccc",r=Math.round(i/t*100),l.fillRect(a,o,e/100*r|0,s),l.globalAlpha=.5,Engine.text("visitorBlack",(100/t*i|0)+"%",Engine.wH,Engine.hH-Engine.Assets.fonts.visitorBlack.fh/2+Engine.scale,!0),l.globalAlpha=1,Engine.text("miniset2","Loading "+n+"...",Engine.wH,Engine.hH+3*Engine.Assets.fonts.miniset2.fh+Engine.scale,!0),l.restore(),Engine.loaded=r}}},Splash:function(e){this.kill=!1;var t=Date.now()+3e3,i=!1;this.update=function(){Engine.branding&&Engine.brandingCustom[Engine.branding]&&Engine.splashscreenCustom[Engine.branding]?(i||(Engine.Elements.append("splash_"+Engine.branding),i=!0),Engine.now>t&&(Engine.Elements.remove("splash_"+Engine.branding),i=!1,e&&!this.kill&&e(),this.kill||(this.kill=!0))):(e&&!this.kill&&e(),this.kill||(this.kill=!0))},this.draw=function(){}},Title:function(){var e=0,t=0,i=0,n=!0,s=10,a=[],o=0;this.update=function(r){60==++o&&(o=0);var l=Engine.Assets.sprites.tile_wall;(e-=.25*Engine.scale*r)<-l.width&&(e=0),l=Engine.Assets.sprites.skyline,(t-=.4*Engine.scale*r)<-l.width&&(t=0);var h,c=a.length;for(l=0;l<c;l++)(h=a[l]).update(r),h.kill&&(a.splice(l,1),l--,c--);for(c=130-a.length,l=0;l<c;l++)h=new Engine.FX.Spark,130==c&&(h.data.x=Engine.rand(0,Engine.width),h.data.y=Engine.rand(0,Engine.height)),h.init(),a.push(h);0<s&&(s-=r),0>=s&&(120>i&&n&&(120<=(i+=5*r)&&(i=120,n=!1)),100<i&&!n&&(100>(i-=5*r)&&(i=100)))},this.draw=function(){var n,s,o,r,l,h,c,d=Engine.canvas.ctx;for(d.fillStyle="#000",d.fillRect(0,0,Engine.width,Engine.height),d.save(),d.globalAlpha=.8,n=Engine.Assets.sprites.tile_wall,s=0|e,o=0,d.drawImage(n,s,o),s+n.width<Engine.width&&d.drawImage(n,s+n.width,o),d.restore(),d.save(),n=Engine.Assets.sprites.skyline,s=0|t,o=Engine.height-n.fh|0,d.drawImage(n,s,o),s+n.width<Engine.width&&d.drawImage(n,s+n.width,o),d.restore(),n=Engine.Assets.sprites.frame,d.drawImage(n,0,0),s=a.length,n=0;n<s;n++)(o=a[n]).draw();n=Engine.Assets.sprites.anniversary2,s=(Engine.width-n.fw)/2|0,o=10*Engine.scale|0,r=n.fw,l=n.fh,h=r/100*i|0,c=l/100*i|0,d.drawImage(n,0,0,r,l,s-r/2+(r-h/2)|0,o-l/2+(l-c/2)|0,h,c)}},Menu:function(){var e=0,t=0,i=[];this.update=function(n){var s=Engine.Assets.sprites.tile_wall;(e-=.25*Engine.scale*n)<-s.width&&(e=0),s=Engine.Assets.sprites.skyline,(t-=.4*Engine.scale*n)<-s.width&&(t=0);var a,o=i.length;for(s=0;s<o;s++)(a=i[s]).update(n),a.kill&&(i.splice(s,1),s--,o--);for(o=130-i.length,s=0;s<o;s++)n=new Engine.FX.Spark,130==o&&(n.data.x=Engine.rand(0,Engine.width),n.data.y=Engine.rand(0,Engine.height)),n.init(),i.push(n)},this.draw=function(){var n,s,a,o=Engine.canvas.ctx;for(o.fillStyle="#000",o.fillRect(0,0,Engine.width,Engine.height),o.save(),o.globalAlpha=.8,o.globalCompositeOperation="lighter",n=Engine.Assets.sprites.tile_wall,s=0|e,a=0,o.drawImage(n,s,a),s+n.width<Engine.width&&o.drawImage(n,s+n.width,a),o.restore(),o.save(),n=Engine.Assets.sprites.skyline,s=0|t,a=Engine.height-n.fh|0,o.drawImage(n,s,a),s+n.width<Engine.width&&o.drawImage(n,s+n.width,a),o.restore(),n=Engine.Assets.sprites.frame,o.drawImage(n,0,0),s=i.length,n=0;n<s;n++)(a=i[n]).draw()}}},Engine.h5={mute:function(){},unmute:function(){}},Engine.audio={init:function(){this.tryWebAudio()},tryWebAudio:function(){try{Engine.webaudioAPI.ctx=new window.AudioContext,Engine.audio=Engine.webaudioAPI,Engine.webaudio=!0}catch(e){Engine.audio=Engine.sm2}Engine.audio.init()}},Engine.webaudioAPI={data:{},ctx:null,sound:!0,music:!0,volume:{sound:75,music:75},volumeSoundChange:function(e){this.volume.sound=e,this.sound&&(this.buses.sound.gain.value=e/100)},volumeMusicChange:function(e){this.volume.music=e,this.music&&(this.buses.music.gain.value=e/100)},init:function(){this.loadAudioResources(),this.setupMainOutput()},loadAudioResources:function(){var e,t,i,n=this;Object.keys(_audio).forEach((function(s){Engine.LoadMusicOnDemand&&"music"===_audio[s].type?(_audio[s].loaded=!0,n.data[s]=_audio[s]):(e=_audio[s].format||"ogg",t="sound/"+e+"/",i="."+e+"?v="+Engine.version,n.util.ajaxAudioRequest(t+_audio[s].file+i,(function(e){n.ctx.decodeAudioData?n.ctx.decodeAudioData(e.response,(function(e){_audio[s].buffer=e,_audio[s].loaded=!0,n.data[s]=_audio[s]}),(function(e){console.error("Audio Decoding Error: ",t+_audio[s].file+i,e)})):_audio[s].buffer=n.ctx.decodeAudioData(e.response,(function(e){_audio[s].loaded=!0,n.data[s]=_audio[s]}),(function(){console.log("Decoding the audio buffer for "+s+" failed")}))})))}))},loadAudioResourceLate:function(e){var t,i,n,s=this;t=_audio[e].format||"ogg",i="sound/"+t+"/",n="."+t+"?v="+Engine.version,s.util.ajaxAudioRequest(i+_audio[e].file+n,(function(t){s.ctx.decodeAudioData?s.ctx.decodeAudioData(t.response,(function(t){_audio[e].buffer=t,_audio[e].loaded=!0,s.data[e]=_audio[e],s.play(e)}),(function(t){console.error("Audio Decoding Error: ",i+_audio[e].file+n,t)})):_audio[e].buffer=s.ctx.decodeAudioData(t.response,(function(t){_audio[e].loaded=!0,s.data[e]=_audio[e],s.play(e)}),(function(){console.log("Decoding the audio buffer for "+e+" failed")}))}))},loadAudioStream:function(e){var t,i,n=this;i="sound/"+(t=_audio[e].format||"ogg")+"/",t="."+t+"?v="+Engine.version;var s=new Audio;s.src=i+_audio[e].file+t,s.id=e,s.autoplay=!0,this.data[e].loop&&(s.loop=!0),s.stop=function(){this.pause(),delete Engine.audio.data[this.id].source},n.data[e]=_audio[e],this.data[e].source=s,this.data[e].source.playbackState=2,s.addEventListener("canplaythrough",(function(){n.playAudioStream(s,e)}),!1)},playAudioStream:function(e,t){var i=this.ctx.createMediaElementSource(e),n=this.buses[this.data[t].type],s=this.ctx.createGain();i.connect(s),s.connect(n),this.data[t].hasOwnProperty("volume")?s.gain.value=.01*this.data[t].volume:s.gain.value=1},util:{ajaxAudioRequest:function(e,t){var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(){t(i)},i.onerror=function(){console.error("Audio XHR Error: "+e)},i.send()}},setupMainOutput:function(){var e=this.ctx.createDynamicsCompressor();e.threshold.value=-10,e.knee.value=20,e.ratio.value=14,e.attack.value=.003,e.release.value=.25,e.connect(this.ctx.destination),this.buses.sound=this.ctx.createGain(),this.buses.sound.connect(e),this.buses.sound.gain.value=this.volume.sound/100,this.buses.biquad=this.ctx.createBiquadFilter(),this.buses.biquad.connect(e),this.buses.biquad.frequency.value=22050,this.buses.music=this.ctx.createGain(),this.buses.music.connect(this.buses.biquad),this.buses.music.gain.value=this.volume.music/100},buses:{sound:null,music:null},playBuffer:function(e){var t=this.data[e].buffer,i=this.ctx.createBufferSource(),n=this.buses[this.data[e].type];i.isPlaying=!0,i.onended=function(){this.isPlaying=!1},i.buffer=t,this.data[e].loop&&(i.loop=!0),t=this.ctx.createGain(),i.connect(t),t.connect(n),this.data[e].hasOwnProperty("volume")?t.gain.value=.01*this.data[e].volume:t.gain.value=1,this.data[e].source=i,i.start(0)},play:function(e){this.data[e]&&(Engine.LoadMusicOnDemand&&"music"===this.data[e].type&&!this.data[e].buffer?Engine.StreamMusic?this.loadAudioStream(e):this.loadAudioResourceLate(e):this.playBuffer(e))},speed:function(e,t){this.data[e]&&(this.data[e].source.playbackRate.value=t)},stop:function(e){this.data[e]&&(this.isPlaying(e)&&this.data[e].source.stop(0),Engine.LoadMusicOnDemand&&!Engine.StreamMusic&&"music"===this.data[e].type&&(delete this.data[e].buffer,delete this.data[e].source))},mute:function(e){this.buses[e].gain.value=0,Engine.h5.mute()},unmute:function(e){this.buses[e].gain.value=this.volume[e]/100,Engine.h5.unmute()},isPlaying:function(e){return!!(this.data[e]&&this.data[e].source&&this.data[e].source.isPlaying)}},Engine.webaudioAPIdeprecated={data:{},ctx:null,sound:!0,music:!0,volume:{sound:75,music:75},volumeSoundChange:function(e){this.volume.sound=e,this.sound&&(this.buses.sound.gain.value=e/100)},volumeMusicChange:function(e){this.volume.music=e,this.music&&(this.buses.music.gain.value=e/100)},init:function(){this.loadAudioResources(),this.setupMainOutput()},loadAudioResources:function(){var e,t,i,n=this;Object.keys(_audio).forEach((function(s){Engine.LoadMusicOnDemand&&"music"===_audio[s].type?(_audio[s].loaded=!0,n.data[s]=_audio[s]):(e=_audio[s].format||"ogg",t="sound/"+e+"/",i="."+e+"?v="+Engine.version,n.util.ajaxAudioRequest(t+_audio[s].file+i,(function(e){n.ctx.decodeAudioData?n.ctx.decodeAudioData(e.response,(function(e){_audio[s].buffer=e,_audio[s].loaded=!0,n.data[s]=_audio[s]}),(function(e){console.error("Audio Decoding Error: ",t+_audio[s].file+i,e)})):(_audio[s].buffer=n.ctx.createBuffer(e.response,!1),_audio[s].loaded=!0,n.data[s]=_audio[s])})))}))},loadAudioResourceLate:function(e){var t,i,n,s=this;t=_audio[e].format||"ogg",i="sound/"+t+"/",n="."+t+"?v="+Engine.version,s.util.ajaxAudioRequest(i+_audio[e].file+n,(function(t){s.ctx.decodeAudioData?s.ctx.decodeAudioData(t.response,(function(t){_audio[e].buffer=t,_audio[e].loaded=!0,s.data[e]=_audio[e],s.play(e)}),(function(t){console.error("Audio Decoding Error: ",i+_audio[e].file+n,t)})):(_audio[e].buffer=s.ctx.createBuffer(t.response,!1),_audio[e].loaded=!0,s.data[e]=_audio[e],s.play(e))}))},loadAudioStream:function(e){var t,i,n=this;i="sound/"+(t=_audio[e].format||"ogg")+"/",t="."+t+"?v="+Engine.version;var s=new Audio;s.src=i+_audio[e].file+t,s.id=e,s.autoplay=!0,this.data[e].loop&&(s.loop=!0),s.noteOff=function(){this.pause(),delete Engine.audio.data[this.id].source},n.data[e]=_audio[e],this.data[e].source=s,this.data[e].source.playbackState=2,s.addEventListener("canplaythrough",(function(){n.playAudioStream(s,e)}),!1)},playAudioStream:function(e,t){var i=this.ctx.createMediaElementSource(e),n=this.buses[this.data[t].type],s=this.ctx.createGainNode();i.connect(s),s.connect(n),this.data[t].hasOwnProperty("volume")?s.gain.value=.01*this.data[t].volume:s.gain.value=1},util:{ajaxAudioRequest:function(e,t){var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(){t(i)},i.onerror=function(){console.error("Audio XHR Error: "+e)},i.send()}},setupMainOutput:function(){var e=this.ctx.createDynamicsCompressor();e.threshold.value=-10,e.knee.value=20,e.ratio.value=14,e.attack.value=.003,e.release.value=.25,e.connect(this.ctx.destination),this.buses.sound=this.ctx.createGainNode(),this.buses.sound.connect(e),this.buses.sound.gain.value=this.volume.sound/100,this.buses.biquad=this.ctx.createBiquadFilter(),this.buses.biquad.connect(e),this.buses.biquad.frequency.value=22050,this.buses.music=this.ctx.createGainNode(),this.buses.music.connect(this.buses.biquad),this.buses.music.gain.value=this.volume.music/100},buses:{sound:null,music:null},playBuffer:function(e){var t=this.data[e].buffer,i=this.ctx.createBufferSource(),n=this.buses[this.data[e].type];i.buffer=t,this.data[e].loop&&(i.loop=!0),t=this.ctx.createGainNode(),i.connect(t),t.connect(n),this.data[e].hasOwnProperty("volume")?t.gain.value=.01*this.data[e].volume:t.gain.value=1,this.data[e].source=i,i.noteOn(0)},play:function(e){this.data[e]&&(Engine.LoadMusicOnDemand&&"music"===this.data[e].type&&!this.data[e].buffer?Engine.StreamMusic?this.loadAudioStream(e):this.loadAudioResourceLate(e):this.playBuffer(e))},speed:function(e,t){this.data[e]&&(this.data[e].source.playbackRate.value=t)},stop:function(e){this.data[e]&&(this.isPlaying(e)&&this.data[e].source.noteOff(0),Engine.LoadMusicOnDemand&&!Engine.StreamMusic&&"music"===this.data[e].type&&(delete this.data[e].buffer,delete this.data[e].source))},mute:function(e){this.buses[e].gain.value=0,Engine.h5.mute()},unmute:function(e){this.buses[e].gain.value=this.volume[e]/100,Engine.h5.unmute()},isPlaying:function(e){return!(!this.data[e]||!this.data[e].source||2!==this.data[e].source.playbackState)}},Engine.sm2={data:{},sound:!0,music:!0,volume:{sound:75,music:75},volumeSoundChange:function(e){var t;for(t in this.volume.sound=e,Engine.audio.data)"sound"===Engine.audio.data[t].type&&Engine.audio.data[t].setVolume(e/100*(_audio[t].volume||100))},volumeMusicChange:function(e){for(i in this.volume.music=e,Engine.audio.data)soundFile=Engine.audio.data[i],"music"===soundFile.type&&Engine.audio.data[i].setVolume(e/100*(_audio[i].volume||100))},init:function(){window.soundManager=new SoundManager,soundManager.setup({url:"swf/",flashVersion:9,preferFlash:!0,useHTML5Audio:!0,useHighPerformance:!0,onready:function(){Engine.audio.createData()},defaultOptions:{autoLoad:!1,stream:!0,multiShot:!0,multiShotEvents:!0,multiEvents:!0,volume:100}})},createData:function(){var e,t,i,n;for(e in _audio)i="sound/"+(n=(t=_audio[e]).format||"mp3")+"/",n="."+n+"?v="+Engine.version,(i=soundManager.createSound({id:e,url:i+t.file+n,volume:t.volume?Engine.audio.volume[t.type]/100*t.volume:Engine.audio.volume[t.type]})).type=t.type,i.loop=t.loop,_audio[e].loaded=!0,Engine.audio.data[e]=i,Engine.audio[i.type]||i.mute()},play:function(e,t){Engine.audio.data[e]&&(Engine.audio.data[e].loop?this.loop(e):Engine.audio.data[e].play(t))},loop:function(e){Engine.audio.data[e].play({onfinish:function(){Engine.audio.loop(e)}})},stop:function(e){Engine.audio.data[e]&&Engine.audio.data[e].stop()},isPlaying:function(e){return!(!Engine.audio.data[e]||0===Engine.audio.data[e].playState)},mute:function(e){var t;for(t in Engine.audio.data)Engine.audio.data[t].type==e&&Engine.audio.data[t].mute();Engine.h5.mute()},unmute:function(e){var t;for(t in Engine.audio.data)Engine.audio.data[t].type==e&&Engine.audio.data[t].unmute();Engine.h5.unmute()}},Engine.Elements={filePath:"elements",fileExt:".html",version:"?v="+Engine.version,inputHandlers:[],init:function(){var e,t=this;for(e in this.elements)t.elements[e].loaded=!1;for(e in this.elements)!1===t.elements[e].autoLoad?t.elements[e].loaded=!0:$.ajax({url:this.filePath+"/"+e+this.fileExt+this.version,dataType:"html",success:function(i){t.elements[e].loaded=!0,t.elements[e].DOM=i},async:!1})},updateDOM:function(e,t,i){if("right"===i)(i=$($("#"+e+" .selectable")[t.cursorPos+1])).hasClass("selectV")||t.cursorPos++;else if("left"===i){if($($("#"+e+" .selectable")[t.cursorPos]).hasClass("selectV"))return;t.cursorPos--}else"down"===i?(i=$($("#"+e+" .selectable")[t.cursorPos]).nextAll(".selectV:eq(0)"),console.log(i.attr("id")),t.cursorPos=$("#"+e+" .selectable").index(i),console.log(t.cursorPos),0>t.cursorPos&&(t.cursorPos=t.cursorElems-1)):"up"===i&&(i=1,$($("#"+e+" .selectable")[t.cursorPos]).hasClass("selectV")&&(i=0),i=$($("#"+e+" .selectable")[t.cursorPos]).prevAll(".selectV:eq("+i+")"),console.log(i.attr("id")),t.cursorPos=$("#"+e+" .selectable").index(i),console.log(t.cursorPos));0>t.cursorPos&&(t.cursorPos=0),t.cursorPos>t.cursorElems-1&&(t.cursorPos=t.cursorElems-1),$("#"+e+" .selectable").each((function(){$(this).removeClass("hover")})),$($("#"+e+" .selectable")[t.cursorPos]).addClass("hover")},update:function(){var e=this.e,t=this.elem;Engine.keys.B&&!e.b?(e.b=!0,Engine.keys.B=!1,$($("#"+t+" .selectB")[0]).trigger("click")):!Engine.keys.B&&e.b&&(e.b=!1),Engine.keys.Y&&!e.y?(e.y=!0,Engine.keys.Y=!1,$($("#"+t+" .selectY")[0]).trigger("click")):!Engine.keys.Y&&e.y&&(e.y=!1),Engine.keys.X&&!e.x?(e.x=!0,Engine.keys.X=!1,$($("#"+t+" .selectX")[0]).trigger("click")):!Engine.keys.X&&e.x&&(e.x=!1),Engine.keys.BACK&&!e.back?(e.back=!0,Engine.keys.BACK=!1,$($("#"+t+" .selectBack")[0]).trigger("click")):!Engine.keys.BACK&&e.back&&(e.back=!1),Engine.keys.START&&!e.start?(e.start=!0,Engine.keys.START=!1,$($("#"+t+" .selectStart")[0]).trigger("click")):!Engine.keys.START&&e.start&&(e.start=!1),Engine.keys.DOWN&&!e.down?(e.down=!0,this.updateDOM(t,e,"down")):!Engine.keys.DOWN&&e.down&&(e.down=!1),Engine.keys.UP&&!e.up?(e.up=!0,this.updateDOM(t,e,"up")):!Engine.keys.UP&&e.up&&(e.up=!1),Engine.keys.LEFT&&!e.left?(e.left=!0,this.updateDOM(t,e,"left")):!Engine.keys.LEFT&&e.left&&(e.left=!1),Engine.keys.RIGHT&&!e.right?(e.right=!0,this.updateDOM(t,e,"right")):!Engine.keys.RIGHT&&e.right&&(e.right=!1),Engine.keys.JUMP&&!e.jump?(e.jump=!0,$($("#"+t+" .selectable")[e.cursorPos%e.cursorElems]).trigger("click")):!Engine.keys.JUMP&&e.jump&&(e.jump=!1)},addInputHandler:function(e,t){var i=!!t.e;return t.elem=e,t.e={cursorPos:t.e?t.e.cursorPos:0,cursorElems:0,down:!1,up:!1,left:!1,right:!1,jump:!0,back:!0,start:!0,y:!0,x:!0,b:!0},t.update=this.update,t.updateDOM=this.updateDOM,t.e.cursorElems=$("#"+e+" .selectable").length,Engine.gamepadActive&&(i?$($("#"+e+" .selectable")[t.e.cursorPos]).addClass("hover"):$($("#"+e+" .selectable")[0]).addClass("hover")),{elem:e,e:t}},updateInputHandlers:function(){for(var e=[],t=0;t<this.inputHandlers.length;t++){var i=this.inputHandlers[t];i=this.addInputHandler(i.elem,i.e);e.push(i)}this.inputHandlers=e},fetchTemplate:function(e,t){var i=this;$.ajax({url:this.filePath+"/"+e+this.fileExt+this.version,dataType:"html",success:function(n){i.elements[e].DOM=n,t()},async:!0})},appendTemplate:function(e,t){$("#overlay").append(this.elements[e].DOM),t&&(this.elements[e].options=t),void 0!==this.elements[e].process&&this.elements[e].process(),void 0!==this.elements[e].bindEvents&&this.elements[e].bindEvents(),this.elements[e].visible=!0,Engine.branding&&Engine.brandingCustom[Engine.branding]&&-1!=this.elements[e].DOM.indexOf("meta")&&($("#meta").html(this.elements["branding_"+Engine.branding].DOM),this.elements["branding_"+Engine.branding].process())},append:function(e,t){!1===this.elements[e].autoLoad?this.fetchTemplate(e,(function(){Engine.Elements.appendTemplate(e,t)})):(Engine.branding&&Engine.brandingCustom[Engine.branding]&&"menu_title"==e&&(e="menu_title_branding"),0===$("#"+e).length&&(this.elements[e].DOM?Engine.Elements.appendTemplate(e,t):this.fetchTemplate(e,(function(){Engine.Elements.appendTemplate(e,t)}))))},removeInputHander:function(e){for(var t=this.inputHandlers.length;t--;)if(this.inputHandlers[t].elem===e){this.inputHandlers.splice(t,1);break}},remove:function(e){Engine.branding&&Engine.brandingCustom[Engine.branding]&&"menu_title"==e&&(e="menu_title_branding"),0!==$("#"+e).length&&(void 0!==this.elements[e].onRemove&&this.elements[e].onRemove(),this.removeInputHander(e),$("#"+e).remove(),this.elements[e].visible=!1)},toggle:function(e){0==$("#"+e).length?Engine.Elements.append(e):Engine.Elements.remove(e)}},Engine.Elements.elements={data:{},darken:{},waiting_for_players:{bindEvents:function(){$("#lobby_leave_waiting").on("click",(function(){Engine.Game.lobbyToJoin=0,Engine.Elements.remove("menu_lobby"),Engine.socket.emit("leaveLobby"),Engine.Elements.remove("waiting_for_players"),Engine.Elements.remove("game_running_notice"),Engine.Elements.append("menu_main"),Engine.history.pushState()}))}},loading:{process:function(){Engine.branding&&Engine.brandingCustom[Engine.branding]&&$("#share").html("")}},ad_h5:{autoLoad:!1,process:function(){Engine.startAds(),Engine.ads.started=Date.now(),Engine.ads.finished=!1;var e=setInterval((function(){var t=Date.now()-Engine.ads.started,i=.01*t;$("#ad_h5_loading_bar").css("width",i+"%"),1e4<=t&&clearInterval(e)}),100)},onRemove:function(){Engine.stopAds()}},ad_cpmstar:{autoLoad:!1,process:function(){Engine.startAds(),Engine.ads.started=Date.now(),Engine.ads.finished=!1;var e=setInterval((function(){var t=Date.now()-Engine.ads.started,i=.01*t;$("#ad_cpmstar_loading_bar").css("width",i+"%"),1e4<=t&&clearInterval(e)}),100)},onRemove:function(){Engine.stopAds()}},ad_cpmstar_lead:{process:function(){}},ad_cpmstar_preroll:{process:function(){$("#cpmstar_preroll_wrapper").css("width","100%").css("height","100%").show();var e=document.createElement("script");e.src="js/cpmstar.js?v=9",e.onload=function(){console.log("CPMStar Video Pre-roll loaded."),Engine.ads.started=Date.now(),Engine.ads.finished=!1},e.onerror=function(){console.log("Error loading CPMStar Video Pre-roll."),Engine.stopAds(),$("#cpmstar_preroll_wrapper").hide()},document.getElementById("cpmstar_wrapper").appendChild(e)},onRemove:function(){$("#cpmstar_wrapper").hide()}},branding_a10:{process:function(){var e=apiInstance.Branding.getLogo();if(e.image){var t=document.createElement("img");t.src=e.image,t.addEventListener("click",e.action),document.getElementById("brandingLogo").appendChild(t)}}},splash_a10:{process:function(){var e=apiInstance.Branding.getSplashScreen();e.show&&e.action&&(document.getElementById("splash_a10").addEventListener("click",e.action),window.setTimeout((function(){Engine.Elements.remove("splash_10")}),3e3))}},branding_miniclip:{process:function(){var e=apiInstance.Branding.getLogo();if(e.image){var t=document.createElement("img");t.src=e.image,t.onclick=function(){window.open(e.action,"_blank")},document.getElementById("brandingLogo").appendChild(t)}}},changelog:{bindEvents:function(){$("#changelog_close").on("click",(function(){Engine.Elements.toggle("changelog")}))},process:function(){$.ajax({url:"changelog.txt?v="+Engine.version,dataType:"text",success:function(e){$("#changelog .inner").html(e)},async:!0})}},credits:{bindEvents:function(){$("#credits_close").on("click",(function(){Engine.Elements.toggle("credits")}))}},menu_title_branding:{bindEvents:function(){var e=apiInstance.Branding.getLink("more_games");e.action?"a10"==Engine.branding?document.getElementById("title_more").onclick=e.action:document.getElementById("title_more").onclick=function(){window.open(e.action,"_blank")}:"a10"==Engine.branding&&$("#title_more").on("click",(function(){window.open("https://www.a10.com/?utm_medium=brandedgames_external&utm_campaign=576742227280292150&utm_source=play.treasurearena.com&utm_content=more_games")})),$("#title_options").on("click",(function(){Engine.Elements.toggle("options")})),$("#title_help").on("click",(function(){Engine.Elements.toggle("help")})),$("#changelog_show").on("click",(function(){Engine.Elements.toggle("changelog"),Engine.viewedChangelog=!0})),$("#credits_show").on("click",(function(){Engine.Elements.toggle("credits")})),Engine.share()},process:function(){$("#title_play").on("click",(function(){Engine.checkVersionUpdate(),Engine.Elements.remove("menu_title"),Engine.Elements.append("menu_servers")})),Engine.audio.isPlaying("menu")||Engine.audio.play("menu")}},menu_title:{bindEvents:function(){$("#title_options").on("click",(function(){Engine.Elements.toggle("options")})),$("#title_help").on("click",(function(){Engine.Elements.toggle("help")})),$("#changelog_show").on("click",(function(){Engine.Elements.toggle("changelog"),Engine.viewedChangelog=!0})),$("#credits_show").on("click",(function(){Engine.Elements.toggle("credits")})),$("#feature .feature-discord").on("click",(function(){var e=($(window).width()-600)/2,t=($(window).height()-600)/2;window.open("https://discord.gg/V7cDjaJqZF","","left="+e+",top="+t+",width=680,height=680,toolbar=0,resizable=1")})),!1===Engine.getCookie("patreon-code")&&!1===Engine.getCookie("patreon-user")||$("#title_patreon_connect").html("Reconnect with Patreon"),!1===Engine.patreonEnabled?$("#title_patreon_connect").addClass("disabled"):$("#title_patreon_connect").on("click",(function(){var e=($(window).width()-600)/2,t=($(window).height()-600)/2,i="https://www.patreon.com/oauth2/authorize?response_type=code&client_id=_Qy1-vkx5qoySMS7czkGfT5mMDrDqzoy0j5dWKPX6D8zDV-w0UT2dSHk2O9VKRs6&redirect_uri="+Engine.redirectUrl()+"&scope=identity%20campaigns.members";"http"===Engine.server.protocol()?window.location.href=i:window.open(i,"","left="+e+",top="+t+",width=680,height=680,toolbar=0,resizable=1")})),Engine.share()},process:function(){$("#title_play").on("click",(function(){Engine.Elements.remove("menu_title"),Engine.Elements.append("menu_servers")})),Engine.audio.isPlaying("menu")||Engine.audio.play("menu")}},menu_servers:{bindEvents:function(){$("#feature .feature-discord").on("click",(function(){var e=($(window).width()-600)/2,t=($(window).height()-600)/2;window.open("https://discord.gg/V7cDjaJqZF","","left="+e+",top="+t+",width=680,height=680,toolbar=0,resizable=1")})),Engine.share()},process:function(){$(".lobby_options").on("click",(function(){Engine.Elements.toggle("options")})),$(".backToTitle").on("click",(function(){Engine.Elements.remove("menu_servers"),Engine.Elements.append("menu_title")})),$(".server").on("click",(function(){var e=$(this).attr("id"),t=$(this);$(this).hasClass("disabled")||($(this).addClass("active disabled"),Engine.Elements.append("darken"),Engine.checkServerAlive({id:e},(function(){t.removeClass("active disabled"),Engine.Elements.remove("darken"),Engine.server.alive?(Engine.Elements.remove("menu_servers"),Engine.Elements.append("menu_name"),Engine.server.connected||Engine.Game.connect()):Engine.info("The Game-Server is offline. Please try again later.")})))}))}},invite:{preventHandler:!0,process:function(){}},game_running_notice:{preventHandler:!0},menu_name:{creating:!1,process:function(){var e;e=Engine.kongregate?kongregate.services.getUsername()||"":Engine.getCookie("name"),$("#guest_name").val(e||""),this.cleanInput("guest_name",1,9),$("#guest_name").focus(),$("#onlineCount").html(Engine.Game.getOnlineCount()),$("#lobby_header_server").html(Engine.server.current.name)},bindEvents:function(){var e=this;$(".lobby_options").on("click",(function(){Engine.Elements.toggle("options")})),$(".backToTitle").on("click",(function(){Engine.socket.disconnect(),Engine.Game.lobbyToJoin=0})),$("#play_guest").on("click",(function(){e.cleanInput("guest_name",1,9),e.validate("guest_name",1,9)&&e.login()})),$("#guest_name").on("keyup",(function(t){t=(t=t||window.e).keyCode;var i=this.selectionStart;e.cleanInput("guest_name",1,9),13===t&&e.validate("guest_name",1,9)&&e.login(),this.setSelectionRange(i,i)})),Engine.share()},cleanInput:function(e,t,i){(t=(t=$("#"+e).val()).replace(/[^a-zA-Z0-9]/gi,"")).length>i&&(t=t.substr(0,i)),$("#"+e).val(t)},validate:function(e,t,i){var n=$("#"+e).val();return n.length<t?($("#"+e).focus(),!1):!(n.length>i)&&($("#"+e).blur(),!0)},login:function(){$("#play_guest").addClass("active disabled"),Engine.Elements.append("darken");var e=$("#guest_name").val();Engine.setCookie("name",e,100),Engine.socket.emit("setName",e)},onRemove:function(){Engine.marquee.stop($("#marquee"))}},menu_main:{process:function(){Engine.state=10,Engine.socket.emit("requestGameStats"),$("#onlineCount").html(Engine.Game.getOnlineCount()),$("#lobby_header_server").html(Engine.server.current.name),Engine.getPatreonTier()<0&&Engine.patreonEnabled&&Engine.Elements.append("news")},bindEvents:function(){$("#title_help").on("click",(function(){Engine.Elements.toggle("help")})),$(".lobby_options").on("click",(function(){Engine.Elements.toggle("options")})),$(".backToTitle").on("click",(function(){Engine.socket.disconnect()})),$("#main_join_random").on("click",(function(){Engine.socket.emit("requestRandomLobby")})),$("#main_list_lobbies").on("click",(function(){Engine.Elements.remove("menu_main"),Engine.Elements.append("menu_lobbies"),Engine.socket.emit("getLobbies")})),Engine.share()},onRemove:function(){Engine.marquee.stop($("#marquee"))}},menu_lobbies:{scrollPos:0,process:function(){Engine.getPatreonTier()<1&&(Engine.branding&&!Engine.allowLobbiesAd[Engine.branding]||Engine.Elements.append("ad_cpmstar_lead")),Engine.state=11,this.scrollPos=0,$("#onlineCount").html(Engine.Game.getOnlineCount()),$("#lobby_header_server").html(Engine.server.current.name)},bindEvents:function(){$(".lobby_options").on("click",(function(){Engine.Elements.toggle("options")})),$(".backToMain").on("click",(function(){Engine.Elements.remove("menu_lobbies"),Engine.Elements.append("menu_main")})),$("#lobbies_create_lobby").click((function(){Engine.Elements.remove("menu_lobbies"),Engine.Elements.append("menu_create_lobby")})),Engine.share()},scrollElem:function(){var e=Engine.keys.WHEEL,t=($("#lobbyList")[0].scrollHeight-$("#lobbyList").height())/20;this.scrollPos+=e,0>this.scrollPos&&(this.scrollPos=0),this.scrollPos>t&&(this.scrollPos=t),$("#lobbyList").scrollTop(20*this.scrollPos),Engine.keys.WHEEL=!1},onRemove:function(){Engine.marquee.stop($("#marquee")),Engine.Elements.remove("ad_cpmstar_lead")}},menu_create_lobby:{creating:!1,process:function(){$("#lobby_name").focus(),0==$("#marquee").html().length&&Engine.marquee.start($("#marquee"),Engine.Game.gameStats),$("#onlineCount").html(Engine.Game.getOnlineCount()),$("#lobby_header_server").html(Engine.server.current.name)},bindEvents:function(){var e=this;$(".lobby_options").on("click",(function(){Engine.Elements.toggle("options")})),$(".backToLobbies").on("click",(function(){Engine.Elements.remove("menu_create_lobby"),Engine.Elements.append("menu_lobbies"),Engine.socket.emit("getLobbies")})),$("#lobby_create").on("click",(function(){e.cleanInput("lobby_name",1,20),e.validate("lobby_name",1,20)&&e.create()})),$("#lobby_name").on("keyup",(function(t){t=(t=t||window.e).keyCode;var i=this.selectionStart;e.cleanInput("lobby_name",1,20),13===t&&e.validate("lobby_name",1,20)&&e.create(),this.setSelectionRange(i,i)})),Engine.share()},cleanInput:function(e,t,i){(t=$("#"+e).val().trimStart()).length>i&&(t=t.substr(0,i)),$("#"+e).val(t)},validate:function(e,t,i){var n=$("#"+e).val().trim();return n.length<t?($("#"+e).focus(),!1):!(n.length>i)&&($("#"+e).blur(),!0)},create:function(){$("#lobby_create").addClass("active disabled"),Engine.Elements.append("darken");var e=$("#lobby_name").val();Engine.socket.emit("newLobby",e),this.creating=!1},onRemove:function(){Engine.marquee.stop($("#marquee"))}},lobby_options:{bindEvents:function(){this.options.isHost?($("#options_public").on("click",(function(){$(this).addClass("active"),$("#options_private").removeClass("active"),Engine.socket.emit("setLobbyPrivacy",0)})),$("#options_private").on("click",(function(){$(this).addClass("active"),$("#options_public").removeClass("active"),Engine.socket.emit("setLobbyPrivacy",1)}))):($("#options_public").addClass("disabled"),$("#options_private").addClass("disabled")),0===this.options.privacy?$("#options_public").addClass("active"):1===this.options.privacy&&$("#options_private").addClass("active"),$("#lobby_options_close").on("click",(function(){Engine.Elements.remove("lobby_options"),$("html").focus()}));var e=Engine.branding&&Engine.shareUrlCustom[Engine.branding]?Engine.shareUrlCustom[Engine.branding]+"#!/lobby/"+this.options.code+Engine.server.current.tag:Engine.gameUrl()+"/#!/lobby/"+this.options.code+Engine.server.current.tag;$("#share_url").val(e),$("#share_url").on("click",(function(){$(this).select()}));var t=this;$("#options_copy").on("click",(function(){})),$("#invite_twitter").on("click",(function(){var e=($(window).width()-575)/2,i=($(window).height()-400)/2;return window.open("https://twitter.com/share?text=Challenge me in a game of Treasure Arena!&url="+(Engine.branding&&Engine.shareUrlCustom[Engine.branding]?Engine.shareUrlCustom[Engine.branding]+"%23!/lobby/"+t.options.code+Engine.server.current.tag:"https://play.treasurearena.com/%23!/lobby/"+t.options.code+Engine.server.current.tag),"twitter","status=1,width=575,height=400,top="+i+",left="+e)}))}},menu_lobby:{process:function(){Engine.state=11,$("#chatLobbyInput").focus(),$("#onlineCount").html(Engine.Game.getOnlineCount()),$("#lobby_header_server").html(Engine.server.current.name),Engine.ads.show||$("#box_extra").addClass("noads"),Engine.branding&&!Engine.allowChat[Engine.branding]&&$("#chatLobbyInput").hide()},loop:function(){var e=this;$("#box_classes .cla").each((function(){$(this).css({"background-position-x":"0px","background-position-y":"0px"}),$(this).animate({"background-position-x":"255px","background-position-y":"255px"},8e3,"linear",(function(){e.loop()}))}))},bindEvents:function(){$("#box_classes").on("click",".bot .name",(function(e){e=$(this).parent().attr("id"),Engine.socket.emit("removeBot",e)})),$("#box_classes").on("click",".bot .button_kickbot",(function(e){e=$(this).parent().attr("id"),Engine.socket.emit("removeBot",e)})),$("#box_classes").on("click",".empty",(function(e){e=$(this).attr("id"),Engine.socket.emit("addBot",e)})),$("#box_classes").on("click",".arrow_left",(function(e){e=$(this).parent().parent().attr("id"),Engine.socket.emit("jobPrev",e)})),$("#box_classes").on("click",".arrow_right",(function(e){e=$(this).parent().parent().attr("id"),Engine.socket.emit("jobNext",e)})),$(".button_kick").on("click",(function(){var e=$(this).attr("id").split("kick_")[1];Engine.socket.emit("kick",e),$(this).parent().hide()})),$("#box_classes").on("mouseenter",".cla",(function(){Engine.Game.isHost()&&($(this).hasClass("bot")||$(this).hasClass("host")||$(this).hasClass("empty")||$(this).children(".kick").delay(150).fadeIn(300))})),$("#box_classes").on("mouseleave",".cla",(function(){$(this).children(".kick").stop(!0),$(this).children(".kick").fadeOut(300)})),$("#button_lobby_options").on("click",(function(){Engine.Elements.elements.lobby_options.visible?Engine.Elements.remove("lobby_options"):Engine.socket.emit("getLobbyOptions")})),$(".lobby_options").on("click",(function(){Engine.Elements.toggle("options")})),$("#lobby_leave").on("click",(function(){Engine.Game.lobbyToJoin=0,Engine.Elements.remove("menu_lobby"),Engine.socket.emit("leaveLobby"),Engine.Elements.remove("game_running_notice"),Engine.Elements.append("menu_lobbies"),Engine.history.pushState(),Engine.socket.emit("getLobbies")})),$(".map").on("click",(function(){var e=$(this).attr("id").split("_")[1];Engine.socket.emit("changeMap",e)})),$("#lobby_ready").on("click",(function(){$(this).toggleClass("active"),$(this).hasClass("active")?Engine.socket.emit("ready"):Engine.socket.emit("unready")})),$("#chatLobbyInput").on("keydown",(function(e){13===(e=e||window.e).keyCode&&(0<$("#chatLobbyInput").val().length&&(Engine.socket.emit("chat",$("#chatLobbyInput").val()),$("#chatLobbyInput").val("")),$("#chatLobbyInput").focus())}));var e=Engine.Game.getScreenshots();if(Engine.getPatreonTier()<2&&(e=[]),0<e.length){$("#box_extra").css({background:"#000"}),$("#box_extra .arrows").show();for(var t=e.length;t--;){var i='<div id="shot_'+t+'" class="shot" style="background-image: url('+e[t].thumb.toDataURL("image/png")+');"><div class="desc">'+(e.length-t)+"/"+e.length+"</div></div>";$("#shots").append(i)}$("#shots").cycle({fx:"fade",timeout:5e3,speed:800,pause:1,next:"#shot_next",prev:"#shot_prev"})}else Engine.ads.show?new Clay.Advertisement({size:"200x200",position:{left:"38px",top:"2px",inline:!0,parent:document.getElementById("box_extra")},refreshInterval:60}):(!Engine.branding||Engine.allowLobbiesAd[Engine.branding]&&Engine.getPatreonTier()<2&&Engine.patreonEnabled)&&($("#box_extra").html('<a href="#" id="extra_action"><img src="gfx/news/promo_lobby_patreon_skins.png?" /></a>'),$("#extra_action").click((function(e){e.preventDefault(),e=($(window).width()-1020)/2|0;var t=($(window).height()-720)/2|0;return window.open("https://www.patreon.com/treasurearena","","left="+e+",top="+t+",width=1020,height=720,toolbar=0,location=1,resizable=1"),!1})));$("#shots").on("click",".shot",(function(){var e=$(this).attr("id").split("shot_")[1],t=Engine.Game.getScreenshots(),i=t[e].full,n=t[e].taken;t[e].url="screenshots/"+Engine.server.hash.toString()+"/"+n.toString()+".png";var s=i.width,a=i.height,o=($(window).width()-s)/2|0,r=($(window).height()-a)/2|0;i.toBlob((e=>{const t=URL.createObjectURL(e);window.open(t,"","left="+o+",top="+r+",width="+s+",height="+a+",toolbar=0,location=0,resizable=0")}))})),Engine.share()},onRemove:function(){$("#shots").cycle("destroy"),Engine.Elements.elements.lobby_options.visible&&Engine.Elements.remove("lobby_options"),Engine.marquee.stop($("#marquee"))}},info:{preventHandler:!0},help:{bindEvents:function(){$("#help").on("mousedown",(function(e){e.stopPropagation()})),$("#help").on("mousemove",(function(e){e.stopPropagation()})),$("#help").on("mousedown",".button",(function(e){Engine.audio.play("click")})),$("#help_next").on("click",(function(){Engine.Elements.remove("help"),Engine.Elements.append("help2"),$("html").focus()}))}},help2:{bindEvents:function(){$("#help2").on("mousedown",(function(e){e.stopPropagation()})),$("#help2").on("mousemove",(function(e){e.stopPropagation()})),$("#help2").on("mousedown",".button",(function(e){Engine.audio.play("click")})),$("#help_close").on("click",(function(){Engine.Elements.remove("help2"),$("html").focus()}))}},news:{bindEvents:function(){if(!1===Engine.showNews)return Engine.Elements.remove("news"),void $("html").focus();Engine.showNews=!1,$("#news").on("mousedown",".button",(function(e){Engine.audio.play("click")})),$("#news_close").on("click",(function(){Engine.Elements.remove("news"),$("html").focus()}))}},options:{bindEvents:function(){var e=this;$("#options").on("mousedown",(function(e){e.stopPropagation()})),$("#options").on("mousedown",".button",(function(e){Engine.audio.play("click")})),$("#options").on("mouseup",".ui-slider-handle",(function(e){Engine.audio.play("click"),Engine.saveSettings()})),$("#options_scale_fullscreen").on("click",(function(){Engine.fullscreen=!Engine.fullscreen,Engine.saveSettings(),Engine.fullscreen||Engine.removeFullscreen(),Engine.updateScreen(),e.process()})),Engine.kongregate||Engine.branding&&!Engine.allowFullscreen[Engine.branding]?$("#options_fullscreen").addClass("disabled"):$("#options_fullscreen").on("click",(function(){Engine.fullscreenAPI=!Engine.fullscreenAPI,Engine.fullscreenAPI?Engine.fullscreenLaunch():Engine.fullscreenCancel(),e.process()})),$("#options_scale_auto").on("click",(function(){Engine.scaleAuto=!Engine.scaleAuto,Engine.updateScreen(),e.process()})),$("#options_scale_05").on("click",(function(){Engine.scaleAuto=!1,Engine.updateScreen(.5),e.process()})),$("#options_scale_10").on("click",(function(){Engine.scaleAuto=!1,Engine.updateScreen(1),e.process()})),$("#options_scale_20").on("click",(function(){Engine.scaleAuto=!1,Engine.updateScreen(2),e.process()})),$("#options_scale_30").on("click",(function(){Engine.scaleAuto=!1,Engine.updateScreen(3),e.process()})),$("#options_input_keyboard").on("click",(function(){Engine.gamepadActive=!1,e.process()})),$("#options_input_gamepad").on("click",(function(){Engine.gamepadSupport?Engine.gamepadActive=!0:Engine.Elements.append("gamepad_detect"),e.process()})),$("#volumeSound").slider({value:Engine.audio.volume.sound,slide:function(e,t){Engine.audio.volumeSoundChange(t.value)}}),$("#volumeMusic").slider({value:Engine.audio.volume.music,slide:function(e,t){Engine.audio.volumeMusicChange(t.value)}}),$("#options_muteSound").on("click",(function(){Engine.audio.sound=!Engine.audio.sound,Engine.saveSettings(),Engine.audio.sound?Engine.audio.unmute("sound"):Engine.audio.mute("sound"),$(this).toggleClass("active")})),$("#options_muteMusic").on("click",(function(){Engine.audio.music=!Engine.audio.music,Engine.saveSettings(),Engine.audio.music?Engine.audio.unmute("music"):Engine.audio.mute("music"),$(this).toggleClass("active")})),$("#options_close").on("click",(function(){Engine.Elements.remove("options"),$("html").focus()}))},process:function(){Engine.gamepadSupport&&Engine.gamepadActive||($("#options_input_keyboard").addClass("active"),$("#options_input_gamepad").removeClass("active")),Engine.gamepadActive&&($("#options_input_keyboard").removeClass("active"),$("#options_input_gamepad").addClass("active")),Engine.audio.sound||$("#options_muteSound").addClass("active"),Engine.audio.music||$("#options_muteMusic").addClass("active"),Engine.fullscreen?$("#options_scale_fullscreen").addClass("active"):$("#options_scale_fullscreen").removeClass("active"),Engine.fullscreenAPI?$("#options_fullscreen").addClass("active"):$("#options_fullscreen").removeClass("active"),Engine.scaleAuto?$("#options_scale_auto").addClass("active"):$("#options_scale_auto").removeClass("active");for(var e=[[.5,"options_scale_05"],[1,"options_scale_10"],[1.5,"options_scale_15"],[2,"options_scale_20"],[3,"options_scale_30"]],t=Engine.contextSmoothing?Engine.scale:Engine.contextScale,i=0;i<e.length;i++)t==e[i][0]?$("#"+e[i][1]).addClass("active"):$("#"+e[i][1]).removeClass("active")}},game:{process:function(){$("#chatOutput").scrollTop(9999),$("#overlay").addClass("hideCursor"),Engine.branding&&!Engine.allowChat[Engine.branding]&&$("#chatInputNote").hide()},bindEvents:function(){$("#menu_game").on("mousedown",(function(e){e.stopPropagation()})),$("#menu_game").on("mousemove",(function(e){e.stopPropagation()})),$("#menu_game").on("mousedown",".button",(function(e){Engine.audio.play("click")})),$("#game_options").on("click",(function(){Engine.Elements.toggle("options")})),$("#game_help").on("click",(function(){Engine.Elements.elements.help.visible?Engine.Elements.remove("help"):Engine.Elements.elements.help2.visible?Engine.Elements.remove("help2"):Engine.Elements.toggle("help")})),$("#game_quit").on("click",(function(){Engine.Elements.toggle("quit")}))},onRemove:function(){$("#overlay").removeClass("hideCursor")}},quit:{bindEvents:function(){$("#quit").on("mousedown",(function(e){e.stopPropagation()})),$("#quit").on("mousemove",(function(e){e.stopPropagation()})),$("#quit").on("mousedown",".button",(function(e){Engine.audio.play("click")})),$("#quit_no").on("click",(function(){Engine.Elements.remove("quit"),$("html").focus()})),$("#quit_yes").on("click",(function(){Engine.Elements.remove("quit"),Engine.state=12}))}},gamepad_detect:{bindEvents:function(){$("#gamepad_detect").on("mousedown",(function(e){e.stopPropagation()})),$("#gamepad_detect").on("mousemove",(function(e){e.stopPropagation()})),$("#gamepad_detect").on("mousedown",".button",(function(e){Engine.audio.play("click")})),$("#gamepad_detect_cancel").on("click",(function(){Engine.Elements.remove("gamepad_detect")}))}},unsupported:{process:function(){$("html").addClass("unsupported"),$("#back_to_main").click((function(){window.location.href="https://www.treasurearena.com"}))}},console:{bindEvents:function(){$("#consoleInput").val("").focus()}}},Engine.Entity=function(e){this.type="entity",this.id=++Engine.ENT_ID,this.owner={},this.data=e||{},this.tickT=this.lastTick=this.tick=0,this.light=this.collidable=this.kill=!1},Engine.Entity.prototype.init=function(){},Engine.Entity.prototype.ticker=function(e){this.lastTick=this.tick,this.tick++,this.tickT+=Engine.deltaT},Engine.Entity.prototype.update=function(e){this.ticker(e),this.onTick(e)},Engine.Entity.prototype.onTick=function(e){},Engine.Entity.prototype.draw=function(){},Engine.Entity.prototype.collide=function(){},Engine.Entity.prototype.getPos=function(){return{x:this.data.x,y:this.data.y,mx:this.data.mx,my:this.data.my,f:this.data.f}},Engine.Entity.prototype.coordToScreen=function(e,t){var i;return i=Engine.Assets.tileSize,(i={x:(this.data.x-e.x+9.5)*i-(t.fw-i)/2,y:(this.data.y-e.y+5)*i-(t.fh-i)}).x=~~(i.x+.5)+(i.x>>31),i.y=~~(i.y+.5)+(i.y>>31),i},Engine.Entity.prototype.inView=function(e,t,i,n,s,a){return!(n<2*-t||n>Engine.height+2*t||i<2*-e||i>Engine.width+2*e)},Engine.Entity.prototype.inViewPointer=function(e,t,i,n,s,a){return!(n<-t/2||n>Engine.height-t/2||i<-e/2||i>Engine.width-e/2)},Engine.Entity.prototype.collisionObjects=function(e){var t,i,n=Engine.Game.getCollidableObjects(),s={left:e.x+.2,right:e.x+1-.2,top:e.y+.2,bottom:e.y+1-.2},a={left:0,right:0,top:0,bottom:0},o=n.length,r=!1,l=!1,h=!1;for(t=0;t<o;t++)i=n[t],!this.collidable||!i.collidable||"projectile"===this.type&&i.inAir||"projectile"===this.type&&i.dodge||"projectile"===this.type&&i.data.invincible||!this.canHurtSelf&&i.id===this.owner.id||i.id===this.id||1!==i.data.alive||"projectile"===this.type&&"npc"===this.owner.type&&"npc"==i.type&&this.owner.id!=i.id||(a.left=i.data.x+.2,a.right=i.data.x+1-.2,a.top=i.data.y+.2,a.bottom=i.data.y+1-.2,Engine.collisionAABB(s,a)&&(Math.abs(s.left-a.left)>Math.abs(s.top-a.top)?0!=this.data.mx&&(l=r=!0,e.x=this.collisionPush?s.left<a.left?e.x-(s.right-a.left):e.x+(a.right-s.left):this.data.x):0!=this.data.my&&(h=r=!0,e.y=this.collisionPush?s.top<a.top?e.y-(s.bottom-a.top):e.y+(a.bottom-s.top):this.data.y)),r&&(this.collide(i,l,h),i.collide(this,l,h),h=l=r=!1,s.left=e.x+.2,s.right=e.x+1-.2,s.top=e.y+.2,s.bottom=e.y+1-.2));return e},Engine.EntityMoving=function(e){Engine.EntityMoving.prototype.uber.constructor.call(this,e),this.newPos={x:0,y:0,cx:!1,cy:!1},this.savedPos={x:[],y:[]},this.inAir=this.saveHistory=!1,this.land=this.vZ=0,this.dodge=!1,this.vD=0,this.dodge_speed=.05,this.run_speed=.1,this.stun=0,this.isShake=this.isHit=!1,this.collisionPush=this.collidable=!0,this.running=!1,this.animationTick=this.velY=this.velX=this.accY=this.accX=0},Engine.EntityMoving.extend(Engine.Entity),Engine.EntityMoving.prototype.update=function(e){this.ticker(e)},Engine.EntityMoving.prototype.compensateSoft=function(e,t){this.newPos.x="x"==e?t:this.data.x,this.newPos.y="y"==e?t:this.data.y,this.newPos=Engine.Game.collision(this.data,this.newPos),this.newPos=this.collisionObjects(this.newPos),this.data.x=this.newPos.x,this.data.y=this.newPos.y},Engine.EntityMoving.prototype.compensate=function(e,t,i){var n,s,a=this.savedPos[e].length;if(i){for(n=s=0;n<a;n++)if(this.savedPos[e][n].t<i){s=n;break}}else s=Math.round(Engine.server.ping/(1e3/60));if(0==s||0==a)this.data[e]=t;else if(void 0===this.savedPos[e][s])this.data[e]=t,this.savedPos.x.length=0,this.savedPos.y.length=0;else if(t-=this.savedPos[e][s].state,n={x:"x"==e?this.data.x+=t:this.data.x,y:"y"==e?this.data.y+=t:this.data.y},Engine.Game.collision(this.data,n),this.data.x=n.x,this.data.y=n.y,n.cy||n.cx)this.savedPos.x.length=0,this.savedPos.y.length=0,this.newPos.cy=!1,this.newPos.cx=!1;else for(n=s;n--;)this.savedPos[e][n].state+=t},Engine.EntityMoving.prototype.pushHistory=function(e){this.saveHistory&&(this.savedPos[e].unshift({t:Date.now(),state:this.data[e]}),100<this.savedPos[e].length&&this.savedPos[e].splice(-1))},Engine.EntityMoving.prototype.move=function(e,t){if(1!==this.data.alive)0!==this.data.mx&&(this.data.mx=0),0!==this.data.my&&(this.data.my=0);else{var i=this.data.mod_speed;this.running&&!this.dodge&&(i=this.run_speed),this.inAir&&(i+=this.data.jump_speed),this.dodge&&(i+=this.dodge_speed);var n=t[Math.ceil(this.data.y-.5)];n&&(n=n[Math.round(this.data.x)],this.inAir||-1===Engine.Assets.data.tilesets[0].stairs.indexOf(n)||(i-=this.data.mod_speed/2)),this.newPos.x=this.data.x+this.data.mx*i*e,this.newPos.y=this.data.y+this.data.my*i*e,Engine.Game.collision(this.data,this.newPos),this.collisionObjects(this.newPos),this.newPos.x=Math.round(1e3*this.newPos.x)/1e3,this.newPos.y=Math.round(1e3*this.newPos.y)/1e3,this.data.x=this.newPos.x,this.data.y=this.newPos.y,this.pushHistory("x"),this.pushHistory("y"),this.newPos.cy=!1,this.newPos.cx=!1,.04<i&&(0!=this.data.mx||0!=this.data.my)&&(this.running?this.tick%4<this.lastTick%4&&!this.inAir&&((i=new Engine.FX.Smoketrail({x:this.data.x-.5*this.data.mx,y:this.data.y-.2-.2*this.data.my})).init(),Engine.Game.addObject(i)):this.tick%16<this.lastTick%16&&!this.inAir&&((i=new Engine.FX.Smoketrail({x:this.data.x-.5*this.data.mx,y:this.data.y-.2-.2*this.data.my})).init(),Engine.Game.addObject(i)))}},Engine.EntityMoving.prototype.collide=function(e,t,i){},Engine.EntityMoving.prototype.draw=function(e,t,i,n){},Engine.EntityPlayer=function(e){Engine.EntityPlayer.prototype.uber.constructor.call(this),this.id=e.id,this.data=e,this.data.z=0,this.illuLighting=this.illuLight=null,this.hpCut=0,this.light="light_player",this.invisSet=this.armorSet=0,this.casting=!1,this.castTick=0,this.pointerSet=this.showStamina=!1,this.telegraph=this.coinGet=0,this.frame=Engine.rand(0,6),this.timer=7,this.deg=0,this.skills={armor:{init:function(e){var t;(t=new Engine.FX.Buff(e,0,1)).init(),Engine.Game.addObject(t),(t=new Engine.FX.Buff(e,90,0)).init(),Engine.Game.addObject(t),(t=new Engine.FX.Buff(e,180,-1)).init(),Engine.Game.addObject(t),(t=new Engine.FX.Buff(e,270,-2)).init(),Engine.Game.addObject(t)}}},this.weaponList="Melee Arrow Shell Bullet Rocket Grenade Bone".split(" "),this.dodgedAt=this.jumpedAt=0},Engine.EntityPlayer.extend(Engine.EntityMoving),Engine.EntityPlayer.prototype.init=function(){switch(this.data.job){case"war":this.sprites={player:"class_war",hand_main:"weapon_sword1",hand_off:"shield_blue",pointer:"pointer_war"};break;case"rog":this.sprites={player:"class_rog",hand_main:"weapon_dagger1",hand_off:"shield_green",pointer:"pointer_rog"};break;case"mag":this.sprites={player:"class_mag",hand_main:"weapon_staff1",hand_off:"shield_red",pointer:"pointer_mag"};break;case"war2":this.sprites={player:"class_war2",hand_main:"weapon_sword1",hand_off:"shield_blue",pointer:"pointer_war"};break;case"rog2":this.sprites={player:"class_rog2",hand_main:"weapon_dagger1",hand_off:"shield_green",pointer:"pointer_rog"};break;case"mag2":this.sprites={player:"class_mag2",hand_main:"weapon_staff1",hand_off:"shield_red",pointer:"pointer_mag"}}"bot"===this.data.subtype?this.initNameBuffer("#58316b"):this.initNameBuffer("#a10000")},Engine.EntityPlayer.prototype.leave=function(){this.data.alive=-1,this.kill=!0},Engine.EntityPlayer.prototype.update=function(e,t){-1===this.data.alive?this.leave():(this.ticker(e),this.inAir&&this.jump(),this.dodge&&this.dodgeRoll(),this.data.invincible&&(this.data.invincible-=Engine.deltaT,0>=this.data.invincible&&(this.data.invincible=!1)),this.updateStatus(),this.move(e,t),this.getFaceDirection(),this.onTick(e))},Engine.EntityPlayer.prototype.onTick=function(e){this.animationTick+=Engine.deltaT,this.animationTick>this.timer*Engine.frameStep&&(this.animationTick=0,this.frame++)},Engine.EntityPlayer.prototype.doJump=function(){if(!this.inAir){this.jumpedAt=Date.now(),this.land=Engine.now,this.inAir=!0;var e=new Engine.FX.Smoketrail(this.data);e.init(),Engine.Game.addObject(e),Engine.Game.audio.play("jump",this.data)}},Engine.EntityPlayer.prototype.doDodge=function(){this.dodge||(this.dodgedAt=Date.now(),this.dodge=!0)},Engine.EntityPlayer.prototype.doAttack=function(e){this.shoot||(this.shoot=!0),this.updateRotation(e);var t=new Engine.FX.Slash(this.data);return t.init(),Engine.Game.addObject(t),this.slashing=Engine.now,Engine.Game.audio.play("slash",this.data),e},Engine.EntityPlayer.prototype.doShoot=function(e){this.shoot||(this.shoot=!0),this.updateRotation(e.rotation),this.shooting=Engine.now;var t=e.weapon?this.weaponList[e.weapon]:this.data.weapon;if(e=e.rotation,t&&"Melee"!==t){if(Engine.Projectile[t]){var i,n=new Engine.Projectile[t](this.data);if(n.init(e),Engine.Game.addObject(n),"Shell"==t)i=e-.3,(n=new Engine.Projectile[t](this.data)).init(i),Engine.Game.addObject(n),i=e+.3,(n=new Engine.Projectile[t](this.data)).init(i),Engine.Game.addObject(n),Engine.Game.audio.play("shell",this.data);return e}}else console.log("Error: Weapon is "+t)},Engine.EntityPlayer.prototype.stopShoot=function(){this.shoot=!1},Engine.EntityPlayer.prototype.updateRotation=function(e){-.8<e&&.8>e?"E"!=this.data.f&&(this.data.f="E"):(-2.4>e||2.4<e)&&"W"!=this.data.f&&(this.data.f="W"),-2.4<e&&-.8>e?"N"!=this.data.f&&(this.data.f="N"):.8<e&&2.4>e&&"S"!=this.data.f&&(this.data.f="S")},Engine.EntityPlayer.prototype.updateStatus=function(){var e=Engine.now;this.isHit&&this.isHit<e-150&&(this.isHit=!1),this.isShake&&this.isShake<e-100&&(this.isShake=!1),this.slashing&&this.slashing<e-150&&(this.slashing=!1),this.casting&&1===this.data.alive&&(this.castTick++,0==this.castTick%2&&((e=new Engine.FX.Thud(this.data)).init(),Engine.Game.addObject(e)))},Engine.EntityPlayer.prototype.resolveStatus=function(e,t,i){var n,s,a=e.length;for(n=0;n<a;n++)if(void 0!==(s=e[n]).atk){if(t&&0<s.atk&&(this.isShake=Engine.now),!t)switch(s.atk){case 1:this.doAttack(s.r);break;case 2:this.doShoot({rotation:s.r,weapon:s.w});break;case 3:this.doShoot({rotation:s.r,weapon:s.w,alt:!0});break;case 0:this.stopShoot()}}else if(void 0!==s.switchTo)t||(this.data.weapon=this.weaponList[s.switchTo]);else if(void 0!==s.run){if(!t)switch(s.run){case 1:this.running=!0;break;case 0:this.running=!1}}else if(void 0!==s.hit){this.isHit=this.stun=Engine.now;var o="player"===this.type?"visitorRed":"visitor";(o=new Engine.FX.Damage(this.data,o,s.hit)).init(),Engine.Game.addObjectOverlay(o),Engine.Game.audio.play("hit",this.data)}else if(void 0!==s.miss)o="player"===this.type?"visitorRed":"visitor",(o=new Engine.FX.Damage(this.data,o,"miss")).init(),Engine.Game.addObjectOverlay(o);else if(void 0!==s.block)this.showStamina&&!this.data.armor&&this.reduceSta(100/this.data.hpMax*4*(s.block+1)),Engine.Game.audio.play("block2",this.data),Engine.Game.audio.play("block",this.data),s=this.data.x,o=this.data.y+.1,"W"===this.data.f&&(s-=.15),"E"===this.data.f&&(s+=.15),"N"===this.data.f&&(o-=.35),"S"===this.data.f&&(o+=.15),(o=new Engine.FX.Collect({x:s,y:o})).init(),Engine.Game.addObject(o);else if(void 0!==s.aggro)(o=new Engine.FX.Aggro(this.data)).init(),Engine.Game.addObjectOverlay(o);else if(void 0!==s.pickup){switch(s.pickup){case 0:this.coinGet=Engine.now,Engine.Game.audio.play("coin",this.data);break;case 6:Engine.Game.audio.play("potion",this.data);break;default:Engine.Game.audio.play("pickup",this.data)}if(t)switch(s.pickup){case 1:this.pickWeapon("Arrow",s.c);break;case 2:this.pickWeapon("Rocket",s.c);break;case 3:this.pickWeapon("Grenade",s.c);break;case 4:this.pickWeapon("Shell",s.c);break;case 5:this.pickWeapon("Bullet",s.c)}}else if(void 0!==s.trap)(o=new Engine.FX.Trap(s.trap)).init(),Engine.Game.addObject(o);else if(void 0!==s.die){this.data.alive=0,this.data.mx=0,this.data.my=0,this.light&&(this.light=!1),t&&s.by!==this.data.id&&(Engine.Game.setCamera(s.die),Engine.webaudio&&(Engine.audio.buses.biquad.frequency.value=500,this.initwarning=2));for(var r=0;12>r;r++)(o=new Engine.FX.Explode(this.data)).init(),Engine.Game.addObject(o);Engine.Game.audio.play("die",this.data),"npc"!==this.type&&(o=Engine.rand(0,2),Engine.Game.audio.play("cheer"+o),t||i!==s.die||setTimeout((function(){Engine.Game.takeScreenshot()}),125))}else if(void 0!==s.jump)t||this.doJump();else if(void 0!==s.dodge)t||this.doDodge();else if(void 0!==s.skill)switch(s.skill){case"armor":this.armorSet=Engine.now,this.data.armor=!0,this.skills.armor.init(this);break;case"invis":this.invisSet=Engine.now,this.data.invis=!0}else if(void 0!==s.cast)switch(s.cast){case 1:this.casting=!0;break;case 0:this.casting=!1}},Engine.EntityPlayer.prototype.pickWeapon=function(e,t){this.data.weapon=e},Engine.EntityPlayer.prototype.draw=function(e,t,i,n){if(1==this.data.alive){var s,a,o,r,l,h=Engine.Assets.sprites[this.sprites.player];if(r=h.fw,l=h.fh,e=(s=this.coordToScreen(e,h)).x,s=s.y-this.data.z,this.inViewPointer(r,l,e,s,r,l)||i.fog||!this.sprites.pointer||this.pointerSet||(this.pointerSet=!0,(i=new Engine.FX.Pointer(this.data,this.sprites,this.drawPointer,this.nameBufferPointer)).init(),Engine.Game.addObjectOverlay(i)),this.inView(r,l,e,s,r,l)){this.sprites.pointer&&this.pointerSet&&this.inViewPointer(r,l,e,s,r,l)&&(this.pointerSet=!1),i=0,a=this.frame;var c=Engine.Assets.tileSize,d=Engine.canvas.ctx;this.data.invincible&&2>this.tick%6&&(d.globalAlpha=0),this.showStamina&&this.drawStamina(e,s,c),this.data.invis&&(1e3>Engine.now-this.invisSet&&this.tick%4>this.lastTick%4&&(d.globalAlpha=.5),1e3<=Engine.now-this.invisSet&&(d.globalAlpha=n||150>Engine.now-this.slashing||150>Engine.now-this.shooting?.5:0)),this.drawName(e+r/2,s,!1),n=this.getPhase(this.data.alive,this.data.mx,this.data.my),o=this.getOffset(this.sprites.player,n,a,h),0!=a%2||0==this.data.mx&&0==this.data.my||this.inAir||(i=Engine.scale),a=o.x,o=o.y,"hit"==n&&(e+=5*(Math.random()-.5),s+=5*(Math.random()-.5)),this.drawShadow(c,r,l,e,s,r,l),"N"==this.data.f&&this.drawWeapons(e,s,i,n),this.dodge?(d.save(),d.translate(e+r/2,s+l/2),d.rotate(3.145*this.vD*(-1==this.data.mx?-1:1)),d.drawImage(h,a,o,r,l,-r/2,-l/2,r,l),d.restore()):d.drawImage(h,0|a,0|o,0|r,0|l,0|e,s+i|0,r,0|l),"N"!=this.data.f&&this.drawWeapons(e,s,i,n),h.fw<=c&&!this.inAir&&this.drawGrass(t,e,s,r,l,i),this.data.block&&this.drawBlocKBubble(e,s,r,l),d.globalAlpha=1}}},Engine.EntityPlayer.prototype.drawWeapons=function(e,t,i,n){if("Melee"==this.data.weapon)this.sprites.hand_main&&"attack"!=n&&this.drawSword(e,t,i),this.sprites.hand_off&&this.drawShield(e,t,i);else{n=Engine.Assets.sprites.weapons;var s,a,o,r,l,h,c=Engine.Assets.data.sprites.weapons.weapon[this.data.weapon],d=Engine.canvas.ctx;void 0!==c&&(s=c.sx*n.fw|0,a=0,o=n.fw,r=n.fh,c=(h=c.offset[this.data.f]).dx/2*Engine.scale,h=h.dy/2*Engine.scale,t+=6*Engine.scale-i,"N"==this.data.f&&(l=-90,e+=c,t+=h),"S"==this.data.f&&(l=0,a+=r,e+=c,t+=h),"W"==this.data.f&&(l=0,a+=r,e+=c,t+=h),"E"==this.data.f&&(l=0,e+=c,t+=h),d.save(),d.translate(e+o/2,t+r/2- -1*h),d.rotate(l*Engine.math.PI/180),this.dodge&&d.rotate(3.145*this.vD*(-1==this.data.mx?-1:1)),d.drawImage(n,s,a,o,r,-o/2+c,-r/2+h,o,r),d.restore())}},Engine.EntityPlayer.prototype.drawSword=function(e,t,i){var n,s,a=Engine.Assets.sprites[this.sprites.hand_main],o=Engine.canvas.ctx;n=a.fw,s=a.fh,t+=i+Engine.scale,"S"==this.data.f||"W"==this.data.f?(i=a.fh,e-=10*Engine.scale):(i=0,e+=10*Engine.scale),e|=0,t|=0,this.dodge?(o.save(),o.translate(e+n/2,t+s/2),o.rotate(3.145*this.vD*(-1==this.data.mx?-1:1)),o.drawImage(a,0,i,n,s,-n/2,-s/2,n,s),o.restore()):o.drawImage(a,0,i,n,s,e,t,n,s)},Engine.EntityPlayer.prototype.drawShield=function(e,t,i){var n,s,a,o=Engine.Assets.sprites[this.sprites.hand_off],r=Engine.canvas.ctx;s=o.fw,a=o.fh,"S"==this.data.f||"W"==this.data.f?(n=o.fh,t+=4*Engine.scale-i):"N"==this.data.f?(n=2*o.fh|0,t-=i):(n=0,t+=4*Engine.scale-i),this.data.block&&("W"==this.data.f&&(e-=4*Engine.scale),"E"==this.data.f&&(e+=4*Engine.scale),"N"==this.data.f&&(t-=2*Engine.scale,e+=4*Engine.scale),"S"==this.data.f&&(t+=2*Engine.scale,e-=4*Engine.scale)),t+=Engine.scale,e|=0,t|=0,this.dodge?(r.save(),r.translate(e+s/2,t+a/2),e=-1==this.data.mx?-1:1,r.rotate(3.145*this.vD*e),r.drawImage(o,0,n,s,a,-s/2,-a/2,s,a),r.restore()):r.drawImage(o,0,n,s,a,e,t,s,a)},Engine.EntityPlayer.prototype.drawLight=function(e){var t,i=Engine.Assets.sprites[this.light],n=Engine.canvas.ctx,s=Engine.Assets.sprites[this.sprites.player],a=this.coordToScreen(e,s);e=s.fw,s=s.fh,t=a.x,a=a.y-this.data.z,this.inView(e,s,t,a,e,s)&&(t=t+(e-i.fw)/2|0,a=a+(s-i.fh)/2|0,n.save(),n.globalCompositeOperation="lighter",n.drawImage(i,t,a),(150>Engine.now-this.slashing||150>Engine.now-this.shooting)&&(n.globalAlpha=.65,n.drawImage(i,t,a)),n.restore())},Engine.EntityPlayer.prototype.drawBlocKBubble=function(e,t,i,n){var s,a,o=Engine.Assets.sprites.block,r=Engine.canvas.ctx;s=o.fw,a=o.fh,e=e+(i-o.fw)/2|0,t=t+(n-o.fh)/2|0,i=o.fw,n=o.fh,e+=(o.fw-i)/2,t+=(o.fh-n)/2,r.save(),r.drawImage(o,0,0,s,a,e,t,i,n),r.restore()},Engine.EntityPlayer.prototype.drawShadow=function(e,t,i,n,s,a,o){n=n+(a-(e=Engine.Assets.sprites.shadow).fw)/2|0,s=s+o-e.fh/2|0,s-=2*Engine.scale|0,s+=0|this.data.z,Engine.canvas.ctx.drawImage(e,n,s)},Engine.EntityPlayer.prototype.initNameBuffer=function(e){e=Engine.Assets.fonts.semplice.fw;var t=this.data.name,i=t.length,n=document.createElement("canvas");n.width=i*(e-e/4)|0,n.height=10*Engine.scale|0,n.ctx=n.getContext("2d",{willReadFrequently:!0}),this.nameBuffer=n,Engine.text("semplice",t,0,0,!1,void 0,n),this.sprites.pointer&&this.initNameBufferPointer()},Engine.EntityPlayer.prototype.initNameBufferPointer=function(){var e=Engine.Assets.fonts.semplice.fw,t=this.data.name,i=t.length,n=document.createElement("canvas");n.width=i*(e-e/4)|0,n.height=11*Engine.scale|0,n.ctx=n.getContext("2d",{willReadFrequently:!0}),this.nameBufferPointer=n,n.ctx.fillStyle="#f0c622",n.ctx.fillRect(0,0,n.width,n.height/2),n.ctx.fillStyle="#d9a51b",n.ctx.fillRect(0,n.height/2,n.width,n.height/2),n.ctx.fillStyle="#fbe373",n.ctx.fillRect(0,0,n.width,Engine.scale),n.ctx.fillStyle="#2b2b2b",n.ctx.fillRect(0,n.height-Engine.scale,n.width,Engine.scale),Engine.text("semplice",t,0,0,!1,void 0,n)},Engine.EntityPlayer.prototype.drawLevel=function(e,t){t-=13*Engine.scale,e-=this.nameBuffer.width/2,e+=1.5*this.data.level.toString().length*Engine.Assets.fonts.visitorLevel.fw,Engine.text("visitorLevel",this.data.level,0|e,0|t)},Engine.EntityPlayer.prototype.drawName=function(e,t,i){var n=Engine.canvas.ctx;t-=14*Engine.scale,e-=this.nameBuffer.width/2,i&&(e+=this.data.level.toString().length*Engine.Assets.fonts.visitorLevel.fw/1.5),n.drawImage(this.nameBuffer,0|e,0|t)},Engine.EntityPlayer.prototype.drawGrass=function(e,t,i,n,s,a){a=Engine.scale;try{var o=e[Math.ceil(this.data.y-.5)][Math.round(this.data.x)];if(-1!==Engine.Assets.data.tilesets[0].gras.indexOf(o)){var r=Engine.Assets.sprites.grass;t=t+(n-r.fw)/2|0,i=i+s-r.fh/3-2*a|0,Engine.canvas.ctx.drawImage(r,t,i)}}catch(e){}},Engine.EntityPlayer.prototype.drawHP=function(e,t,i){if(this.data.hp!=this.data.hpMax){i=1.5*i|0;var n=Math.round(this.data.hp/this.data.hpMax*100),s=(n=0|Math.round(n/100*i),Engine.canvas.ctx),a=4*Engine.scale|0;t-=4*Engine.scale|0,e-=i/6|0,s.fillStyle="#821f22",s.fillRect(e,t,i,a+Engine.scale),this.data.hp!=this.data.hpMax&&(s.fillStyle="rgb(255,255,255)",s.fillRect(e,t,i,a)),s.fillStyle="rgb(200,0,0)",s.fillRect(e,t,n,a)}},Engine.EntityPlayer.prototype.drawStamina=function(e,t,i){if(this.stamina!=this.staminaMax){i=1.5*i|0;var n=Math.round(this.stamina/this.staminaMax*100),s=(n=0|Math.round(n/100*i),Engine.canvas.ctx),a=4*Engine.scale|0;t-=4*Engine.scale|0,e-=i/6|0,s.fillStyle="#bf8f10",s.fillRect(e,t,i,a+Engine.scale),100!=this.stamina&&(s.fillStyle="rgb(255,255,255)",s.fillRect(e,t,i,a)),s.fillStyle="#f0c521",s.fillRect(e,t,n,a)}},Engine.EntityPlayer.prototype.drawPointer=function(e,t,i,n,s,a){t=Engine.wH,e=Engine.hH,i=(i-t)/(s=Engine.lineDistance({x:t,y:e},{x:i,y:n})),n=(n-e)/s,a=0;var o=(s=Engine.Assets.sprites[this.sprites.pointer]).fw,r=s.fh,l=s.fh/2,h=4*Engine.scale,c=0;t=t+t*i-o/4,e=e+e*n-r/4,Math.abs(n)>=Math.abs(i)?0<n?e=Engine.height-s.fh-l:(e=0+l,a=o,h+=10*Engine.scale):(0<i?(t=Engine.width-s.fw-l,a=2*o,c=-4*Engine.scale):(t=0+l,a=3*o,c=4*Engine.scale),h+=6*Engine.scale),Engine.canvas.ctx.drawImage(s,0|a,0,o,r,0|t,0|e,o,r),t+=(s.fw-this.nameBuffer.width)/2+c,e+=s.fh/2+h,Engine.canvas.ctx.drawImage(this.nameBuffer,0|t,0|e)},Engine.EntityPlayer.prototype.getFaceDirection=function(){var e=this.data.mx,t=this.data.my,i=this.data.f;0==e&&0==t||this.shoot||this.data.block||(-1==t?i="N":1==t&&(i="S"),-1==e?i="W":1==e&&(i="E"),i!==this.data.f&&(this.data.f=i))},Engine.EntityPlayer.prototype.jump=function(){if(this.inAir){var e=Date.now()-this.jumpedAt;if(this.data.z=18*Math.sin(3.2/550*e)*Engine.scale,550<e){for(this.inAir=!1,this.data.z=0,this.land=Engine.now,e=0;3>e;e++){var t=new Engine.FX.Thud(this.data);t.init(),Engine.Game.addObject(t)}Engine.Game.audio.play("land",this.data)}}},Engine.EntityPlayer.prototype.dodgeRoll=function(){this.dodge&&(350<Date.now()-this.dodgedAt?(this.vD=0,this.dodge=!1):this.vD+=.1*Engine.dt)},Engine.EntityPlayer.prototype.getPhase=function(e,t,i){return 0==e?"corpse":this.telegraph&&200>Engine.now-this.telegraph?"telegraph":this.isHit?"hit":this.slashing?"attack":this.land&&150>Engine.now-this.land?"land":this.inAir?"jump":e=0!=t||0!=i?this.data.block?"sneak":"walk":"idle"},Engine.EntityPlayer.prototype.getOffset=function(e,t,i,n){return{x:(e=Engine.Assets.data.sprites[e].status[t+this.data.f].frames)[i%=e.length][0]*n.fw,y:e[i][1]*n.fh}},Engine.Player=function(e){Engine.Player.prototype.uber.constructor.call(this,e),this.type="player",this.weapons={0:"Melee",1:"Arrow",2:"Shell",3:"Bullet",4:"Rocket",5:"Grenade"},this.delay={Melee:350,Arrow:200,Arrow_ALT:200,Rocket:500,Rocket_ALT:500,Grenade:600,Grenade_ALT:600,Shell:500,Shell_ALT:300,Bullet:250,Bullet_ALT:250},this.staConsume={Melee:8,Arrow:6,Rocket:10,Grenade:12,Shell:10,Bullet:4},this.ammo={last:0,timer:0,Melee:{own:!0,ammo:0},Arrow:{cur:16,max:16,delay:75,own:!1,ammo:0},Rocket:{cur:12,max:12,delay:100,own:!1,ammo:0},Grenade:{cur:10,max:10,delay:150,own:!1,ammo:0},Shell:{cur:10,max:10,delay:200,own:!1,ammo:0},Bullet:{cur:14,max:14,delay:120,own:!1,ammo:0}},this.transmit={},this.fire=!1,this.lastShot=0,this.jumping=this.shoot=this.block=!1,this.lastdodge=this.lastjump=0,this.skillAvailable={1:!1},this.initwarning=0,this.saveHistory=!0,this.lastMove={left:0,right:0,up:0,down:0},this.runTrigger="",this.runTolerance=250,this.stamina=this.staminaMax=200,this.lastBlock=0,this.showStamina=!0,this.wheel=this.weaponSwitch=!1,this.lastSuper=0,this.cast=this.screenshot=!1},Engine.Player.extend(Engine.EntityPlayer),Engine.Player.prototype.onTick=function(e){0<this.stamina&&(this.running&&this.reduceSta(.5*e),this.inAir&&this.reduceSta(.5*e)),!this.running&&!Engine.keys.SHOOT&&!this.shoot&&750<Engine.now-this.lastBlock&&this.stamina<this.staminaMax&&(this.stamina=this.block?this.stamina+.3*e:this.stamina+1.9*e,this.stamina>=this.staminaMax&&(this.stamina=this.staminaMax)),this.uber.onTick.call(this,e)},Engine.Player.prototype.reduceSta=function(e){if("number"==typeof e){0>this.stamina&&(this.stamina=0,this.lastBlock=Engine.now+250,this.block&&(this.data.block=!1,this.transmit.block=!1),this.running&&(this.running=!1,this.addTransmitStatus({run:0})));var t=0<this.stamina;this.stamina-=e,this.lastBlock=Engine.now,t&&0>=this.stamina&&(this.stamina=0,this.lastBlock=Engine.now+250,this.block&&(this.data.block=!1,this.transmit.block=!1),this.running&&(this.running=!1,this.addTransmitStatus({run:0})))}},Engine.Player.prototype.handleInput=function(){var e=!1,t=Engine.now;if(Engine.keys.SCREENSHOT&&!this.screenshot?(this.screenshot=!0,Engine.Game.takeScreenshot()):!Engine.keys.SCREENSHOT&&this.screenshot&&(this.screenshot=!1),!Engine.keys.SKILL1||this.cast||!this.skillAvailable[1]||this.casting||this.inAir||this.block?!Engine.keys.SKILL1&&this.cast&&(this.cast=!1):(this.addTransmitStatus({cast:1}),this.skillAvailable[1]=!1,this.cast=!0,this.casting=t,0!==this.data.mx&&(this.data.mx=0,this.transmit.mx=0),0!==this.data.my&&(this.data.my=0,this.transmit.my=0)),!this.casting){if(Engine.keys.LEFT||this.dodge||(Engine.keys.RIGHT&&1!=this.data.mx?(e=!0,this.data.mx=1,this.running&&"W"===this.runTrigger&&(this.running=!1,this.addTransmitStatus({run:0})),this.stamina&&t-this.lastMove.right<this.runTolerance&&!this.running&&0===this.data.my&&(this.data.block||(this.addTransmitStatus({run:1}),this.running=!0,this.runTrigger="E"),this.shoot||this.data.block)&&(this.lastdodge=Engine.now,this.doDodge(),this.addTransmitStatus({dodge:1}),this.reduceSta(12)),this.lastMove.right=t):Engine.keys.RIGHT||1!=this.data.mx||this.inAir||(e=!0,this.data.mx=0,this.running&&"E"===this.runTrigger&&(this.running=!1,this.addTransmitStatus({run:0})))),Engine.keys.RIGHT||this.dodge||(Engine.keys.LEFT&&-1!=this.data.mx?(e=!0,this.data.mx=-1,this.running&&"E"===this.runTrigger&&(this.running=!1,this.addTransmitStatus({run:0})),this.stamina&&t-this.lastMove.left<this.runTolerance&&!this.running&&0===this.data.my&&(this.data.block||(this.addTransmitStatus({run:1}),this.running=!0,this.runTrigger="W"),this.shoot||this.data.block)&&(this.lastdodge=Engine.now,this.doDodge(),this.addTransmitStatus({dodge:1}),this.reduceSta(12)),this.lastMove.left=t):Engine.keys.LEFT||-1!=this.data.mx||this.inAir||(e=!0,this.data.mx=0,this.running&&"W"===this.runTrigger&&(this.running=!1,this.addTransmitStatus({run:0})))),e&&(this.transmit.mx=this.data.mx,e=!1),Engine.keys.DOWN||this.dodge||(Engine.keys.UP&&-1!=this.data.my?(e=!0,this.data.my=-1,this.running&&"S"===this.runTrigger&&(this.running=!1,this.addTransmitStatus({run:0})),this.stamina&&t-this.lastMove.up<this.runTolerance&&!this.running&&0===this.data.mx&&(this.data.block||(this.addTransmitStatus({run:1}),this.running=!0,this.runTrigger="N"),this.shoot||this.data.block)&&(this.lastdodge=Engine.now,this.doDodge(),this.addTransmitStatus({dodge:1}),this.reduceSta(12)),this.lastMove.up=t):Engine.keys.UP||-1!=this.data.my||this.inAir||(e=!0,this.data.my=0,this.running&&"N"===this.runTrigger&&(this.running=!1,this.addTransmitStatus({run:0})))),Engine.keys.UP||this.dodge||(Engine.keys.DOWN&&1!=this.data.my?(e=!0,this.data.my=1,this.running&&"N"===this.runTrigger&&(this.running=!1,this.addTransmitStatus({run:0})),this.stamina&&t-this.lastMove.down<this.runTolerance&&!this.running&&0===this.data.mx&&(this.data.block||(this.addTransmitStatus({run:1}),this.running=!0,this.runTrigger="S"),this.shoot||this.data.block)&&(this.lastdodge=Engine.now,this.doDodge(),this.addTransmitStatus({dodge:1}),this.reduceSta(12)),this.lastMove.down=t):Engine.keys.DOWN||1!=this.data.my||this.inAir||(e=!0,this.data.my=0,this.running&&"S"===this.runTrigger&&(this.running=!1,this.addTransmitStatus({run:0})))),e&&(this.transmit.my=this.data.my),Engine.keys.JUMP&&!this.jumping&&this.stamina?this.data.block||this.inAir||(this.jumping=!0,this.lastjump=Engine.now,this.doJump(),this.addTransmitStatus({jump:1})):!Engine.keys.JUMP&&this.jumping&&(this.jumping=!1),Engine.keys.WEAPON&&!this.weaponSwitch?(this.weaponSwitch=!0,e=this.weaponList[Engine.keys.WEAPON-1],this.ammo[e].own&&(this.addTransmitStatus({switchTo:Engine.keys.WEAPON-1}),this.data.weapon=e)):!Engine.keys.WEAPON&&this.weaponSwitch&&(this.weaponSwitch=!1),!1!==Engine.keys.WHEEL&&this.block&&(Engine.keys.WHEEL=!1),!1!==Engine.keys.WHEEL){for(e=0;e<this.weaponList.length;e++)if(this.weaponList[e]==this.data.weapon){var i=e;break}for(;;)if(0>(e=i+Engine.keys.WHEEL)&&(e=5),5<e&&(e=0),i=e,e=this.weaponList[e],this.ammo[e].own){e!=this.data.weapon&&(this.addTransmitStatus({switchTo:i}),this.data.weapon=e);break}Engine.keys.WHEEL=!1}Engine.keys.SHOOT&&!this.block&&this.stamina?(i=this.data.weapon,this.running&&(this.running=!1,this.addTransmitStatus({run:0})),0===this.ammo[i].ammo&&"Melee"!=i&&(this.ammo[i].own=!1,this.data.weapon="Melee",i=this.data.weapon,this.addTransmitStatus({switchTo:0})),"Melee"===i?this.slashing||this.dodge||(this.shoot=!0,Engine.now-this.lastShot>=this.delay.Melee&&(this.lastShot=Engine.now,this.reduceSta(1.5*this.staConsume.Melee),i=this.doAttack(this.getRotation()),this.addTransmitStatus({atk:1,r:i}))):Engine.now-this.lastShot>=this.delay[i]&&!this.dodge&&0<this.ammo[i].cur&&(this.shoot=!0,this.lastShot=Engine.now,this.ammo[i].ammo--,this.reduceSta(1.5*this.staConsume[i]),i=this.doShoot({rotation:this.getRotation()}),this.addTransmitStatus({atk:2,r:i}))):(!Engine.keys.SHOOT&&this.shoot||Engine.keys.SHOOT&&this.shoot&&!this.stamina)&&(this.stopShoot(),this.addTransmitStatus({atk:0})),!Engine.keys.BLOCK||this.block||this.data.armor||this.data.invis||!this.stamina||this.running?!Engine.keys.BLOCK&&this.block&&"Melee"==this.data.weapon&&(this.block=!1,this.data.block=!1,this.transmit.block=!1):"Melee"==this.data.weapon&&(Engine.keys.SHOOT&&(Engine.keys.SHOOT=!1),this.block=!0,this.data.block=!0,this.transmit.block=!0)}this.handleTransmit()},Engine.Player.prototype.pickWeapon=function(e,t){this.addTransmitStatus({switchTo:this.weaponList.indexOf(e)}),this.data.weapon=e,this.ammo[e].ammo+=t,this.ammo[e].own=!0,this.block&&(this.block=!1,this.data.block=!1,this.transmit.block=!1)},Engine.Player.prototype.addTransmitStatus=function(e){void 0===this.transmit.status&&(this.transmit.status=[]),this.transmit.status.push(e)},Engine.Player.prototype.handleTransmit=function(){if(0!==Object.size(this.transmit)){var e=Date.now();for(var t in Engine.socket.emit("update",this.transmit,e),this.transmit)delete this.transmit[t]}},Engine.Player.prototype.getRotation=function(){var e=Engine.Assets.tileSize;e=Math.atan2(Engine.keys.MOUSEPOS.y/e+(this.camera.y-5.75)-this.data.y,Engine.keys.MOUSEPOS.x/e+(this.camera.x-10)-this.data.x),e=Math.round(1e3*e)/1e3;return this.updateRotation(e),e},Engine.Player.prototype.drawHUD=function(e){this.updateHpCut(e),this.drawWeaponSelect(),this.drawHUD_Background(),this.drawHUD_Power(),this.drawHUD_Weapon(),this.drawHUD_Coins(),this.drawHUD_Skills()},Engine.Player.prototype.drawHUD_Background=function(){var e,t,i,n,s,a,o,r,l,h,c;n=Engine.Assets.sprites.ui;var d=Engine.canvas.ctx;s=4*Engine.scale|0,a=4*Engine.scale|0,t=128*Engine.scale|0,d.drawImage(n,s,a),s+=2*Engine.scale|0,s+=10*Engine.scale,l=a+10*Engine.scale,0<this.hpCut&&(n=Math.round((this.data.hp+this.hpCut)/this.data.hpMax*100),o=e=0,h=i=0|(i=Math.round(n/100*t))||1,c=r=(n=Engine.Assets.sprites.hp_bar).fh,d.save(),d.globalAlpha=.5,d.drawImage(n,e,o,i,r,s,l,h,c),d.restore()),0<this.data.hp&&(e=Math.round(this.data.hp/this.data.hpMax*100),t=Math.round(e/100*t),n=Engine.Assets.sprites.hp_bar,o=0,(this.isHit||20>=e&&120>Engine.now%240)&&(o=n.fh),i=0|t,r=n.fh,d.drawImage(n,0,o,i,r,s,l,i,r)),a+=Math.ceil(12.5*Engine.scale),s+=62*Engine.scale|0,Engine.text("visitor",this.data.hp+"/"+this.data.hpMax,s,a,!0)},Engine.Player.prototype.drawHUD_Power=function(){var e,t,i,n,s,a=Engine.Assets.sprites.super_bar,o=Engine.canvas.ctx;n=Math.ceil(17*Engine.scale),s=Math.ceil(35*Engine.scale),t=a.width,0<this.data.power&&(e=Math.round(this.data.power/this.data.powerMax*100),t=Math.round(e/100*t),e=0,(this.lastSuper>Engine.now-150||this.data.power==this.data.powerMax&&120>Engine.now%240)&&(e=a.fh),t|=0,i=a.fh,o.drawImage(a,0,e,t,i,n,s,t,i))},Engine.Player.prototype.drawHUD_Weapon=function(){if("Melee"!=this.data.weapon){var e,t,i,n,s,a,o,r,l=Engine.canvas.ctx;o=145*Engine.scale|0,r=4*Engine.scale|0,e=Engine.Assets.sprites.items,i=(i=this.data.weapon+"s").charAt(0).toLowerCase()+i.slice(1),t=Engine.Assets.data.sprites.items.item[i].sx*e.fw|0,i=0|e.fw,n=0|e.fh,s=o+4*Engine.scale|0,a=r+4*Engine.scale|0,l.drawImage(e,t,0,i,n,s,a,i,n),t=0|(e=Engine.Assets.sprites.item_back).fh,i=0|e.fw,n=0|e.fh,l.drawImage(e,0,t,i,n,o,r,i,n),o+=47*Engine.scale|0,r+=25*Engine.scale|0,Engine.text("semplice",this.ammo[this.data.weapon].ammo,o,r,!0)}},Engine.Player.prototype.drawHUD_Coins=function(){var e,t,i,n,s,a;e=this.data.coins,s=42*Engine.scale,a=46*Engine.scale,i=.75*(t=Engine.Assets.sprites.coin).fw,n=.75*t.fh,Engine.canvas.ctx.drawImage(t,0,0,t.fw,t.fh,s,a,i,n),s+=i+2*Engine.scale,a+=n/8,t="visitor",250>=Engine.now-this.coinGet&&(t="visitorLarge",a-=Engine.Assets.fonts.visitorLarge.fh/8),Engine.text(t,e,s,a,!1)},Engine.Player.prototype.drawHUD_Skills=function(){var e,t,i,n,s,a,o=Engine.Assets.sprites.skills,r=Engine.Assets.data.sprites.skills.skill,l=Engine.canvas.ctx;t=e=0,i=o.fw,n=o.fh,s=4*Engine.scale,a=46*Engine.scale,"war"==this.data.job?e=r.armor.sx*i:"rog"==this.data.job?e=r.trap.sx*i:"mag"==this.data.job&&(e=r.invis.sx*i),this.skillAvailable[1]||(t=n),l.drawImage(o,e,t,i,n,s,a,i,n)},Engine.Player.prototype.expLevel=function(e){for(var t={total:0,next:10*e},i=1;i<e;i++)t.total+=10*i|0;return t},Engine.Player.prototype.drawExp=function(){var e=Engine.width,t=4*Engine.scale,i=Engine.height-t,n=Engine.canvas.ctx,s=Math.round((this.data.exp-this.expLevel(this.data.level).total)/this.expLevel(this.data.level).next*100);e=Math.round(s/100*e);n.fillStyle="#f1cd01",n.fillRect(0,i,e,t)},Engine.Player.prototype.drawSkills=function(){var e,t,i,n,s,a,o=Engine.Assets.sprites.skills,r=Engine.Assets.data.sprites.skills.skill,l=Engine.canvas.ctx;t=e=0,i=o.fw,n=o.fh,s=2*Engine.scale,a=64*Engine.scale,"war"==this.data.job?e=r.armor.sx*i:"rog"==this.data.job?e=r.trap.sx*i:"mag"==this.data.job&&(e=r.invis.sx*i),this.skillAvailable[1]||(t=n),l.drawImage(o,e,t,i,n,s,a,i,n)},Engine.Player.prototype.drawWeaponSelect=function(){var e,t,i,n,s,a,o=Engine.Assets.sprites.weaponselect,r=Engine.Assets.data.sprites.weaponselect,l=Engine.canvas.ctx;i=o.fw,n=o.fh;for(var h=0;6>h;h++)a=Engine.height-n-2*Engine.scale,t=2*o.fh,e=this.data.weapon==r.weapons[h]?o.fw:this.ammo[r.weapons[h]].own?2*o.fw:0,s=Engine.wH-6*o.fw/2+h*o.fw,l.drawImage(o,0|e,0|t,i-2*Engine.scale|0,0|n,0|s,0|a,0|i,0|n),t=0,this.ammo[r.weapons[h]].own&&(e=o.fw*h,s=Engine.wH-6*o.fw/2+h*o.fw,l.drawImage(o,0|e,0|t,0|i,0|n,0|s,0|a,0|i,0|n)),t=o.fh,e=o.fw*h,this.data.weapon!=r.weapons[h]&&(s+=2*Engine.scale,a-=2*Engine.scale),l.drawImage(o,0|e,0|t,0|i,0|n,0|s,0|a,0|i,0|n),Engine.text("semplice",h+1,s+3*Engine.scale,a+24*Engine.scale)},Engine.Player.prototype.drawHP=function(){var e,t,i,n,s,a,o,r,l,h=Engine.Assets.sprites.hp_back,c=Engine.canvas.ctx;s=2*Engine.scale|0,a=12*Engine.scale|0,t=128*Engine.scale|0,c.drawImage(h,s,a),s+=2*Engine.scale|0,0<this.hpCut&&(n=Math.round((this.data.hp+this.hpCut)/this.data.hpMax*100),i=Math.round(n/100*t),n=e=0,r=i=0|i||1,l=o=(h=Engine.Assets.sprites.hp_bar).fh,c.save(),c.globalAlpha=.5,c.drawImage(h,e,n,i,o,s,a,r,l),c.restore()),0<this.data.hp&&(e=Math.round(this.data.hp/this.data.hpMax*100),n=0,i=0|(t=Math.round(e/100*t)),o=(h=Engine.Assets.sprites.hp_bar).fh,(this.isHit||10>=e&&120>Engine.now%240)&&(n=o),c.drawImage(h,0,n,i,o,s,a,i,o)),a+=Math.ceil(2.5*Engine.scale),s+=h.fw/2|0,Engine.text("visitor",this.data.hp+"/"+this.data.hpMax,s,a,!0)},Engine.Player.prototype.drawWeapon=function(){var e,t,i,n,s,a,o,r,l=Engine.canvas.ctx;o=136*Engine.scale|0,r=2*Engine.scale|0,i=(e=Engine.Assets.sprites.item_back).fw,n=e.fh,l.drawImage(e,0,0,i,n,o,r,i,n),e=Engine.Assets.sprites.items,i=(i=this.data.weapon+"s").charAt(0).toLowerCase()+i.slice(1),t=Engine.Assets.data.sprites.items.item[i].sx*e.fw|0,i=0|e.fw,n=0|e.fh,s=o+4*Engine.scale|0,a=r+4*Engine.scale|0,l.drawImage(e,t,0,i,n,s,a,0|i,0|n),"Melee"!=this.data.weapon&&(t=(e=Engine.Assets.sprites.item_back).fh,i=e.fw,n=e.fh,l.drawImage(e,0,t,i,n,o,r,i,n),o+=48*Engine.scale|0,r+=26*Engine.scale|0,Engine.text("miniset2",this.ammo[this.data.weapon].ammo,o,r,!0))},Engine.Player.prototype.drawKD=function(){Engine.text("visitor",this.data.kills+"-"+this.data.deaths,Engine.width-64*Engine.scale|0,4*Engine.scale|0,!1)},Engine.Player.prototype.drawCoins=function(){var e,t,i,n,s,a;e=this.data.coins,s=6*Engine.scale,a=36*Engine.scale,i=.75*(t=Engine.Assets.sprites.coin).fw,n=.75*t.fh,Engine.canvas.ctx.drawImage(t,0,0,t.fw,t.fh,s,a,i,n),s+=i+2*Engine.scale,a+=n/8,t="visitor",250>=Engine.now-this.coinGet&&(t="visitorLarge",a-=Engine.Assets.fonts.visitorLarge.fh/8),Engine.text(t,e,s,a,!1)},Engine.Player.prototype.checkHealth=function(){10>=Math.round(this.data.hp/this.data.hpMax*100)?(this.warning(this.data),1===this.initwarning&&Engine.webaudio&&(Engine.audio.buses.biquad.frequency.value=500,this.initwarning=2)):0!==this.initwarning&&2!==this.initwarning||!Engine.webaudio||(Engine.audio.buses.biquad.frequency.value=22050,this.initwarning=1)},Engine.Player.prototype.updateHpCut=function(e){0<this.hpCut&&(this.hpCut-=.5*e,0>this.hpCut&&(this.hpCut=0))},Engine.Player.prototype.warning=function(e){var t,i,n,s,a,o,r,l,h=e.x+.5|0,c=e.y+.5|0,d=Engine.Assets.tilesets[0].fw,g=Engine.canvas.ctx;for(r=e.x-h+1.5,l=e.y-c+.5,i=0;13>i;i++)for(o=i+c-6,t=0;22>t;t++)a=t+h-11,n=~~((n=(t-r)*d)+.5)+(n>>31),s=~~((s=(i-l)*d)+.5)+(s>>31),0<(a=(a=Engine.lineDistance({x:e.x,y:e.y},{x:a,y:o}))/20*(a/(Engine.now%1e3/75)))&&(g.fillStyle="rgba(210, 0, 0, "+a+")",g.fillRect(n,s,0|d,0|d))},Engine.Player.prototype.hit=function(e){this.isHit&&(e.data.x+=(Math.random()-.5)/4,e.data.y+=(Math.random()-.5)/4)},Engine.Player.prototype.shake=function(e){if(this.isShake){var t=Engine.rand(0,20)-10;e.data.x+=t/150,e.data.y+=(10-Math.abs(t))/150*(0>t?-1:1)}},Engine.Spectator=function(e){Engine.Spectator.prototype.uber.constructor.call(this,e),this.data.mod_speed=.05,this.light=this.collidable=!1,Engine.Spectator=this},Engine.Spectator.extend(Engine.Player),Engine.Spectator.prototype.onTick=function(e){},Engine.Spectator.prototype.draw=function(e){},Engine.Spectator.prototype.handleTransmit=function(){for(var e in this.transmit)delete this.transmit[e]},Engine.Spectator.prototype.drawHUD=function(e){},Engine.Spectator.prototype.move=function(e,t){var i=this.data.mod_speed;this.velX=this.data.mx,this.newPos.x=this.data.x+this.velX*i*e,this.velY=this.data.my,this.newPos.y=this.data.y+this.velY*i*e,this.newPos.x=Math.round(1e4*this.newPos.x)/1e4,this.newPos.y=Math.round(1e4*this.newPos.y)/1e4,this.newPos.x!==this.data.x&&(this.data.x=this.newPos.x),this.newPos.y!==this.data.y&&(this.data.y=this.newPos.y)},Engine.Npc=function(e){Engine.Npc.prototype.uber.constructor.call(this,e),this.type="npc",this.illuLighting=this.illuLight=null,this.light="light_npc"},Engine.Npc.extend(Engine.EntityPlayer),Engine.Npc.prototype.init=function(){switch(this.data.subtype){case 1:case 12:this.sprites={player:"skeleton",hand_main:!1,hand_off:!1,pointer:!1};break;case 11:this.sprites={player:"skeleton",hand_main:"weapon_sword1",hand_off:"shield_red",pointer:!1};break;case 2:case 22:this.sprites={player:"goblin",hand_main:!1,hand_off:!1,pointer:!1};break;case 21:this.sprites={player:"goblin",hand_main:"weapon_dagger1",hand_off:"shield_green",pointer:!1};break;case 3:this.sprites={player:"slime",hand_main:!1,hand_off:!1,pointer:!1};break;case 31:this.sprites={player:"slime_green",hand_main:!1,hand_off:!1,pointer:!1};break;case 32:this.sprites={player:"slime_red",hand_main:!1,hand_off:!1,pointer:!1};break;case 4:this.sprites={player:"bat",hand_main:!1,hand_off:!1,pointer:!1};break;case 5:case 52:this.sprites={player:"thief",hand_main:!1,hand_off:!1,pointer:!1};break;case 51:this.sprites={player:"thief",hand_main:"weapon_dagger1",hand_off:"shield_green",pointer:!1};break;case 99:this.sprites={player:"treasure",hand_main:!1,hand_off:!1,pointer:"pointer_treasure"}}this.initNameBuffer("#2b2b2b")},Engine.Npc.prototype.update=function(e,t){-1==this.data.alive?this.leave():(this.ticker(e),this.inAir&&this.jump(),this.dodge&&this.dodgeRoll(),this.data.invincible&&(this.data.invincible-=Engine.deltaT,0>=this.data.invincible&&(this.data.invincible=!1)),this.updateStatus(),this.move(e,t),this.getFaceDirection(),this.onTick(e))},Engine.Npc.prototype.draw=function(e,t,i,n){if(1==this.data.alive){var s,a,o,r,l,h=Engine.Assets.sprites[this.sprites.player];if(r=h.fw,l=h.fh,e=(s=this.coordToScreen(e,h)).x,s=s.y-this.data.z,this.inViewPointer(r,l,e,s,r,l)||i.fog||!this.sprites.pointer||this.pointerSet||(this.pointerSet=!0,(i=new Engine.FX.Pointer(this.data,this.sprites,this.drawPointer,this.nameBufferPointer)).init(),Engine.Game.addObjectOverlay(i)),this.inView(r,l,e,s,r,l)){this.sprites.pointer&&this.pointerSet&&this.inViewPointer(r,l,e,s,r,l)&&(this.pointerSet=!1),i=0,a=this.frame;var c=Engine.Assets.tileSize,d=Engine.canvas.ctx;this.data.invis&&(d.globalAlpha=n?.5:0),n=this.getPhase(this.data.alive,this.data.mx,this.data.my),o=this.getOffset(this.sprites.player,n,a,h),0!=a%2||0==this.data.mx&&0==this.data.my||this.inAir||(i=1*Engine.scale),a=o.x,o=o.y,"hit"==n&&(e+=5*(Math.random()-.5),s+=5*(Math.random()-.5)),this.data.invincible&&2>this.tick%6&&(d.globalAlpha=0),this.drawShadow(c,r,l,e,s,r,l),"N"==this.data.f&&this.drawWeapons(e,s,i,n),this.dodge?(d.save(),d.translate(e+r/2,s+l/2),d.rotate(3.145*this.vD*(-1==this.data.mx?-1:1)),d.drawImage(h,a,o,r,l,-r/2,-l/2,r,l),d.restore()):d.drawImage(h,0|a,0|o,0|r,0|l,0|e,s+i|0,r,0|l),"N"!=this.data.f&&this.drawWeapons(e,s,i,n),h.fw<=c&&!this.inAir&&this.drawGrass(t,e,s,r,l,i),this.data.block&&this.drawBlocKBubble(e,s,r,l),this.data.armor&&this.drawArmorBubble(e,s,r,l),this.drawName(e+r/2,s,!1),99!==this.data.subtype&&this.drawHP(e,s,c),d.globalAlpha=1}}},Engine._FX=function(e){Engine._FX.prototype.uber.constructor.call(this,e),this.duration=0,this.asset=null,this.animated=!1,this.offsetY=this.offsetX=this.timer=this.frames=this.frame=0,this.opacity=1,this.sy=this.sx=0},Engine._FX.extend(Engine.Entity),Engine._FX.prototype.init=function(){this.created=Engine.now,this.durationT=this.duration*Engine.frameStep|0,this.asset&&this.asset.fw<this.asset.width&&(this.animated=!0,this.frames=this.asset.width/this.asset.fw|0,this.animationTick=0,this.timer=this.durationT/this.frames)},Engine._FX.prototype.update=function(e){this.ticker(e),this.tickT>=this.durationT&&(this.kill=!0),this.animated&&(this.animationTick+=Engine.deltaT,this.animationTick>this.timer&&(this.animationTick=0,this.frame++)),this.onTick(e)},Engine._FX.prototype.onTick=function(e){},Engine._FX.prototype.draw=function(e){var t,i,n,s,a,o=Engine.canvas.ctx;i=this.animated?this.frame%this.frames*this.asset.fw|0:0,n=this.sy,s=0|this.asset.fw,a=0|this.asset.fh,e=(t=this.coordToScreen(e,this.asset)).x,t=t.y,e+=this.offsetX?this.offsetX:0,t+=this.offsetY?this.offsetY:0,this.inView(s,a,e,t,s,a)&&(e|=0,t|=0,1!=this.opacity?(o.save(),o.globalAlpha=this.opacity,o.drawImage(this.asset,i,n,s,a,e,t,s,a),o.restore()):o.drawImage(this.asset,i,n,s,a,e,t,s,a))},Engine.FX={},Engine.FX.Spark=function(e){Engine.FX.Spark.prototype.uber.constructor.call(this),this.duration=Engine.rand(30,200),this.data.x=Engine.rand(0,1.125*Engine.width),this.data.y=Engine.rand(.125*Engine.height,1.125*Engine.height),this.size=Engine.rand(8,20)/10*Engine.scale,this.velX=Engine.rand(6,16)/20*Engine.scale,this.velY=Engine.rand(6,10)/20*Engine.scale,this.color=Engine.rand(75,150),this.colorR=2*this.color|0,this.colorG=this.color*(Engine.rand(10,15)/10)|0,this.colorB=this.color,this.alpha=.01*Engine.rand(30,80),this.opacity=0,this.w=2*this.size,this.h=2*this.size,this.bigger=!1},Engine.FX.Spark.extend(Engine._FX),Engine.FX.Spark.prototype.onTick=function(e){if((this.data.x<0-10*this.w||this.data.x>2*Engine.width||this.data.y<0-10*this.h||this.data.y>2*Engine.height)&&(this.kill=!0),this.tickT<this.durationT/5)this.opacity+=.01*e,this.opacity>this.alpha&&(this.opacity=this.alpha);else if(this.tickT>this.durationT/1.2&&(this.opacity-=.01*e,0>this.opacity))return this.opacity=0,void(this.kill=!0);this.data.x-=this.velX*e,this.data.y-=this.velY*e},Engine.FX.Spark.prototype.drawLight=function(e,t,i){var n,s,a,o=Engine.Assets.sprites.light_npc,r=Engine.canvas.ctx;a=(n=o.fw)/100*i|0,i=(s=o.fh)/100*i|0,r.globalAlpha=.15,r.drawImage(o,0,0,n,s,e-(a/2|0),t-(i/2|0),a,i),r.globalAlpha=1},Engine.FX.Spark.prototype.draw=function(){var e,t,i,n,s=Engine.canvas.ctx;i=0|this.w,n=0|this.h,e=0|this.data.x,t=0|this.data.y,s.save(),this.drawLight(e,t,100*this.opacity),s.fillStyle="rgba("+this.colorR+", "+this.colorG+", "+this.colorB+", "+this.opacity+")",s.fillRect(e,t,i,n),s.restore()},Engine.FX.Smoketrail=function(e,t){Engine.FX.Smoketrail.prototype.uber.constructor.call(this),this.data.x=e.x-.25,this.data.y=e.y+.25,this.duration=40,this.asset=Engine.Assets.sprites.smoketrail,this.velX=.01*(Math.random()-.5),this.velY=-.015*Math.random(),this.opacity=1},Engine.FX.Smoketrail.extend(Engine._FX),Engine.FX.Smoketrail.prototype.onTick=function(e){this.data.x+=this.velX*e,this.data.y+=this.velY*e,this.tickT>=.5*this.durationT&&0<this.opacity&&(this.opacity-=.04*e,0>this.opacity&&(this.opacity=0))},Engine.FX.Smoketrail.prototype.draw=function(e){var t,i,n,s,a,o,r=Engine.canvas.ctx;i=this.animated?this.frame%this.frames*this.asset.fw|0:0,n=0|this.asset.fw,s=0|this.asset.fh,t=this.coordToScreen(e,this.asset),a=n*this.opacity|0,o=s*this.opacity|0,e=t.x+(n-a/2),t=t.y,this.inView(n,s,e,t,a,o)&&r.drawImage(this.asset,i,0,n,s,0|e,0|t,a,o)},Engine.FX.Fire=function(e,t){Engine.FX.Fire.prototype.uber.constructor.call(this),this.data.x=e.x-.25,this.data.y=e.y+.25+.5,this.duration=30,this.asset=Engine.Assets.sprites.fire,this.sy=Engine.rand(0,1)*this.asset.fh,this.velX=.01*(Math.random()-.5),this.velY=-.015*Math.random(),this.opacity=1,this.offsetY=-16*Engine.scale},Engine.FX.Fire.extend(Engine._FX),Engine.FX.Fire.prototype.onTick=function(e){this.data.x+=this.velX*e,this.data.y+=this.velY*e},Engine.FX.Fire.prototype.draw=function(e){var t,i,n,s,a,o=Engine.canvas.ctx;i=this.animated?this.frame*this.asset.fw|0:0,n=this.sy,s=0|this.asset.fw,a=0|this.asset.fh,e=(t=this.coordToScreen(e,this.asset)).x+(s-s/2),t=t.y,this.inView(s,a,e,t,s,a)&&(e+=this.offsetX?this.offsetX:0,t+=this.offsetY?this.offsetY:0,o.drawImage(this.asset,i,n,s,a,0|e,0|t,s,a))},Engine.FX.Pointer=function(e,t,i,n){Engine.FX.Pointer.prototype.uber.constructor.call(this,e),this.sprites=t,this.asset=Engine.Assets.sprites[this.sprites.player],this.drawPointer=i,this.nameBuffer=n},Engine.FX.Pointer.extend(Engine._FX),Engine.FX.Pointer.prototype.update=function(){1!==this.data.alive&&(this.kill=!0)},Engine.FX.Pointer.prototype.draw=function(e){var t,i,n;this.data.invis||(i=(t=this.asset).fw,n=t.fh,e=(t=this.coordToScreen(e,t)).x,t=t.y-this.data.z,this.inViewPointer(i,n,e,t,i,n)?this.kill=!0:this.drawPointer(i,n,e,t,i,n))},Engine.FX.Thud=function(e,t){Engine.FX.Thud.prototype.uber.constructor.call(this),this.data.x=e.x-.25,this.data.y=e.y+.25,this.duration=40,this.asset=Engine.Assets.sprites.smoketrail,this.velX=.4*(Math.random()-.5),this.velY=-.015*Math.random(),this.opacity=1,this.size=t||1},Engine.FX.Thud.extend(Engine._FX),Engine.FX.Thud.prototype.onTick=function(e){this.velX*=.8,this.data.x+=this.velX*e,this.data.y+=this.velY*e,this.tickT>=.5*this.durationT&&0!=this.opacity&&(this.opacity-=.04*e,0>this.opacity&&(this.opacity=0))},Engine.FX.Thud.prototype.draw=function(e){var t,i,n,s,a,o,r=Engine.canvas.ctx;i=this.animated?this.frame%this.frames*this.asset.fw|0:0,n=0|this.asset.fw,s=0|this.asset.fh,t=this.coordToScreen(e,this.asset),a=n*this.opacity*this.size|0,o=s*this.opacity*this.size|0,e=t.x+(n-a/2),t=t.y,t-=(this.size-1)*this.asset.fh,this.inView(n,s,e,t,a,o)&&r.drawImage(this.asset,i,0,n,s,0|e,0|t,a,o)},Engine.FX.Explode2=function(e,t){Engine.FX.Explode2.prototype.uber.constructor.call(this),this.data.x=e.x-.25,this.data.y=e.y+.25,this.duration=40,this.asset=Engine.Assets.sprites.explode2,this.velX=.4*(Math.random()-.5),this.velY=-.015*Math.random(),this.opacity=1,this.size=t||1},Engine.FX.Explode2.extend(Engine._FX),Engine.FX.Explode2.prototype.onTick=function(e){this.velX*=.8,this.data.x+=this.velX*e,this.data.y+=this.velY*e,this.tickT>=.5*this.durationT&&0!=this.opacity&&(this.opacity-=.04*e,0>this.opacity&&(this.opacity=0))},Engine.FX.Explode2.prototype.draw=function(e){var t,i,n,s,a,o,r=Engine.canvas.ctx;i=this.animated?this.frame%this.frames*this.asset.fw|0:0,n=0|this.asset.fw,s=0|this.asset.fh,t=this.coordToScreen(e,this.asset),a=n*this.opacity*this.size|0,o=s*this.opacity*this.size|0,e=t.x+(n-a/2),t=t.y,t-=(this.size-1)*this.asset.fh,this.inView(n,s,e,t,a,o)&&r.drawImage(this.asset,i,0,n,s,0|e,0|t,a,o)},Engine.FX.Explode3=function(e,t){Engine.FX.Explode3.prototype.uber.constructor.call(this),this.data.x=e.x,this.data.y=e.y,this.duration=32,this.asset=Engine.Assets.sprites.explode3,this.opacity=1,this.size=t||1},Engine.FX.Explode3.extend(Engine._FX),Engine.FX.Explode3.prototype.onTick=function(e){},Engine.FX.Explode3.prototype.draw=function(e){var t,i,n,s,a,o,r=Engine.canvas.ctx;i=this.animated?this.frame%this.frames*this.asset.fw|0:0,n=0|this.asset.fw,s=0|this.asset.fh,t=this.coordToScreen(e,this.asset),a=n*this.size|0,o=s*this.size|0,e=t.x,t=t.y+o/4,this.inView(n,s,e,t,a,o)&&r.drawImage(this.asset,i,0,n,s,0|e,0|t,a,o)},Engine.FX.Slash=function(e){Engine.FX.Slash.prototype.uber.constructor.call(this,e),this.duration=12,this.asset=Engine.Assets.sprites["slash_"+this.data.f],this.offsetY=20*Engine.scale,this.offsetX=0,this.sy=Engine.rand(0,1)*this.asset.fh},Engine.FX.Slash.extend(Engine._FX),Engine.FX.Slash.prototype.onTick=function(e){"E"==this.data.f?this.offsetX+=1*Engine.scale*e:"W"==this.data.f?this.offsetX-=1*Engine.scale*e:"S"==this.data.f?this.offsetY+=1*Engine.scale*e:"N"==this.data.f&&(this.offsetY-=1*Engine.scale*e)},Engine.FX.Slash.prototype.draw=function(e){var t,i,n,s,a,o=Engine.canvas.ctx;i=this.animated?this.frame*this.asset.fw|0:0,n=this.sy,s=0|this.asset.fw,a=0|this.asset.fh,e=(t=this.coordToScreen(e,this.asset)).x,t=t.y,e+=this.offsetX?this.offsetX:0,t+=this.offsetY?this.offsetY:0,this.inView(s,a,e,t,s,a)&&o.drawImage(this.asset,i,n,s,a,0|e,0|t,s,a)},Engine.FX.Item=function(e){Engine.FX.Item.prototype.uber.constructor.call(this,e),this.duration=e.duration,this.asset=Engine.Assets.sprites.items,this.type="item",this.type2=e.type,this.id=e.id,this.data.z=0,this.light=!1,this.offsetY=6*Engine.scale,"trap"==this.type2&&(this.offsetY=16*Engine.scale),this.collidable=this.helper=!1,this.tickLife=0,this.floating="coin"!==this.type2&&"trap"!==this.type2},Engine.FX.Item.extend(Engine._FX),Engine.FX.Item.prototype.init=function(){if("coin"==this.type2)this.asset=Engine.Assets.sprites.item_coin,this.uber.init.call(this),this.timer=3,this.frame=Engine.rand(0,6);else{if("trap"!==this.type2){var e=new Engine.FX.PickupHint(this);e.init(),Engine.Game.addObjectOverlay(e),this.helper=e}(e=Engine.Assets.data.sprites.items.item[this.type2])&&(this.frame=e.sx,this.light=!!e.light&&"light_npc")}},Engine.FX.Item.prototype.remove=function(){this.kill=!0,this.helper&&(this.helper.kill=!0)},Engine.FX.Item.prototype.update=function(e){this.ticker(e),this.tickLife+=e,this.tickLife>=this.duration&&this.remove(),this.animated&&(this.animationTick+=Engine.deltaT,this.animationTick>this.timer*Engine.frameStep&&(this.animationTick=0,this.frame++)),this.onTick(e),"coin"===this.type2&&this.move(e),this.floating&&(this.data.z+=.09*e)},Engine.FX.Item.prototype.onTick=function(e){},Engine.FX.Item.prototype.magnet=function(e){var t,i,n=Engine.Game.getCollidableObjects();for(t in n)if("player"===(i=n[t]).data.type&&1===i.data.alive&&!i.inAir&&1.4>Engine.lineDistance(i.data,this.data)){var s=!1,a=!1;this.data.x>i.data.x?(this.data.x-=.08*e,this.data.x<i.data.x&&(this.data.x=i.data.x)):this.data.x<i.data.x?(this.data.x+=.08*e,this.data.x>i.data.x&&(this.data.x=i.data.x)):s=!0,this.data.y>i.data.y?(this.data.y-=.08*e,this.data.y<i.data.y&&(this.data.y=i.data.y)):this.data.y<i.data.y?(this.data.y+=.08*e,this.data.y>i.data.y&&(this.data.y=i.data.y)):a=!0,s&&a&&(this.kill=!0)}},Engine.FX.Item.prototype.move=function(e){var t;"coin"===this.type2&&500<Engine.now-this.created&&this.magnet(e),t={x:this.data.x+this.data.mx*this.data.vel*e,y:this.data.y+this.data.my*this.data.vel*e,cx:!1,cy:!1},Engine.Game.collision(this.data,t),(t.cx||t.cy)&&this.collideWorld(t.cx,t.cy),t.x=Math.round(1e3*t.x)/1e3,t.y=Math.round(1e3*t.y)/1e3,t.x!==this.data.x&&(this.data.x=t.x),t.y!==this.data.y&&(this.data.y=t.y),this.data.vel-=.002*e,0>this.data.vel&&(this.data.vel=0),t.cx=!1,t.cy=!1},Engine.FX.Item.prototype.collide=function(e){"player"===e.type&&this.remove()},Engine.FX.Item.prototype.collideWorld=function(e,t){e&&(this.data.mx*=-1),t&&(this.data.my*=-1),this.vel=this.vel/4*3},Engine.FX.Item.prototype.drawLight=function(e){var t,i=Engine.Assets.sprites[this.light],n=Engine.canvas.ctx,s=this.asset,a=this.coordToScreen(e,s);e=s.fw,s=s.fh,t=a.x,a=a.y,t+=this.offsetX?this.offsetX:0,a+=this.offsetY?this.offsetY:0,this.inView(e,s,t,a,e,s)&&(t=t+(e-i.fw)/2|0,a=a+(s-i.fh)/2|0,n.save(),n.globalCompositeOperation="lighter",n.drawImage(i,t,a),n.restore())},Engine.FX.Item.prototype.drawShadow=function(e,t,i,n,s,a,o){n=n+(a-(e=Engine.Assets.sprites.shadow).fw)/2|0,s=s+o-e.fh/2|0,Engine.canvas.ctx.drawImage(e,n,s)},Engine.FX.Item.prototype.draw=function(e){var t,i,n,s,a;t=this.frames?this.frame%this.frames*this.asset.fw|0:this.frame*this.asset.fw|0,i=0|this.asset.fw,n=0|this.asset.fh,s=(e=this.coordToScreen(e,this.asset)).x,a=this.floating?e.y+2*Math.sin(this.data.z)*Engine.scale-3*Engine.scale:e.y,s+=this.offsetX?this.offsetX:0,a+=this.offsetY?this.offsetY:0,this.inView(i,n,s,a,i,n)&&(s|=0,a|=0,this.tickLife>this.duration/4*3&&2>this.tick%6||(this.floating&&this.drawShadow(i,i,n,e.x,e.y,i,n),Engine.canvas.ctx.drawImage(this.asset,t,0,i,n,s,a,i,n)))},Engine.FX.Pickup=function(e,t){Engine.FX.Pickup.prototype.uber.constructor.call(this),this.odata=e,this.data={x:this.odata.x,y:this.odata.y,z:this.odata.z},this.duration=60,this.asset=Engine.Assets.sprites.items,this.sx=Engine.Assets.data.sprites.items.item[t].sx*this.asset.fw|0,this.sy=0,this.offsetY=.6*this.asset.fh},Engine.FX.Pickup.extend(Engine._FX),Engine.FX.Pickup.prototype.onTick=function(e){this.data.x=this.odata.x,this.data.y=this.odata.y+.001,this.data.z=this.odata.z,this.offsetY+=.5*Engine.scale*e},Engine.FX.Pickup.prototype.draw=function(e){var t,i,n,s,a,o,r,l=Engine.canvas.ctx;i=this.sx,n=this.sy,o=.75*(s=0|this.asset.fw),r=.75*(a=0|this.asset.fh),e=(t=this.coordToScreen(e,this.asset)).x+.25*s/2,t=t.y-this.data.z,t-=this.offsetY?this.offsetY:0,e+=this.offsetX?this.offsetX:0,this.inView(s,a,e,t,o,r)&&(e|=0,t|=0,l.save(),l.globalAlpha=1-100/this.duration*this.tick/100,l.drawImage(this.asset,i,n,s,a,e,t,o,r),l.restore())},Engine.FX.GameInfo=function(e){Engine.FX.GameInfo.prototype.uber.constructor.call(this),this.msg=e,this.duration=200,this.offsetY=16*Engine.scale+Engine.Game.getMessageLength(),this.offsetY2=0,this.opacity=1.8},Engine.FX.GameInfo.extend(Engine._FX),Engine.FX.GameInfo.prototype.onTick=function(e){this.tickT>this.durationT/1.5&&0<this.opacity&&(this.opacity-=.05*e,0>this.opacity&&(this.opacity=0)),0==this.opacity&&(this.kill=!0),this.offsetY2-=.16*Engine.scale*e},Engine.FX.GameInfo.prototype.draw=function(e){var t,i=Engine.canvas.ctx;t=64*Engine.scale+this.offsetY+this.offsetY2,i.save(),i.globalAlpha=this.opacity,e=Engine.wH-Engine.Assets.fonts.visitor.fw/2;var n=1-200/this.duration*4*this.tick/100;n=Math.max(0,n);Engine.text("visitor",this.msg,e,t,!0,n),i.restore()},Engine.FX.Damage=function(e,t,i){Engine.FX.Damage.prototype.uber.constructor.call(this),this.data.x=e.x+.25,this.data.y=e.y-.2*Math.random(),this.oldY=e.y,this.duration=60,this.asset=Engine.Assets.fonts[t],this.text=i,this.font=t,this.offsetY=-1.5,this.offsetYextra=.5,this.opacity=1.5,this.velX=Math.random()-.5,this.velY=-1,this.floored=!1},Engine.FX.Damage.extend(Engine._FX),Engine.FX.Damage.prototype.onTick=function(e){this.offsetYextra*=1.6/e*.3,this.opacity-=.024*e,0>this.opacity?this.opacity=0:(this.data.x+=.05*this.velX,this.data.y<this.oldY+1.75&&(this.velY+=.1*e,this.data.y+=.05*this.velY,this.data.y>=this.oldY+1.75&&(this.data.y=this.oldY+1.75,this.velX*=.5)))},Engine.FX.Damage.prototype.draw=function(e){var t=Engine.canvas.ctx;(e=this.coordToScreen(e,this.asset)).y+=(this.offsetY+this.offsetYextra)*Engine.Assets.tileSize,this.inView(Engine.Assets.tileSize,Engine.Assets.tileSize,e.x,e.y,void 0,void 0)&&(t.save(),t.globalAlpha=this.opacity,Engine.text(this.font,this.text,e.x,e.y,!0),t.restore())},Engine.FX.Smoke=function(e){Engine.FX.Smoke.prototype.uber.constructor.call(this),this.data.x=e.x,this.data.y=e.y,this.duration=Engine.rand(60,70),this.size=Engine.rand(4,8)*Engine.scale,this.vel=Engine.rand(10,16)/2e3,this.color=Engine.rand(50,130),this.alpha=1,this.opacity=0,this.velT=Engine.rand(10,30)/100,this.h=this.w=this.size,this.bigger=!1,this.asset=Engine.Assets.sprites.explode2,this.set=Math.round(Math.random()),this.offsetX=-.25*Engine.Assets.tileSize,this.offsetY=-.25*Engine.Assets.tileSize},Engine.FX.Smoke.extend(Engine._FX),Engine.FX.Smoke.prototype.onTick=function(e){this.tickT<.2*this.durationT?(this.opacity=1/(.2*this.durationT)*this.tickT,1<this.opacity&&(this.opacity=1)):this.tickT>.6*this.durationT&&(this.opacity=-1*(1/(.4*this.durationT)*(this.tickT-.6*this.durationT)-1),0>this.opacity&&(this.opacity=0)),this.data.x-=this.vel/2*e,this.data.y-=2*this.vel*e},Engine.FX.Smoke.prototype.draw=function(e){var t,i,n,s=Engine.canvas.ctx;if(sx=this.animated?this.frame%this.frames*this.asset.fw|0:0,i=0|this.w,n=0|this.h,e=(t=this.coordToScreen(e,this.asset)).x+this.offsetX,t=t.y+this.offsetY,this.inView(i,n,e,t,i,n)){var a=this.asset;i=1.5*a.fw*this.opacity|0,n=1.5*a.fh*this.opacity|0,e+=a.fw-i/2,t+=a.fh-n/2,s.drawImage(this.asset,sx,0,a.fw,a.fh,0|e,0|t,i,n)}},Engine.FX.Explode=function(e){Engine.FX.Explode.prototype.uber.constructor.call(this),this.data.x=e.x,this.data.y=e.y,this.duration=120,this.asset=Engine.Assets.sprites.smoketrail,this.velX=.3*(Math.random()-.5),this.velY=.2*(Math.random()-.5),this.opacity=1,this.size=2},Engine.FX.Explode.extend(Engine._FX),Engine.FX.Explode.prototype.onTick=function(e){this.velX*=.88,this.velY*=.82,this.data.x+=this.velX,this.data.y+=this.velY,this.tickT>=this.durationT/6&&0!=this.opacity&&(this.velY-=.002,this.opacity-=.02*e,0>this.opacity&&(this.opacity=0))},Engine.FX.Explode.prototype.draw=function(e){var t,i,n,s,a,o=Engine.canvas.ctx;i=0|this.asset.fw,n=0|this.asset.fh,t=this.coordToScreen(e,this.asset),s=i*this.opacity*this.size|0,a=n*this.opacity*this.size|0,e=t.x+(i-s/2),t=t.y-n,this.inView(i,n,e,t,s,a)&&0!=this.opacity&&(e|=0,t|=0,o.save(),o.globalAlpha=1<this.opacity?1:this.opacity,o.drawImage(this.asset,0,0,i,n,e,t,s,a),o.restore())},Engine.FX.Trap=function(e){Engine.FX.Trap.prototype.uber.constructor.call(this),this.data.x=e.x,this.data.y=e.y-.5,this.offsetY=32*Engine.scale,this.duration=24,this.asset=Engine.Assets.sprites.trap},Engine.FX.Trap.extend(Engine._FX),Engine.FX.AmbientParticle=function(e){Engine.FX.AmbientParticle.prototype.uber.constructor.call(this),this.data.x=Engine.rand(e.x-9,e.x+9),this.data.y=Engine.rand(e.y-7,e.y+7),this.duration=Engine.rand(120,200),this.size=Engine.rand(15,25)/10,this.velX=2*this.size/10,this.velY=2*this.size/10,this.dirX=1==Engine.rand(0,1)?.01:-.01,this.size*=Engine.scale,this.color=220,this.alpha=.01*Engine.rand(20,30),this.opacity=0,this.w=2*this.size|0,this.h=2*this.size|0,this.camera=e},Engine.FX.AmbientParticle.extend(Engine._FX),Engine.FX.AmbientParticle.prototype.onTick=function(e){this.tickT<this.durationT/4&&this.opacity<this.alpha?(this.opacity+=.01*e,this.opacity>this.alpha&&(this.opacity=this.alpha)):this.tickT>this.durationT/1.2&&0<=this.opacity&&(this.opacity-=.01*e,0>this.opacity&&(this.opacity=0,this.kill=!0)),this.data.x-=(this.camera.diffX/2+this.dirX)*this.velX*e,this.data.y-=(this.camera.diffY/2+.01)*this.velY*e},Engine.FX.AmbientParticle.prototype.drawLight=function(e,t,i){var n,s,a,o=Engine.Assets.sprites.light_player,r=Engine.canvas.ctx;e-=(a=(n=o.fw)/100*i|0)/2|0,t-=(i=(s=o.fh)/100*i|0)/2|0;var l=Math.min(2*this.opacity,1);l=Math.round(100*l)/100;r.globalAlpha=l,r.drawImage(o,0,0,n,s,e,t,a,i)},Engine.FX.AmbientParticle.prototype.draw=function(e){var t,i,n,s;t=Engine.Assets.tilesets[0];var a=Engine.canvas.ctx;i=this.w,n=this.h,e=(t=this.coordToScreen(e,t)).x,t=t.y,this.inView(4*i,4*n,e,t,i,n)?(s=this.color,a.save(),a.globalCompositeOperation="lighter",Engine.particles&&this.drawLight(e,t,50),a.globalAlpha=this.opacity,a.fillStyle="rgb("+s+", "+s+", "+s+")",a.fillRect(e,t,i,n),a.restore()):this.kill=!0},Engine.FX.Aggro=function(e){Engine.FX.Aggro.prototype.uber.constructor.call(this),this.dat=e,this.data.x=e.x,this.data.y=e.y,this.duration=90,this.asset=Engine.Assets.sprites.aggro,this.offsetY=1.5*-this.asset.fh},Engine.FX.Aggro.extend(Engine._FX),Engine.FX.Aggro.prototype.onTick=function(e){this.data.y=this.dat.y+.01,this.data.x=this.dat.x},Engine.FX.Aggro.prototype.init=function(){this.uber.init.call(this),this.timer=2},Engine.FX.Aggro.prototype.update=function(e){this.ticker(e),(this.tickT>=this.durationT||1!==this.dat.alive)&&(this.kill=!0),this.animated&&this.frame<this.frames-1&&0==this.tick%this.timer&&this.frame++,this.onTick(e)},Engine.FX.Collect=function(e){Engine.FX.Collect.prototype.uber.constructor.call(this),this.data.x=e.x,this.data.y=e.y,this.duration=200,this.asset=Engine.Assets.sprites.collect,this.size=100,this.r=0,this.offsetX=-this.asset.fw/2,this.offsetY=-this.asset.fh/3},Engine.FX.Collect.extend(Engine._FX),Engine.FX.Collect.prototype.onTick=function(e){this.size-=3*e,0>=this.size&&(this.kill=!0),this.r+=.2*e},Engine.FX.Collect.prototype.draw=function(e){var t,i,n,s,a,o=Engine.canvas.ctx;if(i=0|this.asset.fw,n=0|this.asset.fh,t=this.coordToScreen(e,this.asset),s=i*this.size/100,a=n*this.size/100,e=t.x+(i-s/2),t=t.y+(n-a/2),e+=this.offsetX?this.offsetX:0,t+=this.offsetY?this.offsetY:0,this.inView(i,n,e,t,s,a)){e|=0,t|=0,o.save();var r=s/2|0,l=a/2|0;o.translate(e+r,t+l),o.rotate(this.r),o.drawImage(this.asset,0,0,i,n,-r,-l,s,a),o.restore()}},Engine.FX.PickupHint=function(e){Engine.FX.PickupHint.prototype.uber.constructor.call(this),this.data.x=e.data.x,this.data.y=e.data.y+.5,this.asset=Engine.Assets.sprites.pickup},Engine.FX.PickupHint.extend(Engine._FX),Engine.FX.PickupHint.prototype.init=function(){this.uber.init.call(this),this.timer=20},Engine.FX.PickupHint.prototype.update=function(e){this.ticker(e),this.animated&&0==this.tick%this.timer&&this.frame++,this.onTick(e)},Engine.FX.Buff=function(e,t,i){Engine.FX.Buff.prototype.uber.constructor.call(this),this.parent=e,this.data.x=e.data.x,this.data.y=e.data.y,this.duration=600,this.asset=Engine.Assets.sprites.buffs,this.deg=t*(Engine.math.PI/180)||0,this.speed=.04,this.rad=.7,this.offsetY=0,this.opacity=i||1},Engine.FX.Buff.extend(Engine._FX),Engine.FX.Buff.prototype.update=function(e){this.ticker(e),(this.tickT>=this.durationT||1!==this.parent.data.alive)&&(this.kill=!0),this.onTick(e)},Engine.FX.Buff.prototype.onTick=function(e){this.data.x=this.parent.data.x,this.data.y=this.parent.data.y+this.offsetY,this.deg+=this.speed/this.rad,this.data.x+=this.rad*Math.cos(this.deg),this.data.y+=.5*this.rad*Math.sin(this.deg),1>this.opacity&&(this.opacity+=.05*e,1<this.opacity&&(opacity=1))},Engine.FX.Buff.prototype.draw=function(e){var t,i,n,s=Engine.canvas.ctx;i=this.asset.fw,n=this.asset.fh,e=(t=this.coordToScreen(e,this.asset)).x,t=t.y-this.parent.data.z,s.save(),s.globalCompositeOperation="lighter",s.globalAlpha=this.tickT>this.durationT/4*3&&60>Engine.now%120?0:.8,s.drawImage(this.asset,0,0,i,n,e,t,i,n),s.restore()},Engine.FX.LevelUp=function(e){Engine.FX.LevelUp.prototype.uber.constructor.call(this),this.odata=e,this.data={x:this.odata.x,y:this.odata.y,z:this.odata.z},this.duration=100,this.asset=Engine.Assets.sprites.levelup,this.offsetY=0,this.opacity=1},Engine.FX.LevelUp.extend(Engine._FX),Engine.FX.LevelUp.prototype.onTick=function(e){this.offsetY+=.002*Engine.scale*e,this.data.x=this.odata.x,this.data.y=this.odata.y-.8-this.offsetY,this.data.z=this.odata.z,this.tickT>this.durationT/3*2&&0<this.opacity&&(this.opacity-=.05*e,0>this.opacity&&(this.opacity=0))},Engine.FX.LevelUp.prototype.draw=function(e){var t,i,n,s,a,o=Engine.canvas.ctx;s=.75*(i=0|this.asset.fw),a=.75*(n=0|this.asset.fh),e=(t=this.coordToScreen(e,this.asset)).x+.25*i/2,t=t.y-this.data.z,this.inView(i,n,e,t,s,a)&&(e|=0,t|=0,o.save(),o.globalAlpha=this.opacity,o.drawImage(this.asset,0,0,i,n,e,t,s,a),o.restore())},Engine.Map=function(e){this.data=e.data,this.tileset=e.tileset,this.width=e.data[0][0].length,this.height=e.data[0].length,this.los=e.los,this.asset=Engine.Assets.tilesets[this.tileset],this.tilesetData=Engine.Assets.data.tilesets[this.tileset],this.lightTick=0,this.objects=[],this.lastComputeDark=this.lastCompute=0,this.gameObjects=null,this.lightObjects=[],this.offset_tick_speed=this.offset_tick=this.fireTick=this.tickT=this.tick=this.lastTick=0,this.shadow={x:0,y:0},this.dayLightMod=0,this.hashmap={},this.assetComposed=null},Engine.Map.prototype.init=function(){var e,t,i={tiles:[],animated:[]},n=[],s=Engine.Assets.tileSize,a=this.tilesetData,o=0,r=-1;this.getUniqueTiles(i,[Engine.Game.layers.ground,Engine.Game.layers.ground2]),this.getUniqueTiles(i,[Engine.Game.layers.objects]),this.getUniqueTiles(i,[Engine.Game.layers.overlay]),n=i.tiles.filter((function(e,t){return i.tiles.indexOf(e)==t})),e=i.animated.filter((function(e,t){return i.animated.indexOf(e)==t})).length,t=Math.ceil((n.length+e)/10),(e=document.createElement("canvas")).ctx=e.getContext("2d",{willReadFrequently:!0}),e.width=10*s,e.height=s*t,this.assetComposed=e,Engine.disableSmoothing(e);for(var l=0,h=0;h<n.length;h++){o++,0==l%10&&(r++,o=0);for(var c=n[h].split("_"),d=t=0;d<c.length;d++){var g,u,p,f,m,E,y,w,v=c[d];p=f=y=w=s,g=v%15*s,u=(v/15|0)*s,m=o*s,E=r*s,e.ctx.drawImage(this.asset.dayTime,g,u,p,f,m,E,y,w),!t&&a.animated[v]&&(t=a.animated[v].speed)}if(this.hashmap[n[h]]={x:o*s|0,y:r*s|0,animated:t,frames:[]},t){for(o++,0==++l%10&&(r++,o=0),d=0;d<c.length;d++)g=(v=c[d])%15*s,u=(v/15|0)*s,m=o*s,E=r*s,a.animated[v]?e.ctx.drawImage(this.asset.dayTime,g+s,u,p,f,m,E,y,w):e.ctx.drawImage(this.asset.dayTime,g,u,p,f,m,E,y,w);this.hashmap[n[h]].frames.push({x:o*s|0,y:r*s|0})}l++}},Engine.Map.prototype.getUniqueTiles=function(e,t){var i,n,s,a=[],o=this.tilesetData;for(n=0;n<this.height;n++)for(i=0;i<this.width;i++){var r=0;for(s=0;s<t.length;s++){var l=this.data[t[s]][n][i];-1!=l&&a.push(l),!r&&o.animated[l]&&(r=o.animated[l].speed)}0<a.length&&(s=a.join("_"),e.tiles.push(s),r&&e.animated.push(s+"_animated"),a.length=0)}},Engine.Map.prototype.updateOptions=function(e){var t;switch(e.dayTime){case 0:case 5:t=20;break;case 1:t=12;break;case 2:case 3:case 4:t=4}this.dayLightMod=t},Engine.Map.prototype.update=function(e,t,i){this.ticker(e),this.onTick(e,t),i.shades&&this.drawOverlayFXUpdate(t)},Engine.Map.prototype.ticker=function(e){this.lastTick=this.tick,this.tick++,this.tickT+=Engine.deltaT,60==this.tick&&(this.tick=0)},Engine.Map.prototype.onTick=function(e,t){this.lightTick+=e,20<=this.lightTick&&(this.lightTick=0),this.offset_timeline=Engine.timeline,this.offset_tick=Engine.timeline%60,this.offset_tick_speed=Engine.timeline%20,this.fireTick+=Engine.deltaT,100<=this.fireTick&&(this.fireTick=0,this.createFire(t))},Engine.Map.prototype.collision=function(e,t,i){if(i=i||Engine.Game.layers.collision,i=this.data[i],(0>t.x||t.x>=i[0].length-1)&&(t.x=e.x),(0>t.y||t.y>=i.length-1)&&(t.y=e.y),t.y!==e.y||t.x!==e.x){try{if(1==i[Math.ceil(t.y-.3)][Math.ceil(e.x)]||1==i[Math.ceil(t.y-.3)][Math.floor(e.x)]){var n=Math.ceil(t.y-.3),s=n-t.y-.7;t.y+=s,t.cy=!0}else 1!=i[Math.floor(t.y)][Math.ceil(e.x)]&&1!=i[Math.floor(t.y)][Math.floor(e.x)]||(n=Math.floor(t.y),s=t.y-n,t.y+=1-s,t.cy=!0)}catch(i){t.y=e.y}try{1==i[Math.ceil(t.y-.3)][Math.ceil(t.x)]||1==i[Math.floor(t.y)][Math.ceil(t.x)]?(s=(n=Math.ceil(t.x-1))-t.x,t.x+=s,t.cx=!0):1!=i[Math.ceil(t.y-.3)][Math.floor(t.x)]&&1!=i[Math.floor(t.y)][Math.floor(t.x)]||(n=Math.floor(t.x),s=t.x-n,t.x+=1-s,t.cx=!0)}catch(i){t.x=e.x}}},Engine.Map.prototype.checkLOS=function(e,t,i,n){for(var s=Math.abs(i-e),a=Math.abs(n-t),o=e<i?1:-1,r=t<n?1:-1,l=s-a,h=this.data[Engine.Game.layers.collision];e!==i||t!==n;){if(!h[t]||1==h[t][e])return!1;var c=2*l;c>0-a&&(l-=a,e+=o),c<s&&(l+=s,t+=r)}return!0},Engine.Map.prototype.draw=function(e,t,i){i=Engine.Assets.tileSize;var n,s,a,o,r,l,h,c,d,g=t.x+.5|0,u=t.y+.5|0,p=Engine.canvas.ctx;c=t.x-g+.5,d=t.y-u+.5;var f=[],m=e.length,E=this.hashmap;for(s=13;s--;)if(!(0>(h=s+u-6)||h>this.height-1))for(t=21;t--;)if(!(0>(a=t+g-10)||a>this.width-1)){if(1<m){for(o=0;o<m;o++)n=e[o],dataLayer=this.data[n],-1!==(n=dataLayer[h][a])&&f.push(n);if(!(0<f.length))continue;n=E[n=f.join("_")],f.length=0}else{if(n=e[0],dataLayer=this.data[n],-1===(n=dataLayer[h][a]))continue;n=E[n]}a=n.x,o=n.y,r=~~((r=(t-c)*i)+.5)+(r>>31),l=~~((l=(s-d)*i)+.5)+(l>>31),n.animated&&this.offset_timeline%(2*n.animated)>=n.animated&&(a=n.frames[0].x,o=n.frames[0].y),p.drawImage(this.assetComposed,a,o,i,i,r,l,i,i)}},Engine.Map.prototype.drawLights=function(e){var t,i,n,s,a,o,r=Engine.Assets.tileSize,l=Engine.Assets.sprites.light_torch,h=e.x+.5|0,c=e.y+.5|0,d=Engine.canvas.ctx;d.save(),d.globalCompositeOperation="lighter",10>this.lightTick%20&&(d.globalAlpha=.9),a=e.x-h+.5,o=e.y-c+.5;var g=this.data[Engine.Game.layers.objects];for(i=0;16>i;i++)if(!(0>(s=i+c-8)||s>this.height-1))for(e=0;23>e;e++)0>(t=e+h-11)||t>this.width-1||32!=(t=g[s][t])&&43!=t&&44!=t&&58!=t&&59!=t&&60!=t||(n=~~((n=(e-a-1)*r)+.5)+(n>>31),t=~~((t=(i-o-2)*r)+.5)+(t>>31),n+=(r-l.fw)/2,t-=l.fh/2.5,n+=(Math.random()-.5)*Engine.scale,t+=(Math.random()-.5)*Engine.scale,d.drawImage(l,0|n,0|t));d.restore()},Engine.Map.prototype.createFire=function(e){var t,i,n,s,a,o,r,l=e.x+.5|0,h=e.y+.5|0;a=e.x-l+.5,o=e.y-h+.5;var c=this.data[Engine.Game.layers.objects];for(n=0;16>n;n++)if(!(0>(s=n+h-8)||s>this.height-1))for(i=0;21>i;i++)0>(t=i+l-10)||t>this.width-1||(32==(t=c[s][t])&&((r=new Engine.FX.Fire({x:e.x+i-a-9.45,y:e.y+n-o-7.55})).init(),Engine.Game.addObject(r)),43!=t&&44!=t&&58!=t&&59!=t)||((r=new Engine.FX.Fire({x:e.x+i-a-9.45,y:e.y+n-o-7.8})).init(),Engine.Game.addObject(r))},Engine.Map.prototype.fog=function(e,t){var i,n,s,a,o,r,l,h,c,d,g=this.asset.fw,u=e.x+.5|0,p=e.y+.5|0,f=Engine.canvas.ctx,m={x:t.x,y:t.y},E={x:0,y:0};for(l=e.x-u+.5,h=e.y-p+.5,f.save(),f.fillStyle="rgb(0, 0, 15)",n=0;13>n;n++)for(r=n+p-6,i=0;21>i;i++)o=i+u-10,s=~~((s=(i-l)*g)+.5)+(s>>31),a=~~((a=(n-h)*g)+.5)+(a>>31),E.x=o,E.y=r,0>(c=(c=Engine.lineDistance(m,E))/9*(c/4))&&(c=0),this.los&&(this.checkLOS(Math.ceil(t.x-.2),Math.ceil(t.y-.5),o,r)||this.checkLOS(Math.floor(t.x+.2),Math.ceil(t.y-.5),o,r)||this.checkLOS(Math.ceil(t.x-.2),Math.ceil(t.y-.5),o,r)||this.checkLOS(Math.floor(t.x+.2),Math.ceil(t.y-.5),o,r)||(c+=1)),1<c&&(c=1),c!==d&&(d=f.globalAlpha=c),0<c&&f.fillRect(s,a,0|g,0|g);f.restore()},Engine.Map.prototype.light=function(e,t){var i,n,s,a,o,r,l,h,c,d=this.asset.fw,g=this.dayLightMod,u=this.data[Engine.Game.layers.ground],p=e.x+.5|0,f=e.y+.5|0,m=Engine.canvas.ctx,E={x:e.x,y:e.y},y={x:0,y:0};for(l=e.x-p+.5,h=e.y-f+.5,m.save(),m.fillStyle="rgb(30, 00, 45)",n=0;13>n;n++)if(void 0!==u[r=n+f-6])for(i=0;21>i;i++)o=i+p-10,s=~~((s=(i-l)*d)+.5)+(s>>31),a=~~((a=(n-h)*d)+.5)+(a>>31),y.x=o,y.y=r,1<(o=(o=.8*Engine.lineDistance(E,y))/20*(o/g))&&(o=1),.05>o||(o!==c&&(c=m.globalAlpha=o),m.fillRect(s,a,d,d));m.restore()},Engine.Map.prototype.drawOverlayFXUpdate=function(e){this.shadow.x-=4.5*e.diffX,this.shadow.y-=4.5*e.diffY,this.shadow.x%=Engine.width,this.shadow.y%=Engine.height},Engine.Map.prototype.drawOverlayFXDraw=function(e){e=Engine.canvas.ctx;var t,i,n=Engine.Assets.sprites.shadow_forest;t=0|this.shadow.x,i=0|this.shadow.y,e.drawImage(n,t,i),t+n.width<Engine.width?e.drawImage(n,t+n.width,i):t+n.width>Engine.width&&e.drawImage(n,t-n.width,i),i+n.height<Engine.height?(e.drawImage(n,t,i+n.height),t+n.width<Engine.width?e.drawImage(n,t+n.width,i+n.height):t+n.width>Engine.width&&e.drawImage(n,t-n.width,i+n.height)):i+n.height>Engine.height&&(e.drawImage(n,t,i-n.height),t+n.width<Engine.width?e.drawImage(n,t+n.width,i-n.height):t+n.width>Engine.width&&e.drawImage(n,t-n.width,i-n.height))},Engine.Camera=function(e){Engine.Camera.prototype.uber.constructor.call(this),this.data={x:e.width/2,y:e.height/2,diffX:0,diffY:0,zoom:0},this.targ=null,this.velY=this.velX=0,this.vel=.5,this.map=e,this.targetID=0},Engine.Camera.extend(Engine.Entity),Engine.Camera.prototype.init=function(e){null==this.targ&&(this.data.x=e.data.x,this.data.y=e.data.y,this.bindToMap()),this.targ=e.data},Engine.Camera.prototype.bindToMap=function(){this.data.x+10.5>this.map.width?(this.data.x=this.map.width-10.5,this.data.diffX=0):0>this.data.x-9.5&&(this.data.x=9.5,this.data.diffX=0),this.data.y+5.75>this.map.height?(this.data.y=this.map.height-5.75,this.data.diffY=0):0>this.data.y-5.75&&(this.data.y=5.75,this.data.diffY=0)},Engine.Camera.prototype.update=function(e){this.move(e)},Engine.Camera.prototype.addZoom=function(e){this.data.zoom+=e,.5<this.data.zoom&&(this.data.zoom=.5)},Engine.Camera.prototype.move=function(e){var t=Engine.Assets.tileSize,i=Engine.keys.MOUSEPOS.x/t-10;t=Engine.keys.MOUSEPOS.y/t-6,i=this.targ.x+.3*i-this.data.x,t=this.targ.y+.4*t-this.data.y,i=Math.round(1e3*i)/1e4,t=Math.round(1e3*t)/1e4;.001>=Math.abs(i)&&(i=0),.001>=Math.abs(t)&&(t=0),this.data.diffX=i,this.data.diffY=t,.001<Math.abs(i)&&(this.data.x+=i*this.vel*e),.001<Math.abs(t)&&(this.data.y+=t*this.vel*e),this.bindToMap()},Engine.Projectile=function(e){Engine.Projectile.prototype.uber.constructor.call(this),this.type="projectile",this.owner=e,this.data={x:e.x,y:e.y,f:e.f,mx:0,my:0,r:0},this.newPos={x:0,y:0,cx:!1,cy:!1},this.duration=0,this.asset=null,this.vel=this.frame=0,this.light=this.animated=!1,this.frametick=0,this.opacity=1,this.collidable=!0,this.canHurtSelf=!1,this.collisionPush=!0},Engine.Projectile.extend(Engine.Entity),Engine.Projectile.prototype.init=function(e){this.initClick(e),this.initAnim()},Engine.Projectile.prototype.initAnim=function(){this.asset.fw<this.asset.width&&(this.animated=!0,this.frames=this.asset.width/this.asset.fw|0,this.timer=this.duration/this.frames|0)},Engine.Projectile.prototype.initClick=function(e){this.data.r=e,this.data.mx=Math.cos(e),this.data.my=Math.sin(e)},Engine.Projectile.prototype.update=function(e,t){this.tick+=e,this.tick>this.duration&&this.die(e),this.animated&&(this.frametick+=e,this.frametick>=this.timer&&(this.frametick=0,this.frame++)),this.onTick(e),this.move(e,t)},Engine.Projectile.prototype.onTick=function(e){},Engine.Projectile.prototype.die=function(){},Engine.Projectile.prototype.onTick=function(e){},Engine.Projectile.prototype.move=function(e,t){this.newPos.x=this.data.x+this.data.mx*this.vel*e,this.newPos.y=this.data.y+this.data.my*this.vel*e,Engine.Game.collision(this.data,this.newPos,Engine.Game.layers.collision2),this.collidable&&(this.newPos.cx||this.newPos.cy)&&this.collideWorld(this.newPos.cx,this.newPos.cy),this.collidable&&this.collisionObjects(this.newPos),this.newPos.x=Math.round(1e4*this.newPos.x)/1e4,this.newPos.y=Math.round(1e4*this.newPos.y)/1e4,this.newPos.x!==this.data.x&&(this.data.x=this.newPos.x),this.newPos.y!==this.data.y&&(this.data.y=this.newPos.y),this.newPos.cx=!1,this.newPos.cy=!1},Engine.Projectile.prototype.reflect=function(){this.data.mx*=-1,this.data.my*=-1;var e=this.data.r/Engine.math.PI*180;this.data.r=(e+180)*Engine.math.PI/180},Engine.Projectile.prototype.drawLight=function(e){var t,i=Engine.Assets.sprites[this.light],n=Engine.canvas.ctx,s=this.asset,a=this.coordToScreen(e,s);e=s.fw,s=s.fh,t=a.x,a=a.y,t+=this.offsetX?this.offsetX:0,a+=this.offsetY?this.offsetY:0,this.inView(e,s,t,a,e,s)&&(t=t+(e-i.fw)/2|0,a=a+(s-i.fh)/2|0,n.save(),n.globalCompositeOperation="lighter",n.globalAlpha=.7,n.drawImage(i,t,a),n.restore())},Engine.Projectile.prototype.draw=function(e){if(!(3>this.tick)){var t,i,n,s,a=Engine.canvas.ctx;if(i=this.animated?this.frame%this.frames*this.asset.fw:0,n=0|this.asset.fw,s=0|this.asset.fh,e=(t=this.coordToScreen(e,this.asset)).x,t=t.y,e+=this.offsetX?this.offsetX:0,t+=this.offsetY?this.offsetY:0,this.inView(n,s,e,t,n,s)){e|=0,t|=0;var o=Engine.Assets.sprites.shadow;a.drawImage(o,0,0,o.fw,o.fh,e+(n-o.fw)/2|0,t+s-this.asset.fh/4|0,0|o.fw,this.asset.fh/2|0);o=this.asset.fw/2|0;var r=this.asset.fh/2|0;a.save(),a.translate(e+o,t+r),a.rotate(this.data.r),1>this.opacity&&(a.globalAlpha=this.opacity),a.drawImage(this.asset,i,0,n,s,-o,-r,n,s),a.restore()}}},Engine.Projectile.Arrow=function(e){Engine.Projectile.Arrow.prototype.uber.constructor.call(this,e),this.vel=.2,this.duration=32,this.counter=0,this.canHurtSelf=this.light=!1},Engine.Projectile.Arrow.extend(Engine.Projectile),Engine.Projectile.Arrow.prototype.init=function(e){this.asset=Engine.Assets.sprites.arrow_E,Engine.Game.audio.play("arrow",this.data),this.uber.init.call(this,e)},Engine.Projectile.Arrow.prototype.die=function(e){0<this.opacity?(this.opacity-=.2*e,0>this.opacity&&(this.opacity=0)):(this.kill=!0,(e=new Engine.FX.Smoketrail(this.data)).init(),Engine.Game.addObject(e))},Engine.Projectile.Arrow.prototype.collide=function(e,t,i){(e=new Engine.FX.Smoketrail(this.data)).init(),Engine.Game.addObject(e),this.kill=!0},Engine.Projectile.Arrow.prototype.collideWorld=function(e,t){if(this.counter++,this.canHurtSelf=!0,1>=this.counter){var i=new Engine.FX.Smoketrail(this.data);i.init(),Engine.Game.addObject(i),this.data.r*=-1,e&&(this.data.mx*=-1,i=this.data.r/Engine.math.PI*180,this.data.r=(i+180)*Engine.math.PI/180),t&&(this.data.my*=-1),this.duration+=16,Engine.Game.audio.play("ricochet",this.data)}else this.collidable=!1,this.data.mx=0,this.data.my=0,(i=new Engine.FX.Smoketrail(this.data)).init(),Engine.Game.addObject(i)},Engine.Projectile.Rocket=function(e){Engine.Projectile.Rocket.prototype.uber.constructor.call(this,e),this.vel=.025,this.v=0,this.duration=40,this.counter=0,this.light="light_small",this.canHurtSelf=!1,this.particleTick=0},Engine.Projectile.Rocket.extend(Engine.Projectile),Engine.Projectile.Rocket.prototype.init=function(e){this.asset=Engine.Assets.sprites.rocket,Engine.Game.audio.play("rocket",this.data),this.uber.init.call(this,e)},Engine.Projectile.Rocket.prototype.onTick=function(e){this.v+=.001*e,this.vel+=this.v*e,.25<this.vel&&(this.vel=.25),this.particleTick++,2==this.particleTick&&(this.particleTick=0,(e=new Engine.FX.Smoke(this.data)).init(),Engine.Game.addObject(e)),30<=this.counter&&(this.explode(),this.collidable=!1)},Engine.Projectile.Rocket.prototype.explode=function(){this.canHurtSelf=!0;for(var e=0;5>e;e++){var t=new Engine.FX.Explode2(this.data,2);t.init(),Engine.Game.addObject(t)}(t=new Engine.FX.Explode3(this.data,1)).init(),Engine.Game.addObject(t),Engine.Game.audio.play("explode",this.data),this.kill=!0},Engine.Projectile.Rocket.prototype.die=function(e){this.explode()},Engine.Projectile.Rocket.prototype.collide=function(e,t,i){e.data.block||e.data.armor?this.collideWorld():this.explode()},Engine.Projectile.Rocket.prototype.collideWorld=function(){this.counter++},Engine.Projectile.Grenade=function(e){Engine.Projectile.Grenade.prototype.uber.constructor.call(this,e),this.vel=.15,this.v=.1,this.velB=0,this.duration=70,this.counter=0,this.canHurtSelf=this.light=!1,this.particleTick=0,this.collisionPush=!1},Engine.Projectile.Grenade.extend(Engine.Projectile),Engine.Projectile.Grenade.prototype.init=function(e){this.asset=Engine.Assets.sprites.grenade,Engine.Game.audio.play("thud",this.data),this.uber.init.call(this,e)},Engine.Projectile.Grenade.prototype.onTick=function(e){this.data.r=0<this.vel?this.data.r+.2*this.data.mx*e:this.data.r+.1*this.data.mx*e,this.vel-=.001*e,0>this.vel&&(this.vel=0),0==this.vel&&this.collidable&&(this.collidable=!1),this.particleTick++,4==this.particleTick&&(this.particleTick=0,(e=new Engine.FX.Smoke(this.data)).init(),Engine.Game.addObject(e))},Engine.Projectile.Grenade.prototype.move=function(e,t){this.uber.move.call(this,e,t);var i=t[Math.ceil(this.data.y-.5)];i&&(i=i[Math.round(this.data.x)],-1!==Engine.Assets.data.tilesets[0].water.indexOf(i)&&((i=new Engine.FX.Smoketrail(this.data)).init(),Engine.Game.addObject(i),this.kill=!0))},Engine.Projectile.Grenade.prototype.die=function(){this.canHurtSelf=!0;for(var e=0;5>e;e++){var t=new Engine.FX.Explode2(this.data,2);t.init(),Engine.Game.addObject(t)}(t=new Engine.FX.Explode3(this.data,1)).init(),Engine.Game.addObject(t),this.kill=!0,Engine.Game.audio.play("explode",this.data)},Engine.Projectile.Grenade.prototype.collide=function(e,t,i){this.canHurtSelf=!0,(e=new Engine.FX.Smoketrail(this.data)).init(),Engine.Game.addObject(e),this.vel*=.3,0>this.vel&&(this.vel=0),this.data.mx*=-1,this.data.my*=-1},Engine.Projectile.Grenade.prototype.collideWorld=function(e,t){if(this.canHurtSelf=!0,this.vel*=.45,0>this.vel&&(this.vel=0),this.v=0,this.data.r*=-1,e){this.data.mx*=-1;var i=this.data.r/Engine.math.PI*180;this.data.r=(i+180)*Engine.math.PI/180}t&&(this.data.my*=-1),Engine.Game.audio.play("ricochet",this.data)},Engine.Projectile.Shell=function(e){Engine.Projectile.Shell.prototype.uber.constructor.call(this,e),this.vel=.2,this.duration=20,this.counter=0,this.collided=!1,this.light="light_small",this.canHurtSelf=!1},Engine.Projectile.Shell.extend(Engine.Projectile),Engine.Projectile.Shell.prototype.init=function(e){this.asset=Engine.Assets.sprites.shells,this.uber.init.call(this,e),(e=new Engine.FX.Explode2(this.data,1.5)).init(),Engine.Game.addObject(e)},Engine.Projectile.Shell.prototype.onTick=function(e){this.collided&&0<this.opacity&&(this.vel=.1,this.opacity-=.24*e,0>this.opacity&&(this.opacity=0))},Engine.Projectile.Shell.prototype.die=function(e){0<this.opacity?(this.opacity-=.24*e,0>this.opacity&&(this.opacity=0)):(this.kill=!0,(e=new Engine.FX.Smoketrail(this.data)).init(),Engine.Game.addObject(e))},Engine.Projectile.Shell.prototype.collide=function(e,t,i){this.kill=!0,(e=new Engine.FX.Smoketrail(this.data)).init(),Engine.Game.addObject(e)},Engine.Projectile.Shell.prototype.collideWorld=function(e,t){this.kill=!0;var i=new Engine.FX.Smoketrail(this.data);i.init(),Engine.Game.addObject(i)},Engine.Projectile.Bullet=function(e){Engine.Projectile.Bullet.prototype.uber.constructor.call(this,e),this.vel=.18,this.duration=46,this.particleTick=this.counter=0,this.collided=!1,this.light="light_small",this.canHurtSelf=!1},Engine.Projectile.Bullet.extend(Engine.Projectile),Engine.Projectile.Bullet.prototype.init=function(e){this.asset=Engine.Assets.sprites.spell,Engine.Game.audio.play("bullet",this.data),this.uber.init.call(this,e)},Engine.Projectile.Bullet.prototype.onTick=function(e){this.collided&&0<this.opacity&&(this.vel=.1,this.opacity-=.2*e,0>this.opacity&&this.die(e)),this.particleTick++,2==this.particleTick&&(this.particleTick=0,(e=new Engine.FX.Fire({x:this.data.x,y:this.data.y-.4})).init(),Engine.Game.addObject(e))},Engine.Projectile.Bullet.prototype.die=function(e){this.kill=!0,(e=new Engine.FX.Smoketrail(this.data)).init(),Engine.Game.addObject(e)},Engine.Projectile.Bullet.prototype.collide=function(e,t,i){this.kill=!0},Engine.Projectile.Bullet.prototype.collideWorld=function(e,t){if(this.counter++,this.canHurtSelf=!0,3>=this.counter){if(this.data.r*=-1,e){this.data.mx*=-1;var i=this.data.r/Engine.math.PI*180;this.data.r=(i+180)*Engine.math.PI/180}t&&(this.data.my*=-1),this.duration+=8}else this.kill=!0,(i=new Engine.FX.Smoketrail(this.data)).init(),Engine.Game.addObject(i)},Engine.Projectile.Bone=function(e){Engine.Projectile.Bone.prototype.uber.constructor.call(this,e),this.vel=.14,this.duration=72,this.counter=0,this.canHurtSelf=this.light=!1},Engine.Projectile.Bone.extend(Engine.Projectile),Engine.Projectile.Bone.prototype.init=function(e){this.asset=Engine.Assets.sprites.projectile_bone,Engine.Game.audio.play("arrow",this.data),this.uber.init.call(this,e)},Engine.Projectile.Bone.prototype.onTick=function(e){this.data.r+=.12*e},Engine.Projectile.Bone.prototype.die=function(e){0<this.opacity?(this.opacity-=.2*e,0>this.opacity&&(this.opacity=0)):(this.kill=!0,(e=new Engine.FX.Smoketrail(this.data)).init(),Engine.Game.addObject(e))},Engine.Projectile.Bone.prototype.collide=function(e,t,i){(e=new Engine.FX.Smoketrail(this.data)).init(),Engine.Game.addObject(e),this.kill=!0},Engine.Projectile.Bone.prototype.collideWorld=function(e,t){this.collidable=!1,this.data.mx=0,this.data.my=0;var i=new Engine.FX.Smoketrail(this.data);i.init(),Engine.Game.addObject(i),this.kill=!0};var Game=function(){var e,t,i,n,s,a=[],o=[],r=[],l=[],h=0,c=0,d=0,g={dayTime:0},u=0,p=0,f=0,m=0,E=0,y=0,w=0,v=0,b=[],k=0,x=null,S=[],_=!1,P=0,A={1:"Arrow",2:"Rocket",3:"Grenade",4:"Shell",5:"Bullet"},T=!1;waitingForPlayers=!1,this.lobbyToJoin=0,this.gameStats="",this.screenshotTaken=0,this.audio={play:function(e,t,n){if(t){var s=Math.abs(t.x-i.data.x);if(t=Math.abs(t.y-i.data.y),9<s||7<t)return}Engine.audio.play(e,n||null)}},this.getProjectileById=function(e){return A[e]},this.init=function(){Engine.Elements.append("menu_title");var i=new Engine.Screens.Title;e=i,t=i=new Engine.Screens.Menu,C()};var C=function(){if(!Engine.kongregate){var e=window.location.hash.substr(1);if(e)if(e=e.split("!/lobby/")[1]){var t=e.substr(-1),i=e.slice(0,-1);Engine.Elements.remove("menu_title"),Engine.Elements.append("darken"),Engine.checkServerAlive({tag:t},(function(){Engine.Elements.remove("darken"),Engine.server.alive?(Engine.Game.lobbyToJoin=i,Engine.Elements.append("menu_name"),Engine.Elements.append("invite",{id:Engine.Game.lobbyToJoin}),$("#invite").delay(500).fadeIn(750),Engine.server.connected||Engine.Game.connect()):(Engine.Elements.append("menu_title"),Engine.info("The Game-Server is offline. Please try again later."),Engine.history.pushState())}))}else Engine.history.pushState();else Engine.history.pushState()}};this.reloadMap=function(){s&&(Engine.Assets.bufferDayTime(g.dayTime),s.init(),Engine.addLoading((function(){Engine.fps.capture=Engine.now})))},this.getGameTS=function(){return u},this.getLightObjects=function(){var e,t,i=s.lightObjects.length;for(e=0;e<i;e++)if((t=s.lightObjects[e]).free)return t.free=!1,t},this.rebufferObjects=function(){var e,t,i=a.length;for(e=0;e<i;e++)(t=a[e]).nameBuffer&&t.initNameBuffer()},this.getMapObjects=function(){return s.objects},this.render=function(a){switch(Engine.state){case 11:t.update(a),t.draw(),0<y&&(0<=(a=Math.ceil((y-Engine.now)/1e3))&&(a<v&&0<a&&Engine.audio.play("blip"),Engine.text("visitor","Game starting"+(0<a?" in "+a:"..."),140*Engine.scale,Engine.height-24*Engine.scale,!1),v=a)),Engine.keys.WHEEL&&Engine.Elements.elements.menu_lobbies.visible&&Engine.Elements.elements.menu_lobbies.scrollElem();break;case 12:x&&(Engine.audio.stop(x),x=null),Engine.audio.isPlaying("results")&&Engine.audio.stop("results"),Engine.audio.isPlaying("menu")||Engine.audio.play("menu"),Engine.webaudio&&(Engine.audio.buses.biquad.frequency.value=22050),Engine.Elements.remove("game"),Engine.socket.emit("leaveLobby"),Engine.Elements.append("menu_lobbies"),Engine.socket.emit("getLobbies"),Engine.history.pushState(),Engine.state=11;break;case 20:X(),s.update(a,i.data,g),L(a),O(),G(),I.draw(),M();var o,r,l,h,c,d,u=Engine.canvas.ctx;o=a=(p-Engine.now)/1e3,r=0<(a=Math.ceil(a))?a:"GO!",u.save(),u.fillStyle="rgba(0,0,0,0.7)",l=0,c=0|Engine.width,3<a?(d=(p-Engine.now)/1e3-a,d=Math.abs(-1*d),h=(Engine.height-60*d*Engine.scale)/2|0,d=60*d*Engine.scale|0,u.fillRect(l,h,c,d),u.restore(),a=void 0):(h=(Engine.height-60*Engine.scale)/2|0,d=60*Engine.scale|0,u.fillRect(l,h,c,d),u.restore(),l=Engine.wH-Engine.Assets.fonts.visitorLarge.fw/2,h=Engine.hH-Engine.Assets.fonts.visitorLarge.fh/2,d=(p-Engine.now)/1e3-a,d+=1,0>=a&&(d=1),Engine.text("visitorLarge",r,l,h,!0,d),a=o),-.5>=a&&(i.vel=1,Engine.state=2),n.drawHUD(),j();break;case 2:if(Engine.Game.calcCollidableObjects(),X(),i.update(a),s.update(a,i.data,g),L(a),O(),G(),1===n.data.alive&&(n.checkHealth(),n.handleInput()),I.draw(),M(),n.drawHUD(a),n.shake(i),a=(f-Engine.now)/1e3,o=a=Math.ceil(a),r=0|Engine.wH,l=8*Engine.scale|0,Engine.text("visitor","Time",r,l,!0),0>=a||(l+=Engine.Assets.fonts.visitor.fh,10>=a?(r=Engine.wH-Engine.Assets.fonts.visitorLarge.fw/2,h=(f-Engine.now)/1e3-a,h+=1,0>=a&&(h=1),Engine.text("visitorLarge",o,r,l,!0,h)):Engine.text("visitor",o,r,l,!0),10>=a&&0<a&&a<m&&Engine.audio.play("blip"),m=a),j(),0===n.data.alive&&((a=Engine.canvas.ctx).save(),a.fillStyle="rgba(100,100,100, .20)",a.globalCompositeOperation="destination-out",a.fillRect(0,0,Engine.width,Engine.height),a.restore()),n.isHit||0===n.data.alive){for(n.hit(i),a=0,o=2*Engine.scale,r=Engine.width,l=2*Engine.scale|0,h=(Engine.now/100|0)%(o+l),u=Engine.height/(o+l)|0,(d=Engine.canvas.ctx).save(),d.fillStyle="rgb(120, 120, 140)",d.globalAlpha=.08,c=0;c<u;c++)a=c*(l+o),a+=h,a|=0,d.fillRect(0,a,r,l);d.restore()}Engine.fps.capture&&Engine.fps.doCapture();break;case 30:G(),M(),n.drawHUD(a),F();break;case 40:t.update(a),t.draw(),Engine.text("visitor","Game starting...",140*Engine.scale,Engine.height-24*Engine.scale,!1);break;default:e.update(a),e.draw()}_&&Engine.Game.takeScreenshot()},this.isHost=function(){return c===d},this.setCamera=function(e){var t,n;for(t=a.length;t--;)if((n=a[t]).data.id===e){i.init(n);break}};var M=function(){Engine.canvas.ctx.drawImage(Engine.Assets.sprites.frame2,0,0)},I={tick:0,frame:0,r:0,update:function(){this.tick++,360==this.tick&&(this.tick=0)},draw:function(e){this.update(),e=Engine.Assets.sprites.cursor;var t,i,n,s,a,o=Engine.canvas.ctx;t=e.fh,Engine.keys.SHOOT&&(t=120>Engine.now%240?0:e.fh),i=e.fw,n=e.fh,s=Engine.keys.MOUSEPOS.x,a=Engine.keys.MOUSEPOS.y,o.save(),o.translate(s,a),o.rotate(this.tick%360*8*Engine.math.PI/180),o.globalAlpha=Engine.keys.STICKDISTANCE,o.drawImage(e,0,0|t,0|i,0|n,-i/2,-n/2,0|i,0|n),o.restore()}},j=function(){var e,t,i,n,s,a=Engine.Assets.sprites.latency,o=Engine.canvas.ctx,r=Engine.server.ping;e=0,t=a.fw,i=a.fh,n=Engine.width-t-4*Engine.scale|0,s=4*Engine.scale|0,100>r?e=0:100<=r&&200>r?e=i:200<=r&&(e=2*i|0),o.drawImage(a,0,e,t,i,n,s,t,i)},F=function(){var e,t,i,n,s,o,l,h,c,d=b.length,g=Engine.canvas.ctx;i=(Engine.width-Engine.width/10*7)/2,n=Engine.height/6;var u=b.length.toString().length,p=12*(u+3)*Engine.scale+12*Engine.scale|0;for(g.save(),g.globalCompositeOperation="destination-out",g.fillStyle="rgba(0,0,0,0.7)",g.fillRect(0,0,Engine.width,Engine.height),g.restore(),g.fillStyle="#fff",s=i-4*Engine.scale,o=n-4*Engine.scale,l=Engine.width/10*7,h=22*Engine.scale,g.fillRect(0|s,0|o,0|l,0|h),Engine.text("visitorBlack","Player",i+p,n,!1),s=i+256*Engine.scale,Engine.text("visitorBlack","Coins",s,n,!1),s=i+338*Engine.scale,Engine.text("visitorBlack","Accuracy",s,n,!1),e=0;e<d;e++)(t=b[e]).kd&&((s=t.kd.toString().split("."))[1]?1==s[1].length?t.kd=s[0]+"."+s[1]+"0":2<s[1].length&&(t.kd=s[0]+"."+s[1].substr(0,2)):t.kd=s[0]+".00"),n+=26*Engine.scale,g.fillStyle=0==e?Engine.hsla(140+Math.round(Engine.now/2)%179,60,50,1):Engine.hsla(20*(e-1)%360,60,50,1),s=i-4*Engine.scale,o=n-4*Engine.scale,l=Engine.width/10*7,h=22*Engine.scale,g.fillRect(0|s,0|o,0|l,0|h),s=i+12*(u-(e+1).toString().length)*Engine.scale,o=n,l=0==e?"st":1==e?"nd":2==e?"rd":"th",l=(e+1).toString()+l,Engine.text("visitor",l,s,o,!1),s=i+p,o=n,l=t.name,Engine.text("visitor",l,s,o,!1),h=.75*(l=Engine.Assets.sprites.coin).fw,c=.75*l.fh,s=i+256*Engine.scale,o-=3*Engine.scale,g.drawImage(l,0,0,0|l.fw,0|l.fh,0|s,0|o,0|h,0|c),s+=h+2*Engine.scale,o=n,l=t.coins,Engine.text("visitor",l,s,o,!1),h=(l=Engine.Assets.sprites.accuracy).fw,c=l.fh,s=i+338*Engine.scale,o-=3*Engine.scale,g.drawImage(l,0,0,0|h,0|c,0|s,0|o,0|h,0|c),s+=h+2*Engine.scale,o=n,l=100<t.acc?100:t.acc,l+="%",Engine.text("visitor",l,s,o,!1);n+=26*Engine.scale,e=Math.round((14e3-(Engine.now-w))/1e3),Engine.text("visitor","Returning to Lobby"+(0<e?" in "+e:"..."),Engine.wH,n,!0),T||(T=!0,Engine.socket.emit("startAds")),15e3<Engine.now-w&&(Engine.socket.emit("stopAds"),Engine.audio.stop("results"),Engine.audio.play("menu"),Engine.initMidrollAd(),Engine.Elements.elements.quit.visible&&Engine.Elements.remove("quit"),Engine.state=11,a.length=0,r.length=0,n=$("#chatOutput").html(),e=$("#chatInput").val(),Engine.Elements.remove("game"),Engine.Elements.append("menu_lobby"),$("#chatLobbyOutput").html(n),$("#chatLobbyInput").val(e),$("#chatLobbyOutput .line").each((function(){$(this).show()})),$("#chatLobbyOutput").scrollTop(9999),$("#chatLobbyInput").focus(),Engine.socket.emit("requestLobbyData"))},O=function(){if(!(140>(k+=Engine.deltaT))){k=0;var e=new Engine.FX.AmbientParticle(i.data);e.init(),r.push(e)}},X=function(){1e3<=(E+=Engine.deltaT)&&(E=0,Engine.socket.emit("ping",parseInt(Date.now())))};this.calcCollidableObjects=function(){var e,t,i=a.length;for(e=o.length=0;e<i;e++)(t=a[e]).collidable&&o.push(t)},this.getCollidableObjects=function(){return o};var L=function(e){var t,i,n=a.length,o=s.data[Engine.Game.layers.ground];for(t=0;t<n;t++)(i=a[t]).update(e,o),i.kill&&(a.splice(t,1),t--,n--);for(a.sort(W),n=r.length,t=0;t<n;t++)(i=r[t]).update(e),i.kill&&(r.splice(t,1),t--,n--);for(r.sort(W),n=l.length,t=0;t<n;t++)(i=l[t]).update(e),i.kill&&(l.splice(t,1),t--,n--)},W=function(e,t){return e.data.y===t.data.y?e.id-t.id:e.data.y-t.data.y};this.addCameraZoom=function(e){i.addZoom(e)};var G=function(){var e=Engine.canvas.ctx;e.globalAlpha=n.isHit?.5:n.running?.7:1,s.draw([Engine.Game.layers.ground,Engine.Game.layers.ground2],i.data,g);var t,o,h=i.data,c=a.length;for(t=0;t<c;t++)(o=a[t]).light&&o.drawLight(h);for(e.globalAlpha=1,s.drawLights(i.data),s.draw([Engine.Game.layers.objects],i.data,g),e=i.data,t=a.length,o=s.data[Engine.Game.layers.ground],h=0;h<t;h++)(c=a[h]).draw(e,o,g,c.data.id==n.data.id);for(s.draw([Engine.Game.layers.overlay],i.data,g),e=i.data,t=r.length,o=s.data[Engine.Game.layers.ground],h=0;h<t;h++)(c=r[h]).draw(e,o,g,c.data.id==n.data.id);for(s.light(i.data,n.data),h=l.length,e=0;e<h;e++)(t=l[e]).draw();0<Engine.Game.screenshotTaken&&Engine.Game.drawFlash()};this.drawFlash=function(){var e=Engine.width,t=Engine.height,i=Engine.canvas.ctx;i.save(),i.fillStyle="#fff",i.globalAlpha=this.screenshotTaken,this.screenshotTaken-=.04*Engine.dt,i.fillRect(0,0,e,t),i.restore()},this.getMessageLength=function(){if(0==l.length)return 0;var e=l[l.length-1];return e.offsetY+e.offsetY2},this.takeScreenshot=function(){if(!(500>Engine.now-P))if(_){var e,t,i,n,s,a,o,r,l;P=Engine.now,10==S.length&&S.splice(0,1),this.screenshotTaken=.6,(e=document.createElement("canvas")).id="screenshot_full_"+Date.now(),e.width=Engine.baseWidth*Math.max(Engine.scale,Engine.contextScale)|0,e.height=Engine.baseHeight*Math.max(Engine.scale,Engine.contextScale)|0,e.ctx=e.getContext("2d",{willReadFrequently:!0}),i=n=o=sy=0,r=e.width,l=e.height,2<Math.max(Engine.scale,Engine.contextScale)&&(e.width=2*Engine.baseWidth|0,e.height=2*Engine.baseHeight|0),Engine.disableSmoothing(e),s=e.width,a=e.height,e.ctx.drawImage(Engine.canvas,o,sy,r,l,i,n,s,a),(t=document.createElement("canvas")).id="screenshot_thumb_"+Date.now(),t.width=276,t.height=204,t.ctx=t.getContext("2d",{willReadFrequently:!0}),Engine.disableSmoothing(t),i=-(Engine.baseWidth-t.width)/2|0,n=-(Engine.baseHeight-t.height)/2|0,o=sy=0,r=0|Engine.canvas.width,l=0|Engine.canvas.height,s=Engine.baseWidth,a=Engine.baseHeight,t.ctx.drawImage(Engine.canvas,o,sy,r,l,i,n,s,a),S.push({thumb:t,full:e,taken:+new Date,saved:!1}),_=!1,z({type:5,msg:"Snapshot taken. ("+S.length+"/10)"})}else _=!0},this.getScreenshots=function(){return S},this.connect=function(){Engine.server.connect({reconnect:!1,"force new connection":!0}),Engine.socket.on("connect",(function(){Engine.server.connected=!0,S.length=0})),Engine.socket.on("connected",(function(e){c=e,Engine.socket.emit("requestGameStats");var t=Engine.getCookie("patreon-code");if(!1!==t)Engine.socket.emit("patreon-code",t),Engine.deleteCookie("patreon-code");else{var i=Engine.getCookie("patreon-user"),n=Engine.getCookie("patreon-access_token");!1!==i&&!1!==n&&Engine.socket.emit("patreon-connect",{id:i,access_token:n})}})),Engine.socket.on("disconnect",(function(t){Engine.server.connected=!1,$("#overlay").removeClass("hideCursor"),Engine.Game.hasMusic()&&(Engine.audio.stop(Engine.Game.hasMusic()),x=null),Engine.webaudio&&(Engine.audio.buses.biquad.frequency.value=22050),a.length=0,r.length=0,$(".menu").each((function(){Engine.Elements.remove($(this).attr("id"))})),e=new Engine.Screens.Title,Engine.Elements.append("menu_servers"),Engine.state=0,t||Engine.info("You have been disconnected."),Engine.server.login&&(Engine.server.login=!1),Engine.history.pushState(),Engine.Game.lobbyToJoin=0})),Engine.socket.on("patreon-connected",(function(e){Engine.setCookie("patreon-user",e.id,30),Engine.setCookie("patreon-access_token",e.access_token,30),Engine.setCookie("patreon-pledge",e.pledge,30),Engine.setCookie("patreon-tier",e.tier,30)})),Engine.socket.on("loginFail",(function(){$("#play_guest").removeClass("active disabled"),Engine.Elements.remove("darken")})),Engine.socket.on("login",(function(e){Engine.server.hash=e,Engine.server.login=!0,$(".menu").each((function(){Engine.Elements.remove($(this).attr("id"))})),0!=Engine.Game.lobbyToJoin?(Engine.history.pushState(),Engine.socket.emit("joinLobby",Engine.Game.lobbyToJoin,!0),Engine.Game.lobbyToJoin=0):Engine.Elements.append("menu_main")})),Engine.socket.on("waitingForPlayers",(function(e){switch(e){case 1:if(30==Engine.state)break;waitingForPlayers||Engine.Elements.append("waiting_for_players"),waitingForPlayers=!0;break;case 0:waitingForPlayers&&Engine.Elements.remove("waiting_for_players"),waitingForPlayers=!1}})),Engine.socket.on("inviteLobbyName",(function(e){$("#inviteLobbyName").html(e)})),Engine.socket.on("info",(function(e){Engine.Elements.remove("darken"),Engine.info(e)})),Engine.socket.on("console",(function(e){console.log(e)})),Engine.socket.on("lobbyOptions",(function(e){Engine.Elements.append("lobby_options",e)})),Engine.socket.on("pong",(function(e){e=parseInt(Date.now())-e,Engine.server.ping=e})),Engine.socket.on("lobbyList",(function(e){var t,i,n=e.length,s=$("#lobbyList").scrollTop();for(e.sort((function(e,t){var i=e.name.toLowerCase(),n=t.name.toLowerCase();return i<n?-1:i>n?1:0})),y=0,$("#lobbyList .inner").html(""),t=0;t<n;t++)i='<div class="lobby selectable selectV '+(0==(i=e[t]).members?"empty":"")+'" id="lobby_'+i.id+'"><span class="p40">'+i.name+'</span><span class="p40 '+(i.game?"tick":"cross")+'">'+(1===i.privacy?'<span class="locked"></span>':"")+(i.game?i.map:" Awaiting Game...")+'</span><span class="p20 tright">'+i.members+"/"+i.max+'</span><div class="clear"></div></div>',$("#lobbyList .inner").append(i);Engine.Elements.updateInputHandlers(),$(".lobby").on("click",(function(){var e=$(this).attr("id").split("_")[1];Engine.socket.emit("joinLobby",e)})),$("#lobbyList").scrollTop(s)})),Engine.socket.on("onlineCount",(function(e){h=e,$("#onlineCount").html(e)})),Engine.socket.on("gameStats",(function(e){var t,i,n=[];for(t=e.length;t--;){switch((i=e[t]).n+="",i.n=i.n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,"."),i.i){case"killed_npcs":i=i.n+" monsters have been slain";break;case"killed_players":i=i.n+" players have been defeated in battle";break;case"killed_bots":i=i.n+" bots ended up as cannon fodder";break;case"killed_treasures":i=i.n+" treasure chests have been smashed";break;case"looted_coins":i="Players have collected "+i.n+" coins";break;case"mistakes":i=i.n+" mistakes were made";break;default:i=!1}i&&n.push(i)}e=n.join("&nbsp;&nbsp;-&nbsp;&nbsp;"),e+="&nbsp;&nbsp;-&nbsp;&nbsp;",Engine.Game.gameStats=e,Engine.marquee.start($("#marquee"),e)})),Engine.socket.on("lobbyFail",(function(){$("#lobby_create").removeClass("active disabled"),Engine.Elements.remove("darken")})),Engine.socket.on("lobbyCreated",(function(){Engine.Elements.remove("darken")})),Engine.socket.on("joinLobby",(function(e){Engine.Elements.remove("darken"),S.length=0,$(".menu").each((function(){Engine.Elements.remove($(this).attr("id"))})),y=0,Engine.Elements.append("menu_lobby"),$("#lobby_header").html(e.name),e.game&&Engine.Elements.append("game_running_notice"),Engine.history.pushState({path:window.location.href+"#!/lobby/"+e.id+Engine.server.current.tag})})),Engine.socket.on("leaveLobby",(function(e){11!==Engine.state&&(Engine.state=11,Engine.Elements.elements.game.visible&&Engine.Elements.remove("game")),y=0,Engine.Elements.elements.menu_lobby.visible&&(Engine.Elements.remove("menu_lobby"),Engine.socket.emit("leaveLobby")),Engine.Elements.remove("game_running_notice"),Engine.Elements.append("menu_lobbies"),Engine.socket.emit("getLobbies"),Engine.history.pushState(),e&&Engine.info(e)})),Engine.socket.on("lobbyMembers",(function(e,t,i){d=i;var n,s,a,o={war:{desc:"Warrior",css:"class_war"},rog:{desc:"Rogue",css:"class_rog"},mag:{desc:"Mage",css:"class_mag"},war2:{desc:"Warrior",css:"class_war2"},rog2:{desc:"Rogue",css:"class_rog2"},mag2:{desc:"Mage",css:"class_mag2"}};for(n=0;n<t;n++)s=e[n],a="player"+(n+1),$("#"+a).removeClass("empty").removeClass("bot").removeClass("active").removeClass("host"),$("#"+a+" .arrows").hide(),$("#"+a).removeClass("class_war").removeClass("class_mag").removeClass("class_rog").removeClass("class_war2").removeClass("class_mag2").removeClass("class_rog2"),"player"===s.type&&($("#"+a).removeClass("empty"),$("#"+a+" .name").html(s.name),$("#"+a+" .desc").html(o[s.job].desc),$("#"+a).addClass(o[s.job].css),s.id===c&&$("#"+a+" .arrows").show(),s.id===i&&$("#"+a).addClass("host"),s.ready&&($("#"+a).addClass("active"),$("#"+a+" .arrows").hide())),"bot"===s.type&&($("#"+a).removeClass("empty").addClass("bot"),$("#"+a+" .name").html(s.name),$("#"+a+" .desc").html(o[s.job].desc),$("#"+a).addClass(o[s.job].css),c===i&&($("#"+a+" .arrows").show(),$("#"+a+" .button_kickbot").fadeIn(300)),s.ready&&($("#"+a).addClass("active"),$("#"+a+" .arrows").hide(),$("#"+a+" .button_kickbot").hide())),"empty"===s.type&&($("#"+a).addClass("empty"),c===i?$("#"+a+" .name").html("&lt;P"+(n+1)+'&gt;<div class="small">click to add CPU</div>'):$("#"+a+" .name").html('<div class="space">&lt;P'+(n+1)+"&gt;</div>"),$("#"+a+" .button_kickbot").fadeOut(300))})),Engine.socket.on("changeJob",(function(e){$(".cla").each((function(){$(this).removeClass("active"),$(this).attr("id").split("_")[1]==e&&$(this).addClass("active")}))})),Engine.socket.on("lobbyMap",(function(e){$(".map").each((function(){$(this).removeClass("active"),$(this).attr("id").split("_")[1]==e&&$(this).addClass("active")}))})),Engine.socket.on("lobbyName",(function(e){$("#lobby_header").html(e)})),Engine.socket.on("chat",(function(e){z(e)})),Engine.socket.on("lobbyTimerStart",(function(e){y=Engine.now+e})),Engine.socket.on("lobbyTimerStop",(function(){y=0})),Engine.socket.on("gameStart",(function(e){Engine.addLoading((function(){Engine.audio.play("cheer1"),u=Date.now(),$("#lobby_ready").addClass("disabled"),Engine.Elements.remove("game_running_notice"),Engine.Elements.append("darken");var t=e.map,n=e.options,a=e.player,o=e.objectlist,r=e.npclist,h=e.itemlist,c=e.music;l.length=0,S.length=0,i=null,t&&(s=new Engine.Map(t)),Y(n),V(a),H(o),R(r),B(h),Engine.audio.stop("menu"),x=c,Engine.state=40}))})),Engine.socket.on("gameLaunch",(function(e){Engine.addLoading((function(){U(e)}))})),Engine.socket.on("gameEnd",(function(e){D(e)})),Engine.socket.on("coinOwnage",(function(e){N(e)})),Engine.socket.on("update",(function(e){var t,i,s,o,r,l,h=e.length;for(t=0;t<h;t++){if(o=(i=e[t]).o,!1!==(s=q(i.id)))for(l in r=a[s].data,void 0!==o.status&&(a[s].resolveStatus(o.status,i.id===n.data.id,n.data.id),delete o.status),i.id===n.data.id&&(void 0!==o.x&&(a[s].compensate("x",o.x,o.ts),delete o.x),void 0!==o.y&&(a[s].compensate("y",o.y,o.ts),delete o.y),void 0!==o.mx&&delete o.mx,void 0!==o.my&&delete o.my,void 0!==o.block&&delete o.block,void 0!==o.power&&(n.lastSuper=Engine.now)),void 0!==o.hp&&(a[s].hpCut+=r.hp-o.hp,0>a[s].hpCut&&(a[s].hpCut=0)),o)r[l]=o[l];e.splice(t,1),t--,h--}})),Engine.socket.on("ws",(function(e){var t,i,n,s=e.length;for(t=0;t<s;t++)n=e[t],!1!==(i=q(n.id))&&((i=a[i].data).x=n.x,i.y=n.y)})),Engine.socket.on("objectlist",(function(e){H(e)})),Engine.socket.on("npclist",(function(e){R(e)})),Engine.socket.on("itemlist",(function(e){B(e)})),Engine.socket.on("itemSpawn",(function(e){(e=new Engine.FX.Item(e)).init(),a.push(e)})),Engine.socket.on("itemDespawn",(function(e){if(!1!==(e=q(e.id))){var t=new Engine.FX.Collect(a[e].data);t.init(),a.push(t),a[e].remove()}})),Engine.socket.on("map",(function(e){s=new Engine.Map(e)})),Engine.socket.on("changeMap",(function(){a.length=0,r.length=0})),Engine.socket.on("flush",(function(){a.length=0,r.length=0})),Engine.socket.on("newPlayer",(function(e){(e=new Engine.EntityPlayer(e)).init(),a.push(e)})),Engine.socket.on("newNpc",(function(e){(e=new Engine.Npc(e)).init(),a.push(e)})),Engine.socket.on("playerLeft",(function(e){!1!==(e=q(e.id))&&a[e].leave()})),Engine.socket.on("skillAvailable",(function(e){n.skillAvailable[e]=!0})),Engine.socket.on("options",(function(e){Y(e)})),Engine.socket.on("option",(function(e){g[e.opt]=e.val})),Engine.socket.on("player",(function(e){V(e)})),Engine.socket.on("death",(function(e){n.data.deaths=e.deaths,n.data.coins=e.coins})),Engine.socket.on("kill",(function(e){n.data.kills=e})),Engine.socket.on("flush",(function(){a.length=0,r.length=0}))};var N=function(e){e.players.sort((function(e,t){return t.coins-e.coins}))},D=function(e){2!==Engine.state?Engine.Elements.remove("game_running_notice"):e&&(Engine.audio.stop(x),Engine.webaudio&&(Engine.audio.buses.biquad.frequency.value=22050),Engine.audio.play("results"),$("#overlay").removeClass("hideCursor"),w=Engine.now,Engine.state=30,T=!1,e.sort((function(e,t){return t.coins==e.coins?t.acc-e.acc:t.coins-e.coins})),b=e)},H=function(e){var t,i,n=e.length;for(i=0;i<n;i++){if(void 0!==(t=e[i]).status){var s,o=t.status.length;for(s=0;s<o;s++)t.status[s].start=Engine.now}(t=new Engine.EntityPlayer(t)).init(),a.push(t)}},R=function(e){var t,i,n=e.length;for(i=0;i<n;i++){if(void 0!==(t=e[i]).status){var s,o=t.status.length;for(s=0;s<o;s++)t.status[s].start=Engine.now}(t=new Engine.Npc(t)).init(),a.push(t)}},B=function(e){var t,i,n=e.length;for(i=0;i<n;i++)t=e[i],(t=new Engine.FX.Item(t)).init(),a.push(t)},z=function(e){var t;t=11==Engine.state?"#chatLobbyOutput":"#chatOutput";var i='<div class="line" id="t'+Date.now()+'">';switch(e.type){case 0:$(t).append(i+'<span class="chat_sysinfo">'+e.msg+"</span></div>"),K(t),2==Engine.state&&((e=new Engine.FX.GameInfo(e.msg)).init(),l.push(e));break;case 1:Engine.branding&&!Engine.allowChat[Engine.branding]||(Engine.audio.play("msg"),t="#chatLobbyOutput",$(t).append(i+'<span class="username">'+e.name+'</span>: <span class="chat_say">'+e.msg+"</span></div>"),K(t),t="#chatOutput",$(t).append(i+'<span class="username">'+e.name+'</span>: <span class="chat_say">'+e.msg+"</span></div>"),K(t));break;case 3:$(t).append(i+'<span class="chat_exp">'+e.msg+"</span></div>"),K(t),2==Engine.state&&((e=new Engine.FX.GameInfo(e.msg)).init(),l.push(e));break;case 4:2==Engine.state&&((e=new Engine.FX.GameInfo(e.msg)).init(),l.push(e));break;case 5:$(t).append(i+'<span class="chat_exp">'+e.msg+"</span></div>"),K(t);break;case 6:$(t).append(i+'<span class="chat_sysinfo">'+e.msg+"</span></div>"),K(t)}2!=Engine.state&&20!=Engine.state||$(t+" .line:last-child").delay(12e3).fadeOut()},q=function(e){var t,i=a.length;for(t=0;t<i;t++)if(a[t].id===e)return t;return!1};this.getOnlineCount=function(){return h},this.layers={ground:0,ground2:1,objects:2,collision:3,collision2:4,overlay:5,items:6},this.addObject=function(e){a.push(e)},this.addObjectOverlay=function(e){r.push(e)},this.collision=function(e,t,i){return s.collision(e,t,i)};var U=function(e){oTimerHint=Engine.now;var t=$("#chatLobbyOutput").html();Engine.Elements.remove("menu_lobby"),Engine.Elements.remove("darken");var n=e.timerIntro;e=e.timerGame,0<n?(Engine.state=20,p=Engine.now+n):(i.vel=1,Engine.state=2),f=Engine.now+e,Engine.Elements.append("game"),$("#chatOutput").append(t),$("#chatOutput").scrollTop(9999),$("#chatOutput .line").each((function(){$(this).hide()})),z({msg:"Defeat enemies to get their coins!<br />The player with the most coins wins!",type:6}),$("html").focus(),Engine.audio.play(x),Engine.fps.capture=Engine.now};this.hasMusic=function(){return x||!1};var Y=function(e){for(var t in e)g[t]=e[t];Engine.Assets.bufferDayTime(e.dayTime),s.updateOptions(e),s.init()},V=function(e){(n=new Engine.Player(e)).init(),a.push(n),i||(i=new Engine.Camera(s)),i.init(n),n.camera=i.data},K=function(e){var t,i=$(e+" .line").length;if(40<i)for(i-=40,t=0;t<i;t++)$(e+" .line:eq("+t+")").remove();$(e).scrollTop(9999)}};